--- ===============================================================================
-- Author:		<Purna Pushkal>
-- Create date: <18-11-2016>
-- Description:	 pupulate the data to audit table
-- Jira ID:		<AL-8320>
-- ================================================================================
IF OBJECT_ID('tr_PopulateWUBillPayTransaction_Aud') IS NOT NULL
	 BEGIN
		  DROP TRIGGER dbo.tr_PopulateWUBillPayTransaction_Aud
	 END
GO

CREATE TRIGGER tr_PopulateWUBillPayTransaction_Aud ON dbo.tWUnion_BillPay_Trx
AFTER INSERT,UPDATE,DELETE
AS
BEGIN
SET NOCOUNT ON;
	 DECLARE @revisionNo BIGINT;
	 DECLARE @auditEvent SMALLINT;

	 IF((SELECT COUNT(1) FROM INSERTED) > 0 AND (SELECT COUNT(1) FROM DELETED) > 0)
		  BEGIN
				-- UPDATE
				SET @auditEvent = 2
		  END
	 ELSE
	 IF((SELECT COUNT(1) FROM INSERTED) > 0)
		  BEGIN
				-- INSERT
				SET @auditEvent = 1
		  END
	 ELSE
	 IF((SELECT COUNT(1) FROM DELETED) > 0)
		  BEGIN
				-- DELETE
				SET @auditEvent = 3
		  END

	IF @AuditEvent != 3
		BEGIN
		   SELECT 
			  @RevisionNo = ISNULL(MAX(RevisionNo), 0) + 1 
			FROM 
			  tWUnion_BillPay_Trx_Aud twa
			  INNER JOIN INSERTED i ON i.WUBillPayTrxId = twa.WUBillPayTrxId
		END
	ELSE
		BEGIN
		   SELECT 
			  @RevisionNo = ISNULL(MAX(RevisionNo), 0) + 1 
			FROM 
			  tWUnion_BillPay_Trx_Aud twa
			  INNER JOIN DELETED d ON d.WUBillPayTrxId = twa.WUBillPayTrxId
		END

	IF @AuditEvent != 3
		BEGIN
			 INSERT INTO dbo.tWUnion_BillPay_Trx_Aud
			 (WUBillPayTrxId,
			  WUBillPayAccountId,
			  DTServerCreate,
			  DTServerLastModified,
			  ProviderId,
			  Channel_Type,
			  Channel_Name,
			  Channel_Version,
			  Sender_FirstName,
			  Sender_Lastname,
			  Sender_AddressLine1,
			  Sender_City,
			  Sender_State,
			  Sender_PostalCode,
			  Sender_CountryCode,
			  Sender_CurrencyCode,
			  Sender_AddressLine2,
			  Sender_Street,
			  WesternUnionCardNumber,
			  LevelCode,
			  Sender_Email,
			  Sender_ContactPhone,
			  Sender_DateOfBirth,
			  BillerName,
			  Biller_CityCode,
			  Customer_AccountNumber,
			  CountryCode,
			  CurrencyCode,
			  Financials_MunicipalTax,
			  Financials_StateTax,
			  Financials_CountTax,
			  Financials_OriginatorsPrincipalAmount,
			  Financials_DestinationPrincipalAmount,
			  Financials_Fee,
			  Financials_GrossTotalAmount,
			  Financials_Total,
			  Financials_UndiscountedCharges,
			  Financials_DiscountedCharges,
			  PaymentDetails_Recording_CountryCode,
			  PaymentDetails_Recording_CountryCurrency,
			  PaymentDetails_Destination_CountryCode,
			  PaymentDetails_Destination_CountryCurrency,
			  PaymentDetails_Originating_CountryCode,
			  PaymentDetails_Originating_CountryCurrency,
			  PaymentDetails_Originating_City,
			  PaymentDetails_Originating_State,
			  PaymentDetails_TransactionType,
			  PaymentDetails_PaymentType,
			  PaymentDetails_ExchangeRate,
			  PaymentDetails_FixOnSend,
			  PaymentDetails_ReceiptOptOut,
			  PaymentDetails_AuthStatus,
			  FillingDate,
			  FillingTime,
			  MTCN,
			  NewMTCN,
			  DfFields_PDSRequiredFlag,
			  DfFields_TransactionFlag,
			  DfFields_DeliveryServiceName,
			  DeliveryCode,
			  FusionScreen,
			  ConvSessionCookie,
			  ForeignRemoteSystem_Identifier,
			  ForeignRemoteSystem_Reference_no,
			  ForeignRemoteSystem_CounterId,
			  InstantNotification_AddlServiceCharges,
			  InstantNotification_AddlServiceLength,
			  promotions_coupons_promotions,
			  promotions_promo_code_description,
			  promotions_promo_sequence_no,
			  promotions_promo_name,
			  promotions_promo_message,
			  promotions_promo_discount_amount,
			  promotions_promotion_error,
			  promotions_sender_promo_code,
			  Sender_ComplianceDetails_TemplateID,
			  Sender_ComplianceDetails_IdDetails_IdType,
			  Sender_ComplianceDetails_IdDetails_IdCountryOfIssue,
			  Sender_ComplianceDetails_IdDetails_IdPlaceOfIssue,
			  Sender_ComplianceDetails_IdDetails_IdNumber,
			  Sender_ComplianceDetails_SecondID_IdType,
			  Sender_ComplianceDetails_SecondID_IdCountryOfIssue,
			  Sender_ComplianceDetails_SecondID_IdNumber,
			  Sender_ComplianceDetails_DateOfBirth,
			  Sender_ComplianceDetails_Occupation,
			  Sender_ComplianceDetails_CurrentAddress_AddrLine1,
			  Sender_ComplianceDetails_CurrentAddress_AddrLine2,
			  Sender_ComplianceDetails_CurrentAddress_City,
			  Sender_ComplianceDetails_CurrentAddress_StateCode,
			  Sender_ComplianceDetails_CurrentAddress_PostalCode,
			  Sender_ComplianceDetails_ContactPhone,
			  Sender_ComplianceDetails_I_ActOnMyBehalf,
			  Sender_ComplianceDetails_Ack_Flag,
			  Sender_ComplianceDetails_ComplianceData_Buffer,
			  Financials_PlusChargesAmount,
			  Financials_TotalDiscount,
			  Request_XML,
			  Response_XML,
			  WUCard_TotalPointsEarned,
			  QPCompany_Department,
			  DTTerminalCreate,
			  DTTerminalLastModified,
			  MessageArea,
			  DTAudit,
			  AuditEvent,
			  RevisionNo
			 )
					  SELECT WUBillPayTrxId,
							WUBillPayAccountId,
							DTServerCreate,
							DTServerLastModified,
							ProviderId,
							Channel_Type,
							Channel_Name,
							Channel_Version,
							Sender_FirstName,
							Sender_Lastname,
							Sender_AddressLine1,
							Sender_City,
							Sender_State,
							Sender_PostalCode,
							Sender_CountryCode,
							Sender_CurrencyCode,
							Sender_AddressLine2,
							Sender_Street,
							WesternUnionCardNumber,
							LevelCode,
							Sender_Email,
							Sender_ContactPhone,
							Sender_DateOfBirth,
							BillerName,
							Biller_CityCode,
							Customer_AccountNumber,
							CountryCode,
							CurrencyCode,
							Financials_MunicipalTax,
							Financials_StateTax,
							Financials_CountTax,
							Financials_OriginatorsPrincipalAmount,
							Financials_DestinationPrincipalAmount,
							Financials_Fee,
							Financials_GrossTotalAmount,
							Financials_Total,
							Financials_UndiscountedCharges,
							Financials_DiscountedCharges,
							PaymentDetails_Recording_CountryCode,
							PaymentDetails_Recording_CountryCurrency,
							PaymentDetails_Destination_CountryCode,
							PaymentDetails_Destination_CountryCurrency,
							PaymentDetails_Originating_CountryCode,
							PaymentDetails_Originating_CountryCurrency,
							PaymentDetails_Originating_City,
							PaymentDetails_Originating_State,
							PaymentDetails_TransactionType,
							PaymentDetails_PaymentType,
							PaymentDetails_ExchangeRate,
							PaymentDetails_FixOnSend,
							PaymentDetails_ReceiptOptOut,
							PaymentDetails_AuthStatus,
							FillingDate,
							FillingTime,
							MTCN,
							NewMTCN,
							DfFields_PDSRequiredFlag,
							DfFields_TransactionFlag,
							DfFields_DeliveryServiceName,
							DeliveryCode,
							FusionScreen,
							ConvSessionCookie,
							ForeignRemoteSystem_Identifier,
							ForeignRemoteSystem_Reference_no,
							ForeignRemoteSystem_CounterId,
							InstantNotification_AddlServiceCharges,
							InstantNotification_AddlServiceLength,
							promotions_coupons_promotions,
							promotions_promo_code_description,
							promotions_promo_sequence_no,
							promotions_promo_name,
							promotions_promo_message,
							promotions_promo_discount_amount,
							promotions_promotion_error,
							promotions_sender_promo_code,
							Sender_ComplianceDetails_TemplateID,
							Sender_ComplianceDetails_IdDetails_IdType,
							Sender_ComplianceDetails_IdDetails_IdCountryOfIssue,
							Sender_ComplianceDetails_IdDetails_IdPlaceOfIssue,
							Sender_ComplianceDetails_IdDetails_IdNumber,
							Sender_ComplianceDetails_SecondID_IdType,
							Sender_ComplianceDetails_SecondID_IdCountryOfIssue,
							Sender_ComplianceDetails_SecondID_IdNumber,
							Sender_ComplianceDetails_DateOfBirth,
							Sender_ComplianceDetails_Occupation,
							Sender_ComplianceDetails_CurrentAddress_AddrLine1,
							Sender_ComplianceDetails_CurrentAddress_AddrLine2,
							Sender_ComplianceDetails_CurrentAddress_City,
							Sender_ComplianceDetails_CurrentAddress_StateCode,
							Sender_ComplianceDetails_CurrentAddress_PostalCode,
							Sender_ComplianceDetails_ContactPhone,
							Sender_ComplianceDetails_I_ActOnMyBehalf,
							Sender_ComplianceDetails_Ack_Flag,
							Sender_ComplianceDetails_ComplianceData_Buffer,
							Financials_PlusChargesAmount,
							Financials_TotalDiscount,
							Request_XML,
							Response_XML,
							WUCard_TotalPointsEarned,
							QPCompany_Department,
							DTTerminalCreate,
							DTTerminalLastModified,
							MessageArea,
							GETDATE(),
							@auditEvent,
							@revisionNo
					  FROM INSERTED
		END
	ELSE
		BEGIN
			 INSERT INTO dbo.tWUnion_BillPay_Trx_Aud
			 (WUBillPayTrxId,
			  WUBillPayAccountId,
			  DTServerCreate,
			  DTServerLastModified,
			  ProviderId,
			  Channel_Type,
			  Channel_Name,
			  Channel_Version,
			  Sender_FirstName,
			  Sender_Lastname,
			  Sender_AddressLine1,
			  Sender_City,
			  Sender_State,
			  Sender_PostalCode,
			  Sender_CountryCode,
			  Sender_CurrencyCode,
			  Sender_AddressLine2,
			  Sender_Street,
			  WesternUnionCardNumber,
			  LevelCode,
			  Sender_Email,
			  Sender_ContactPhone,
			  Sender_DateOfBirth,
			  BillerName,
			  Biller_CityCode,
			  Customer_AccountNumber,
			  CountryCode,
			  CurrencyCode,
			  Financials_MunicipalTax,
			  Financials_StateTax,
			  Financials_CountTax,
			  Financials_OriginatorsPrincipalAmount,
			  Financials_DestinationPrincipalAmount,
			  Financials_Fee,
			  Financials_GrossTotalAmount,
			  Financials_Total,
			  Financials_UndiscountedCharges,
			  Financials_DiscountedCharges,
			  PaymentDetails_Recording_CountryCode,
			  PaymentDetails_Recording_CountryCurrency,
			  PaymentDetails_Destination_CountryCode,
			  PaymentDetails_Destination_CountryCurrency,
			  PaymentDetails_Originating_CountryCode,
			  PaymentDetails_Originating_CountryCurrency,
			  PaymentDetails_Originating_City,
			  PaymentDetails_Originating_State,
			  PaymentDetails_TransactionType,
			  PaymentDetails_PaymentType,
			  PaymentDetails_ExchangeRate,
			  PaymentDetails_FixOnSend,
			  PaymentDetails_ReceiptOptOut,
			  PaymentDetails_AuthStatus,
			  FillingDate,
			  FillingTime,
			  MTCN,
			  NewMTCN,
			  DfFields_PDSRequiredFlag,
			  DfFields_TransactionFlag,
			  DfFields_DeliveryServiceName,
			  DeliveryCode,
			  FusionScreen,
			  ConvSessionCookie,
			  ForeignRemoteSystem_Identifier,
			  ForeignRemoteSystem_Reference_no,
			  ForeignRemoteSystem_CounterId,
			  InstantNotification_AddlServiceCharges,
			  InstantNotification_AddlServiceLength,
			  promotions_coupons_promotions,
			  promotions_promo_code_description,
			  promotions_promo_sequence_no,
			  promotions_promo_name,
			  promotions_promo_message,
			  promotions_promo_discount_amount,
			  promotions_promotion_error,
			  promotions_sender_promo_code,
			  Sender_ComplianceDetails_TemplateID,
			  Sender_ComplianceDetails_IdDetails_IdType,
			  Sender_ComplianceDetails_IdDetails_IdCountryOfIssue,
			  Sender_ComplianceDetails_IdDetails_IdPlaceOfIssue,
			  Sender_ComplianceDetails_IdDetails_IdNumber,
			  Sender_ComplianceDetails_SecondID_IdType,
			  Sender_ComplianceDetails_SecondID_IdCountryOfIssue,
			  Sender_ComplianceDetails_SecondID_IdNumber,
			  Sender_ComplianceDetails_DateOfBirth,
			  Sender_ComplianceDetails_Occupation,
			  Sender_ComplianceDetails_CurrentAddress_AddrLine1,
			  Sender_ComplianceDetails_CurrentAddress_AddrLine2,
			  Sender_ComplianceDetails_CurrentAddress_City,
			  Sender_ComplianceDetails_CurrentAddress_StateCode,
			  Sender_ComplianceDetails_CurrentAddress_PostalCode,
			  Sender_ComplianceDetails_ContactPhone,
			  Sender_ComplianceDetails_I_ActOnMyBehalf,
			  Sender_ComplianceDetails_Ack_Flag,
			  Sender_ComplianceDetails_ComplianceData_Buffer,
			  Financials_PlusChargesAmount,
			  Financials_TotalDiscount,
			  Request_XML,
			  Response_XML,
			  WUCard_TotalPointsEarned,
			  QPCompany_Department,
			  DTTerminalCreate,
			  DTTerminalLastModified,
			  MessageArea,
			  DTAudit,
			  AuditEvent,
			  RevisionNo
			 )
					  SELECT WUBillPayTrxId,
							WUBillPayAccountId,
							DTServerCreate,
							DTServerLastModified,
							ProviderId,
							Channel_Type,
							Channel_Name,
							Channel_Version,
							Sender_FirstName,
							Sender_Lastname,
							Sender_AddressLine1,
							Sender_City,
							Sender_State,
							Sender_PostalCode,
							Sender_CountryCode,
							Sender_CurrencyCode,
							Sender_AddressLine2,
							Sender_Street,
							WesternUnionCardNumber,
							LevelCode,
							Sender_Email,
							Sender_ContactPhone,
							Sender_DateOfBirth,
							BillerName,
							Biller_CityCode,
							Customer_AccountNumber,
							CountryCode,
							CurrencyCode,
							Financials_MunicipalTax,
							Financials_StateTax,
							Financials_CountTax,
							Financials_OriginatorsPrincipalAmount,
							Financials_DestinationPrincipalAmount,
							Financials_Fee,
							Financials_GrossTotalAmount,
							Financials_Total,
							Financials_UndiscountedCharges,
							Financials_DiscountedCharges,
							PaymentDetails_Recording_CountryCode,
							PaymentDetails_Recording_CountryCurrency,
							PaymentDetails_Destination_CountryCode,
							PaymentDetails_Destination_CountryCurrency,
							PaymentDetails_Originating_CountryCode,
							PaymentDetails_Originating_CountryCurrency,
							PaymentDetails_Originating_City,
							PaymentDetails_Originating_State,
							PaymentDetails_TransactionType,
							PaymentDetails_PaymentType,
							PaymentDetails_ExchangeRate,
							PaymentDetails_FixOnSend,
							PaymentDetails_ReceiptOptOut,
							PaymentDetails_AuthStatus,
							FillingDate,
							FillingTime,
							MTCN,
							NewMTCN,
							DfFields_PDSRequiredFlag,
							DfFields_TransactionFlag,
							DfFields_DeliveryServiceName,
							DeliveryCode,
							FusionScreen,
							ConvSessionCookie,
							ForeignRemoteSystem_Identifier,
							ForeignRemoteSystem_Reference_no,
							ForeignRemoteSystem_CounterId,
							InstantNotification_AddlServiceCharges,
							InstantNotification_AddlServiceLength,
							promotions_coupons_promotions,
							promotions_promo_code_description,
							promotions_promo_sequence_no,
							promotions_promo_name,
							promotions_promo_message,
							promotions_promo_discount_amount,
							promotions_promotion_error,
							promotions_sender_promo_code,
							Sender_ComplianceDetails_TemplateID,
							Sender_ComplianceDetails_IdDetails_IdType,
							Sender_ComplianceDetails_IdDetails_IdCountryOfIssue,
							Sender_ComplianceDetails_IdDetails_IdPlaceOfIssue,
							Sender_ComplianceDetails_IdDetails_IdNumber,
							Sender_ComplianceDetails_SecondID_IdType,
							Sender_ComplianceDetails_SecondID_IdCountryOfIssue,
							Sender_ComplianceDetails_SecondID_IdNumber,
							Sender_ComplianceDetails_DateOfBirth,
							Sender_ComplianceDetails_Occupation,
							Sender_ComplianceDetails_CurrentAddress_AddrLine1,
							Sender_ComplianceDetails_CurrentAddress_AddrLine2,
							Sender_ComplianceDetails_CurrentAddress_City,
							Sender_ComplianceDetails_CurrentAddress_StateCode,
							Sender_ComplianceDetails_CurrentAddress_PostalCode,
							Sender_ComplianceDetails_ContactPhone,
							Sender_ComplianceDetails_I_ActOnMyBehalf,
							Sender_ComplianceDetails_Ack_Flag,
							Sender_ComplianceDetails_ComplianceData_Buffer,
							Financials_PlusChargesAmount,
							Financials_TotalDiscount,
							Request_XML,
							Response_XML,
							WUCard_TotalPointsEarned,
							QPCompany_Department,
							DTTerminalCreate,
							DTTerminalLastModified,
							MessageArea,
							GETDATE(),
							@auditEvent,
							@revisionNo
					  FROM DELETED
		END
END
