-- ============================================================
-- Author:		<Pamila Jose>
-- Create date: <09/29/2014>
-- Description:	<Create Trigger for MoneyGram Billpay Transaction Table> 
-- Rally ID:	<US2046>
-- ============================================================
IF  EXISTS (SELECT * FROM sys.triggers WHERE object_id = OBJECT_ID(N'[dbo].[trgMGram_Billpay_TrxAud]'))
DROP TRIGGER [dbo].[trgMGram_Billpay_TrxAud]
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE TRIGGER [dbo].[trgMGram_Billpay_TrxAud] 
ON [dbo].[tMGram_Billpay_Trx] 
AFTER INSERT, UPDATE, DELETE
AS
	SET NOCOUNT ON
	
	DECLARE @RevisionNo BIGINT

	SELECT 
		@RevisionNo = ISNULL(MAX(RevisionNo),0) + 1 
	FROM 
		[tMGram_Transfer_Trx_Aud] 
	WHERE 
		Id = (SELECT Id FROM inserted)
             
	IF ((SELECT COUNT(*) FROM inserted)<>0 AND (SELECT COUNT(*) FROM deleted)>0)
	BEGIN
		INSERT INTO [dbo].[tMGram_BillPay_Trx_Aud]
           ([rowguid]
           ,[Id]
           ,[AgentID]
           ,[AgentSequence]
           ,[Token]
           ,[ApiVersion]
           ,[ClientSoftwareVersion]
           ,[RequestResponseType]
           ,[ProductVariant]
           ,[ReceiveCountry]
           ,[ReceiveCode]
           ,[ReceiveAgentID]
           ,[ReceiveCurrency]
           ,[SendCurrency]
           ,[PromoCodeValuesPromoCode]
           ,[DoCheckIn]
           ,[TimeStamp]
           ,[Flags]
           ,[ValidReceiveAmount]
           ,[ValidReceiveCurrency]
           ,[ValidExchangeRate]
           ,[TotalAmount]
           ,[ReceiveAmountAltered]
           ,[RevisedInformationalFee]
           ,[DeliveryOptId]
           ,[DeliveryOptDisplayName]
           ,[ReceiveAgentName]
           ,[MgiTransactionSessionID]
           ,[SendAmountAltered]
           ,[SendAmount]
           ,[TotalSendFees]
           ,[TotalDiscountAmount]
           ,[TotalSendTaxes]
           ,[TotalAmountToCollect]
           ,[ReceiveAmount]
           ,[ValidCurrencyIndicator]
           ,[PayoutCurrency]
           ,[TotalReceiveFees]
           ,[TotalReceiveTaxes]
           ,[TotalReceiveAmount]
           ,[ReceiveFeesAreEstimated]
           ,[ReceiveTaxesAreEstimated]
           ,[DTCreate]
           ,[DTLastMod]
           ,[DTServerCreate]
           ,[DTServerLastMod]
           ,[AccountPK]
           ,[AccountNumberRetryCount]
           ,[SenderFirstName]
           ,[SenderLastName]
           ,[SenderAddress]
           ,[SenderCity]
           ,[SenderState]
           ,[SenderZipCode]
           ,[SenderCountry]
           ,[SenderHomePhone]
           ,[ReceiverFirstName]
           ,[ReceiverLastName]
           ,[ServiceOfferingID]
           ,[BillerWebsite]
           ,[BillerPhone]
           ,[BillerCutoffTime]
           ,[BillerAddress]
           ,[BillerAddress2]
           ,[BillerAddress3]
           ,[BillerCity]
           ,[BillerState]
           ,[BillerZip]
           ,[PrintMGICustomerServiceNumber]
           ,[AgentTransactionId]
           ,[ReadyForCommit]
           ,[ProcessingFee]
           ,[InfoFeeIndicator]
           ,[ExchangeRateApplied]
           ,[ReferenceNumber]
           ,[PartnerConfirmationNumber]
           ,[PartnerName]
           ,[FreePhoneCallPin]
           ,[TollFreePhoneNumber]
           ,[ExpectedDateOfDelivery]
           ,[TransactionDateTime]
           ,[AccountNumber]
           ,[SenderMiddleName]
           ,[SenderLastName2]
           ,[MessageField1]
           ,[MessageField2]
           ,[SenderDOB]
           ,[SenderOccupation]
           ,[SenderLegalIdNumber]
           ,[SenderLegalIdType]
           ,[SenderPhotoIdCountry]
           ,[SenderPhotoIdState]
           ,[SenderPhotoIdNumber]
           ,[SenderPhotoIdType]
           ,[BillerName]
           ,[TextTranslation]
           ,[ReceiverMiddleName]
           ,[ReceiverLastName2]
           ,[PurposeOfFund]
           ,[TotalSendAmount]
           ,[MgiRewardsNumber]
           ,[ValidateAccountNumber]
           ,[CardExpirationMonth]
           ,[CardExpirationYear]
           ,[AuditEvent]
           ,[DTAudit]
			,[RevisionNo]
			,[IsValidateAccNumberRequired])
		SELECT
			[rowguid]
           ,[Id]
           ,[AgentID]
           ,[AgentSequence]
           ,[Token]
           ,[ApiVersion]
           ,[ClientSoftwareVersion]
           ,[RequestResponseType]
           ,[ProductVariant]
           ,[ReceiveCountry]
           ,[ReceiveCode]
           ,[ReceiveAgentID]
           ,[ReceiveCurrency]
           ,[SendCurrency]
           ,[PromoCodeValuesPromoCode]
           ,[DoCheckIn]
           ,[TimeStamp]
           ,[Flags]
           ,[ValidReceiveAmount]
           ,[ValidReceiveCurrency]
           ,[ValidExchangeRate]
           ,[TotalAmount]
           ,[ReceiveAmountAltered]
           ,[RevisedInformationalFee]
           ,[DeliveryOptId]
           ,[DeliveryOptDisplayName]
           ,[ReceiveAgentName]
           ,[MgiTransactionSessionID]
           ,[SendAmountAltered]
           ,[SendAmount]
           ,[TotalSendFees]
           ,[TotalDiscountAmount]
           ,[TotalSendTaxes]
           ,[TotalAmountToCollect]
           ,[ReceiveAmount]
           ,[ValidCurrencyIndicator]
           ,[PayoutCurrency]
           ,[TotalReceiveFees]
           ,[TotalReceiveTaxes]
           ,[TotalReceiveAmount]
           ,[ReceiveFeesAreEstimated]
           ,[ReceiveTaxesAreEstimated]
           ,[DTCreate]
           ,[DTLastMod]
           ,[DTServerCreate]
           ,[DTServerLastMod]
           ,[AccountPK]
           ,[AccountNumberRetryCount]
           ,[SenderFirstName]
           ,[SenderLastName]
           ,[SenderAddress]
           ,[SenderCity]
           ,[SenderState]
           ,[SenderZipCode]
           ,[SenderCountry]
           ,[SenderHomePhone]
           ,[ReceiverFirstName]
           ,[ReceiverLastName]
           ,[ServiceOfferingID]
           ,[BillerWebsite]
           ,[BillerPhone]
           ,[BillerCutoffTime]
           ,[BillerAddress]
           ,[BillerAddress2]
           ,[BillerAddress3]
           ,[BillerCity]
           ,[BillerState]
           ,[BillerZip]
           ,[PrintMGICustomerServiceNumber]
           ,[AgentTransactionId]
           ,[ReadyForCommit]
           ,[ProcessingFee]
           ,[InfoFeeIndicator]
           ,[ExchangeRateApplied]
           ,[ReferenceNumber]
           ,[PartnerConfirmationNumber]
           ,[PartnerName]
           ,[FreePhoneCallPin]
           ,[TollFreePhoneNumber]
           ,[ExpectedDateOfDelivery]
           ,[TransactionDateTime]
           ,[AccountNumber]
           ,[SenderMiddleName]
           ,[SenderLastName2]
           ,[MessageField1]
           ,[MessageField2]
           ,[SenderDOB]
           ,[SenderOccupation]
           ,[SenderLegalIdNumber]
           ,[SenderLegalIdType]
           ,[SenderPhotoIdCountry]
           ,[SenderPhotoIdState]
           ,[SenderPhotoIdNumber]
           ,[SenderPhotoIdType]
           ,[BillerName]
           ,[TextTranslation]
           ,[ReceiverMiddleName]
           ,[ReceiverLastName2]
           ,[PurposeOfFund]
           ,[TotalSendAmount]
           ,[MgiRewardsNumber]
           ,[ValidateAccountNumber]
           ,[CardExpirationMonth]
           ,[CardExpirationYear]	
		   , 2 AS AuditEvent
		   , GETDATE()
		   , @RevisionNo
		   ,[IsValidateAccNumberRequired]
		FROM 
			inserted
	END       
	ELSE IF(SELECT COUNT(*) FROM inserted)>0 AND (SELECT COUNT(*) FROM deleted)=0
	BEGIN
		INSERT INTO [dbo].[tMGram_BillPay_Trx_Aud]
           ([rowguid]
           ,[Id]
           ,[AgentID]
           ,[AgentSequence]
           ,[Token]
           ,[ApiVersion]
           ,[ClientSoftwareVersion]
           ,[RequestResponseType]
           ,[ProductVariant]
           ,[ReceiveCountry]
           ,[ReceiveCode]
           ,[ReceiveAgentID]
           ,[ReceiveCurrency]
           ,[SendCurrency]
           ,[PromoCodeValuesPromoCode]
           ,[DoCheckIn]
           ,[TimeStamp]
           ,[Flags]
           ,[ValidReceiveAmount]
           ,[ValidReceiveCurrency]
           ,[ValidExchangeRate]
           ,[TotalAmount]
           ,[ReceiveAmountAltered]
           ,[RevisedInformationalFee]
           ,[DeliveryOptId]
           ,[DeliveryOptDisplayName]
           ,[ReceiveAgentName]
           ,[MgiTransactionSessionID]
           ,[SendAmountAltered]
           ,[SendAmount]
           ,[TotalSendFees]
           ,[TotalDiscountAmount]
           ,[TotalSendTaxes]
           ,[TotalAmountToCollect]
           ,[ReceiveAmount]
           ,[ValidCurrencyIndicator]
           ,[PayoutCurrency]
           ,[TotalReceiveFees]
           ,[TotalReceiveTaxes]
           ,[TotalReceiveAmount]
           ,[ReceiveFeesAreEstimated]
           ,[ReceiveTaxesAreEstimated]
           ,[DTCreate]
           ,[DTLastMod]
           ,[DTServerCreate]
           ,[DTServerLastMod]
           ,[AccountPK]
           ,[AccountNumberRetryCount]
           ,[SenderFirstName]
           ,[SenderLastName]
           ,[SenderAddress]
           ,[SenderCity]
           ,[SenderState]
           ,[SenderZipCode]
           ,[SenderCountry]
           ,[SenderHomePhone]
           ,[ReceiverFirstName]
           ,[ReceiverLastName]
           ,[ServiceOfferingID]
           ,[BillerWebsite]
           ,[BillerPhone]
           ,[BillerCutoffTime]
           ,[BillerAddress]
           ,[BillerAddress2]
           ,[BillerAddress3]
           ,[BillerCity]
           ,[BillerState]
           ,[BillerZip]
           ,[PrintMGICustomerServiceNumber]
           ,[AgentTransactionId]
           ,[ReadyForCommit]
           ,[ProcessingFee]
           ,[InfoFeeIndicator]
           ,[ExchangeRateApplied]
           ,[ReferenceNumber]
           ,[PartnerConfirmationNumber]
           ,[PartnerName]
           ,[FreePhoneCallPin]
           ,[TollFreePhoneNumber]
           ,[ExpectedDateOfDelivery]
           ,[TransactionDateTime]
           ,[AccountNumber]
           ,[SenderMiddleName]
           ,[SenderLastName2]
           ,[MessageField1]
           ,[MessageField2]
           ,[SenderDOB]
           ,[SenderOccupation]
           ,[SenderLegalIdNumber]
           ,[SenderLegalIdType]
           ,[SenderPhotoIdCountry]
           ,[SenderPhotoIdState]
           ,[SenderPhotoIdNumber]
           ,[SenderPhotoIdType]
           ,[BillerName]
           ,[TextTranslation]
           ,[ReceiverMiddleName]
           ,[ReceiverLastName2]
           ,[PurposeOfFund]
           ,[TotalSendAmount]
           ,[MgiRewardsNumber]
           ,[ValidateAccountNumber]
           ,[CardExpirationMonth]
           ,[CardExpirationYear]
           ,[AuditEvent]
           ,[DTAudit]
			,[RevisionNo]
			,[IsValidateAccNumberRequired])
		SELECT
			[rowguid]
           ,[Id]
           ,[AgentID]
           ,[AgentSequence]
           ,[Token]
           ,[ApiVersion]
           ,[ClientSoftwareVersion]
           ,[RequestResponseType]
           ,[ProductVariant]
           ,[ReceiveCountry]
           ,[ReceiveCode]
           ,[ReceiveAgentID]
           ,[ReceiveCurrency]
           ,[SendCurrency]
           ,[PromoCodeValuesPromoCode]
           ,[DoCheckIn]
           ,[TimeStamp]
           ,[Flags]
           ,[ValidReceiveAmount]
           ,[ValidReceiveCurrency]
           ,[ValidExchangeRate]
           ,[TotalAmount]
           ,[ReceiveAmountAltered]
           ,[RevisedInformationalFee]
           ,[DeliveryOptId]
           ,[DeliveryOptDisplayName]
           ,[ReceiveAgentName]
           ,[MgiTransactionSessionID]
           ,[SendAmountAltered]
           ,[SendAmount]
           ,[TotalSendFees]
           ,[TotalDiscountAmount]
           ,[TotalSendTaxes]
           ,[TotalAmountToCollect]
           ,[ReceiveAmount]
           ,[ValidCurrencyIndicator]
           ,[PayoutCurrency]
           ,[TotalReceiveFees]
           ,[TotalReceiveTaxes]
           ,[TotalReceiveAmount]
           ,[ReceiveFeesAreEstimated]
           ,[ReceiveTaxesAreEstimated]
           ,[DTCreate]
           ,[DTLastMod]
           ,[DTServerCreate]
           ,[DTServerLastMod]
           ,[AccountPK]
           ,[AccountNumberRetryCount]
           ,[SenderFirstName]
           ,[SenderLastName]
           ,[SenderAddress]
           ,[SenderCity]
           ,[SenderState]
           ,[SenderZipCode]
           ,[SenderCountry]
           ,[SenderHomePhone]
           ,[ReceiverFirstName]
           ,[ReceiverLastName]
           ,[ServiceOfferingID]
           ,[BillerWebsite]
           ,[BillerPhone]
           ,[BillerCutoffTime]
           ,[BillerAddress]
           ,[BillerAddress2]
           ,[BillerAddress3]
           ,[BillerCity]
           ,[BillerState]
           ,[BillerZip]
           ,[PrintMGICustomerServiceNumber]
           ,[AgentTransactionId]
           ,[ReadyForCommit]
           ,[ProcessingFee]
           ,[InfoFeeIndicator]
           ,[ExchangeRateApplied]
           ,[ReferenceNumber]
           ,[PartnerConfirmationNumber]
           ,[PartnerName]
           ,[FreePhoneCallPin]
           ,[TollFreePhoneNumber]
           ,[ExpectedDateOfDelivery]
           ,[TransactionDateTime]
           ,[AccountNumber]
           ,[SenderMiddleName]
           ,[SenderLastName2]
           ,[MessageField1]
           ,[MessageField2]
           ,[SenderDOB]
           ,[SenderOccupation]
           ,[SenderLegalIdNumber]
           ,[SenderLegalIdType]
           ,[SenderPhotoIdCountry]
           ,[SenderPhotoIdState]
           ,[SenderPhotoIdNumber]
           ,[SenderPhotoIdType]
           ,[BillerName]
           ,[TextTranslation]
           ,[ReceiverMiddleName]
           ,[ReceiverLastName2]
           ,[PurposeOfFund]
           ,[TotalSendAmount]
           ,[MgiRewardsNumber]
           ,[ValidateAccountNumber]
           ,[CardExpirationMonth]
           ,[CardExpirationYear]
		   , 1 AS AuditEvent
		   , GETDATE()
		   , @RevisionNo
		   ,[IsValidateAccNumberRequired] 
		FROM 
			inserted
	END
	ELSE IF(SELECT COUNT(*) FROM DELETED)>0
	BEGIN
		INSERT INTO [dbo].[tMGram_BillPay_Trx_Aud]
           ([rowguid]
           ,[Id]
           ,[AgentID]
           ,[AgentSequence]
           ,[Token]
           ,[ApiVersion]
           ,[ClientSoftwareVersion]
           ,[RequestResponseType]
           ,[ProductVariant]
           ,[ReceiveCountry]
           ,[ReceiveCode]
           ,[ReceiveAgentID]
           ,[ReceiveCurrency]
           ,[SendCurrency]
           ,[PromoCodeValuesPromoCode]
           ,[DoCheckIn]
           ,[TimeStamp]
           ,[Flags]
           ,[ValidReceiveAmount]
           ,[ValidReceiveCurrency]
           ,[ValidExchangeRate]
           ,[TotalAmount]
           ,[ReceiveAmountAltered]
           ,[RevisedInformationalFee]
           ,[DeliveryOptId]
           ,[DeliveryOptDisplayName]
           ,[ReceiveAgentName]
           ,[MgiTransactionSessionID]
           ,[SendAmountAltered]
           ,[SendAmount]
           ,[TotalSendFees]
           ,[TotalDiscountAmount]
           ,[TotalSendTaxes]
           ,[TotalAmountToCollect]
           ,[ReceiveAmount]
           ,[ValidCurrencyIndicator]
           ,[PayoutCurrency]
           ,[TotalReceiveFees]
           ,[TotalReceiveTaxes]
           ,[TotalReceiveAmount]
           ,[ReceiveFeesAreEstimated]
           ,[ReceiveTaxesAreEstimated]
           ,[DTCreate]
           ,[DTLastMod]
           ,[DTServerCreate]
           ,[DTServerLastMod]
           ,[AccountPK]
           ,[AccountNumberRetryCount]
           ,[SenderFirstName]
           ,[SenderLastName]
           ,[SenderAddress]
           ,[SenderCity]
           ,[SenderState]
           ,[SenderZipCode]
           ,[SenderCountry]
           ,[SenderHomePhone]
           ,[ReceiverFirstName]
           ,[ReceiverLastName]
           ,[ServiceOfferingID]
           ,[BillerWebsite]
           ,[BillerPhone]
           ,[BillerCutoffTime]
           ,[BillerAddress]
           ,[BillerAddress2]
           ,[BillerAddress3]
           ,[BillerCity]
           ,[BillerState]
           ,[BillerZip]
           ,[PrintMGICustomerServiceNumber]
           ,[AgentTransactionId]
           ,[ReadyForCommit]
           ,[ProcessingFee]
           ,[InfoFeeIndicator]
           ,[ExchangeRateApplied]
           ,[ReferenceNumber]
           ,[PartnerConfirmationNumber]
           ,[PartnerName]
           ,[FreePhoneCallPin]
           ,[TollFreePhoneNumber]
           ,[ExpectedDateOfDelivery]
           ,[TransactionDateTime]
           ,[AccountNumber]
           ,[SenderMiddleName]
           ,[SenderLastName2]
           ,[MessageField1]
           ,[MessageField2]
           ,[SenderDOB]
           ,[SenderOccupation]
           ,[SenderLegalIdNumber]
           ,[SenderLegalIdType]
           ,[SenderPhotoIdCountry]
           ,[SenderPhotoIdState]
           ,[SenderPhotoIdNumber]
           ,[SenderPhotoIdType]
           ,[BillerName]
           ,[TextTranslation]
           ,[ReceiverMiddleName]
           ,[ReceiverLastName2]
           ,[PurposeOfFund]
           ,[TotalSendAmount]
           ,[MgiRewardsNumber]
           ,[ValidateAccountNumber]
           ,[CardExpirationMonth]
           ,[CardExpirationYear]
           ,[AuditEvent]
           ,[DTAudit]
			,[RevisionNo]
			,[IsValidateAccNumberRequired])
		SELECT
			[rowguid]
           ,[Id]
           ,[AgentID]
           ,[AgentSequence]
           ,[Token]
           ,[ApiVersion]
           ,[ClientSoftwareVersion]
           ,[RequestResponseType]
           ,[ProductVariant]
           ,[ReceiveCountry]
           ,[ReceiveCode]
           ,[ReceiveAgentID]
           ,[ReceiveCurrency]
           ,[SendCurrency]
           ,[PromoCodeValuesPromoCode]
           ,[DoCheckIn]
           ,[TimeStamp]
           ,[Flags]
           ,[ValidReceiveAmount]
           ,[ValidReceiveCurrency]
           ,[ValidExchangeRate]
           ,[TotalAmount]
           ,[ReceiveAmountAltered]
           ,[RevisedInformationalFee]
           ,[DeliveryOptId]
           ,[DeliveryOptDisplayName]
           ,[ReceiveAgentName]
           ,[MgiTransactionSessionID]
           ,[SendAmountAltered]
           ,[SendAmount]
           ,[TotalSendFees]
           ,[TotalDiscountAmount]
           ,[TotalSendTaxes]
           ,[TotalAmountToCollect]
           ,[ReceiveAmount]
           ,[ValidCurrencyIndicator]
           ,[PayoutCurrency]
           ,[TotalReceiveFees]
           ,[TotalReceiveTaxes]
           ,[TotalReceiveAmount]
           ,[ReceiveFeesAreEstimated]
           ,[ReceiveTaxesAreEstimated]
           ,[DTCreate]
           ,[DTLastMod]
           ,[DTServerCreate]
           ,[DTServerLastMod]
           ,[AccountPK]
           ,[AccountNumberRetryCount]
           ,[SenderFirstName]
           ,[SenderLastName]
           ,[SenderAddress]
           ,[SenderCity]
           ,[SenderState]
           ,[SenderZipCode]
           ,[SenderCountry]
           ,[SenderHomePhone]
           ,[ReceiverFirstName]
           ,[ReceiverLastName]
           ,[ServiceOfferingID]
           ,[BillerWebsite]
           ,[BillerPhone]
           ,[BillerCutoffTime]
           ,[BillerAddress]
           ,[BillerAddress2]
           ,[BillerAddress3]
           ,[BillerCity]
           ,[BillerState]
           ,[BillerZip]
           ,[PrintMGICustomerServiceNumber]
           ,[AgentTransactionId]
           ,[ReadyForCommit]
           ,[ProcessingFee]
           ,[InfoFeeIndicator]
           ,[ExchangeRateApplied]
           ,[ReferenceNumber]
           ,[PartnerConfirmationNumber]
           ,[PartnerName]
           ,[FreePhoneCallPin]
           ,[TollFreePhoneNumber]
           ,[ExpectedDateOfDelivery]
           ,[TransactionDateTime]
           ,[AccountNumber]
           ,[SenderMiddleName]
           ,[SenderLastName2]
           ,[MessageField1]
           ,[MessageField2]
           ,[SenderDOB]
           ,[SenderOccupation]
           ,[SenderLegalIdNumber]
           ,[SenderLegalIdType]
           ,[SenderPhotoIdCountry]
           ,[SenderPhotoIdState]
           ,[SenderPhotoIdNumber]
           ,[SenderPhotoIdType]
           ,[BillerName]
           ,[TextTranslation]
           ,[ReceiverMiddleName]
           ,[ReceiverLastName2]
           ,[PurposeOfFund]
           ,[TotalSendAmount]
           ,[MgiRewardsNumber]
           ,[ValidateAccountNumber]
           ,[CardExpirationMonth]
           ,[CardExpirationYear]
		   , 3 AS AuditEvent
		   , GETDATE()
		   , @RevisionNo
		   ,[IsValidateAccNumberRequired] 
		FROM 
		   deleted
    END
GO