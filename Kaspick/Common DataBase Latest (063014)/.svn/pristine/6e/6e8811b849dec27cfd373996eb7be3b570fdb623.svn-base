IF EXISTS (SELECT *
           FROM   sysobjects 
           WHERE  type = 'P'
                  AND name = 'USP_EX_InsPolicyitemReportingCascade')
    BEGIN
        DROP PROCEDURE USP_EX_InsPolicyitemReportingCascade;
        PRINT 'DROPPED USP_EX_InsPolicyitemReportingCascade';
    END
GO
/******************************************************************************                      
** NAME : USP_EX_InsPolicyitemReportingCascade
** Old NAME:     USP_EIS_EX_POLICYITEM_REPORTING_CASCADE_InsProc                       
** SHORT DESC: TO INSERT THE POLICYITEM TABLE FOR A PARTICULAR DIMENSION.                
**                      
** FULL DESCRIPTION: TO INSERT THE POLICYITEM TABLE FOR A PARTICULAR DIMENSION.                
**                              
** @POLICYDIMENSIONID : FOR WHICH RECORD HAS TO BE ADDED IN POLICYITEM.                
   @ENTITY_TYPE   : FOR WHICH LEVEL HAS TO BE ADDED IN POLICYITEM.               
   @ENTITY_ID   : FOR WHICH OWNER HAS TO BE ADDED IN POLICYITEM.                
   @USERID    : USER WHO IS UPDATING/INSERTING/DELETING THE POLICY.          
              
** SAMPLE CALL                      
   Exec USP_EIS_EX_POLICYITEM_REPORTING_CASCADE_InsProc  
   @POLICYDIMENTISON =   ,  
   @ENTITY_TYPE  =  ,  
   @ENTITY_ID   =  ,  
   @USERID    =    
                     
** RETURN VALUES: NONE                      
**                      
**                      
** STANDARD DECLARATIONS                      
**       SET LOCK_TIMEOUT         30000   -- 30 SECONDS                      
                  
** CREATED BY: VSHIVHARE                      
** COMPANY   : KASPICK & COMPANY                      
** PROJECT   : EXCELSIOR                      
** CREATED DT: JULY 12 2007    
**                                  
*******************************************************************************                
**       CHANGE HISTORY                      
*******************************************************************************                
** DATE:  AUTHOR:    BUG #  DESCRIPTION:                           RVWD                
   <MM/DD/YYYY>   
** --------  --------   ------  -------------------------------------- --------     
** 06/17/2009 Saravanan P Muthu KCBR  PIF Policies cascading only PIF Account Type   
   08/11/2009 Saravanan P Muthu CR #4  KCBP - Quickbase CR #4 - Bene Report performance inception date change request (Move the field to the Reporting tab on the Beneficiary Report page)      
** 12/04/2014 Yugandhar		EXCREQ 6.1
 *******************************************************************************                      
** COPYRIGHT (C) <COPYRIGHTYEAR,,YEAR> KASPICK & COMPANY, ALL RIGHTS RESERVED                      
** COMPANY CONFIDENTIAL -- NOT FOR DISTRIBUTION                      
*******************************************************************************/                      
CREATE PROCEDURE USP_EX_InsPolicyitemReportingCascade   
(    
  @POLICYDIMENTISON VARCHAR(100),    
  @ENTITY_TYPE VARCHAR(100),    
  @ENTITY_ID VARCHAR(14),    
  @USERID INT     
)    
AS    
BEGIN     
 DECLARE     
 @MAX_POLICY_LEVEL INT,    
 @POLICYDIMENSIONID INT,    
 @DATA_TYPE VARCHAR(20),    
 @C_VAL_DATE DATETIME,    
 @C_VAL_LIST INT,    
 @C_VAL_LOGICAL BIT,    
 @C_VAL_NUMERIC FLOAT,    
 @C_VAL_TEXT VARCHAR(100)  
 --TEMP TABLE FOR PROGRAM ACCOUNTS    
 DECLARE @TMP_C_ACT TABLE(ACCOUNTID VARCHAR(14))    
 DECLARE @POLICYITEM TABLE(  
  POLICYITEMID INT IDENTITY (1,1),   
  POLICYDIMENSIONID INT,   
  POLICYLEVEL INT,   
  OWNERID VARCHAR(14),   
  NUMERICVALUE FLOAT,   
  TEXTVALUE VARCHAR(100),   
  LOGICALVALUE BIT,   
  DATEVALUE DATETIME,   
  POLICYDROPDOWNID INT,   
  COMMENT VARCHAR(255),
  CreatedDate DATETIME,
  CreatedUserId INT)  
 DECLARE @MAX_POLICYITEM_ID INT  
  
 SELECT @MAX_POLICY_LEVEL = MAXPOLICYLEVEL, @DATA_TYPE=DATATYPE ,@POLICYDIMENSIONID=POLICYDIMENSIONID     
 FROM TBL_PolicyDimension WHERE FULLNAME =@POLICYDIMENTISON    
 --FETCH CURRENT CLIETN LEVEL VALUE     
 IF(@ENTITY_TYPE='MANAGER' AND @MAX_POLICY_LEVEL>200)    
 BEGIN    
  --FIRST SELECT ALL THE CURRENT VALUE STORED IN POLICYITEM FOR THIS CLIENT FOR THIS POLICYDIMENSION   
  SELECT     
   @C_VAL_DATE=DATEVALUE,    
   @C_VAL_LIST= POLICYDROPDOWNID,    
   @C_VAL_LOGICAL =LOGICALVALUE,    
   @C_VAL_NUMERIC =NUMERICVALUE,    
   @C_VAL_TEXT=TEXTVALUE     
  FROM TBL_PolicyItem   
  WHERE OWNERID=@ENTITY_ID   
  AND POLICYDIMENSIONID=@POLICYDIMENSIONID AND POLICYLEVEL=100     
 
 
 IF @POLICYDIMENSIONID IN (206,264,265)  
  BEGIN  
   INSERT INTO @TMP_C_ACT SELECT ACCOUNTID FROM VW_EX_Account VwACC  WHERE VwACC.CLIENTID=@ENTITY_ID AND ACCOUNT_TYPE = 'PIF'     
       AND ACCOUNTID NOT IN(SELECT OWNERID FROM TBL_PolicyItem WHERE POLICYLEVEL=300 AND POLICYDIMENSIONID=@POLICYDIMENSIONID)   
  END  
  ELSE  
  BEGIN  
   INSERT INTO @TMP_C_ACT SELECT ACCOUNTID FROM VW_EX_Account VwACC  WHERE VwACC.CLIENTID=@ENTITY_ID   
       AND ACCOUNTID NOT IN(SELECT OWNERID FROM TBL_PolicyItem WHERE POLICYLEVEL=300 AND POLICYDIMENSIONID=@POLICYDIMENSIONID)   
  END  
  --END HERE  
    
    
  IF NOT EXISTS(SELECT ACCOUNTID FROM @TMP_C_ACT)    
  BEGIN    
   --SINCE NO ACCOUNT FOUND UNDER THIS CLIENT, RETURN.    
   RETURN(1)    
  END    
  --UPDATE ALL THE ASSOCIATED ACCOUNT WITH THIS CLIENT    
  IF(@DATA_TYPE='DATE')    
  BEGIN    
   --KCBP Quickbase CR #4 - Start here  
   INSERT INTO @POLICYITEM  
   (  
    POLICYDIMENSIONID,   
    POLICYLEVEL,   
    OWNERID,   
    NUMERICVALUE,   
    TEXTVALUE,   
    LOGICALVALUE,   
    DATEVALUE,   
    POLICYDROPDOWNID,   
    COMMENT,
    CreatedDate ,
    CreatedUserId 
   )  
   SELECT   
    @POLICYDIMENSIONID,   
    300,   
    ACCOUNTID,   
    0,   
    NULL,   
    0,   
    @C_VAL_DATE,   
    0,   
    NULL,
    GETDATE(),  
   @USERID
   FROM @TMP_C_ACT  
  END    
  ELSE IF(@DATA_TYPE='LIST')    
  BEGIN    
   INSERT INTO @POLICYITEM  (  
    POLICYDIMENSIONID,   
    POLICYLEVEL,   
    OWNERID,   
    NUMERICVALUE,   
    TEXTVALUE,   
    LOGICALVALUE,   
    DATEVALUE,   
    POLICYDROPDOWNID,   
    COMMENT,
    CreatedDate ,
    CreatedUserId )  
   SELECT   
    @POLICYDIMENSIONID,   
    300,   
    ACCOUNTID,   
    0,   
    NULL,   
    0,   
    NULL,   
    @C_VAL_LIST,   
    NULL ,
   GETDATE(),  
   @USERID  
   FROM @TMP_C_ACT  
  END    
  ELSE IF(@DATA_TYPE='LOGICAL')    
  BEGIN    
   INSERT INTO @POLICYITEM (  
    POLICYDIMENSIONID,   
    POLICYLEVEL,   
    OWNERID,   
    NUMERICVALUE,   
    TEXTVALUE,   
    LOGICALVALUE,   
    DATEVALUE,   
    POLICYDROPDOWNID,   
    COMMENT,
    CreatedDate ,
    CreatedUserId   )  
   SELECT   
    @POLICYDIMENSIONID,   
    300,   
    ACCOUNTID,   
    0,   
    NULL,   
    @C_VAL_LOGICAL,   
    NULL,   
    0,   
    NULL,
    GETDATE(),    
    @USERID 
   FROM @TMP_C_ACT    
  END    
  ELSE IF(@DATA_TYPE='NUMERIC')    
  BEGIN    
   INSERT INTO @POLICYITEM (  
    POLICYDIMENSIONID,   
    POLICYLEVEL,   
    OWNERID,   
    NUMERICVALUE,   
    TEXTVALUE,   
    LOGICALVALUE,   
    DATEVALUE,   
    POLICYDROPDOWNID,   
    COMMENT,
    CreatedDate ,
    CreatedUserId )  
   SELECT   
    @POLICYDIMENSIONID,   
    300,   
    ACCOUNTID,   
    @C_VAL_NUMERIC,   
    NULL,   
    0,   
    NULL,   
    0,   
    NULL,
    GETDATE(),    
    @USERID
   FROM @TMP_C_ACT  
       
  END    
  ELSE IF(@DATA_TYPE='TEXT')    
  BEGIN    
   INSERT INTO @POLICYITEM (  
    POLICYDIMENSIONID,   
    POLICYLEVEL,   
    OWNERID,   
    NUMERICVALUE,   
    TEXTVALUE,   
    LOGICALVALUE,   
    DATEVALUE,   
    POLICYDROPDOWNID,   
    COMMENT, 
   CreatedDate ,
    CreatedUserId  )  
   SELECT   
    @POLICYDIMENSIONID,   
    300,   
    ACCOUNTID,   
    0,   
    @C_VAL_TEXT,   
    0,   
    NULL,   
    0,   
    NULL ,
    GETDATE(),    
    @USERID   
   FROM @TMP_C_ACT  
  END   
 END   
 --Insert into PolicyItem Table  
 DECLARE  @CNT INT,@CUR_PolicyItemID INT  
 DECLARE  @MAX_CNT INT  
 DECLARE @CUR_POLICYDIMENSIONID INT,@CUR_POLICYLEVEL INT,@CUR_OWNERID VARCHAR(14)  
   
 SET @CNT = 1  
 SELECT  @MAX_CNT  = COUNT(POLICYITEMID) FROM @POLICYITEM  
 WHILE (@CNT <=  @MAX_CNT)  
 BEGIN  
  SELECT   
   @CUR_POLICYDIMENSIONID=POLICYDIMENSIONID,  
   @CUR_POLICYLEVEL=POLICYLEVEL,  
   @CUR_OWNERID=OWNERID  
  FROM @POLICYITEM WHERE POLICYITEMID=@CNT  
  
  IF NOT EXISTS(SELECT POLICYITEMID   
      FROM TBL_PolicyItem   
      WHERE POLICYLEVEL=@CUR_POLICYLEVEL   
      AND POLICYDIMENSIONID=@CUR_POLICYDIMENSIONID  
      AND OWNERID=@CUR_OWNERID)  
  BEGIN  
   INSERT INTO TBL_PolicyItem (  
   PolicyDimensionID,  
   PolicyLevel,  
   OwnerID,  
   NumericValue,  
   TextValue,  
   LogicalValue,  
   DateValue,  
   PolicyDropDownID,  
   Comment,
   CreatedDate ,
   ModifiedDate,
   ModifiedUserId,
    CreatedUserId)  
   SELECT 
   PolicyDimensionID,  
   PolicyLevel,  
   OwnerID,  
   NumericValue,  
   TextValue,  
   LogicalValue,  
   DateValue,  
   PolicyDropDownID,  
   Comment,
    CreatedDate ,
    GETDATE(),
    CreatedUserId,
    CreatedUserId  
   FROM @POLICYITEM WHERE POLICYITEMID=@CNT  
   END  
  SET @CNT  = @CNT +1  
 END  
 IF(@@ERROR !=0)  
 BEGIN  
  RAISERROR 100043 'USP_EX_InsPolicyitemReportingCascade:Cannot update Reporting tbl_PolicyItem'  
 END  
END  

 GO
  IF EXISTS (	SELECT *
			FROM sysobjects
			WHERE type = 'P'
			AND name = 'USP_EX_InsPolicyitemReportingCascade') 
	BEGIN
			PRINT 'CREATED PROCEDURE USP_EX_InsPolicyitemReportingCascade';
	END  