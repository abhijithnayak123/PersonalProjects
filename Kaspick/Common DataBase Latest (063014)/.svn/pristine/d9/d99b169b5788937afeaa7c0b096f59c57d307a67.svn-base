IF EXISTS (
		SELECT *
		FROM sysobjects
		WHERE type = 'P'
			AND NAME = 'USP_EX_UpdWftCancelRequest'
		)
BEGIN
	DROP PROCEDURE USP_EX_UpdWftCancelRequest;

	PRINT 'DROPPED USP_EX_UpdWftCancelRequest';
END
GO

SET QUOTED_IDENTIFIER ON
GO

/******************************************************************************
** New Name : USP_EX_UpdWftCancelRequest
** Old Name:  sp_wft_cancel_request
** Short Desc:	
**
** Full Description
**        This stored proc is used to Cancel the Requests.
**
** Sample Call
   [sp_wft_cancel_request] '<root><Item ID="11163"></Item><Item ID="11455"></Item><Item ID="10927"></Item><Item ID="11208"></Item></root>'
**
** Return values: NONE
**
**
** Standard declarations
**       SET NOCOUNT             ON
**       SET LOCK_TIMEOUT         30000   -- 30 seconds
**	
**	Created By: Abhishek Chadha
**	Company	  :	Kaspick & Company
**	Project	  :	Excelsior
**	Created DT:	8/03/2009
**            
*******************************************************************************
**       Change History
*******************************************************************************
** Date:        Author:  Bug #     Description:                           Rvwd
** --------     -------- ------    -------------------------------------- --------
** 22-Mar-2014  Abhijith  EXCREQ9.1 Modified
** 23-MAY-2014  Mallikarjun     SP Name Renamed and Formatted
*******************************************************************************
** Copyright (C) <CopyrightYear,,Year> Kaspick & Company, All Rights Reserved
** COMPANY CONFIDENTIAL -- NOT FOR DISTRIBUTION
*******************************************************************************/
CREATE PROCEDURE [dbo].[USP_EX_UpdWftCancelRequest] (
	@XMLDOC NVARCHAR(4000)
	,@USERID INT
	)
AS
BEGIN
BEGIN TRY
BEGIN TRANSACTION
	DECLARE @IDOC INT
	DECLARE @Cancel_status_id INT

	
		EXEC sp_xml_preparedocument @IDOC OUTPUT
			,@XMLDOC

		EXEC USP_EX_GetListItemID @LIST_TYPE_NAME = 'WFT Flow Status'
			,@LIST_ITEM_NAME = 'Cancelled'
			,@LIST_ITEM_ID = @Cancel_status_id OUTPUT

		

		UPDATE TBL_WFT_Request
		SET request_status_id = @Cancel_status_id
			,status_datetime = getdate()
			,status_user_id = @USERID
		WHERE request_id IN (
				SELECT ID
				FROM OPENXML(@IDOC, '/root/Item', 1) WITH (ID INT)
				)

		COMMIT TRANSACTION
	END TRY

	BEGIN CATCH
		ROLLBACK TRANSACTION

		DECLARE @ErrorMessage NVARCHAR(4000);
		DECLARE @ErrorSeverity INT;
		DECLARE @ErrorState INT;

		SELECT @ErrorMessage = ERROR_MESSAGE()
			,@ErrorSeverity = ERROR_SEVERITY()
			,@ErrorState = ERROR_STATE();

		RAISERROR (
				@ErrorMessage
				,-- Message text.
				@ErrorSeverity
				,-- Severity.
				@ErrorState -- State.
				);
	END CATCH
END
GO

SET NOCOUNT OFF;

IF EXISTS (
		SELECT *
		FROM sysobjects
		WHERE type = 'P'
			AND NAME = 'USP_EX_UpdWftCancelRequest'
		)
BEGIN
	PRINT 'CREATED PROCEDURE USP_EX_UpdWftCancelRequest';
END