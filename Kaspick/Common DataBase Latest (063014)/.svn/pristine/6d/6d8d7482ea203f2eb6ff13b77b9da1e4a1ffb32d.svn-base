/****** Object:  StoredProcedure [dbo].[USP_PP_GetValidationEngineInvalidBeneficiaryDistribution]    Script Date: 10/03/2013 16:22:25 ******/
IF EXISTS (
		SELECT *
		FROM sys.objects
		WHERE object_id = OBJECT_ID(N'[dbo].[USP_PP_GetValidationEngineInvalidBeneficiaryDistribution]')
			AND type IN (
				N'P'
				,N'PC'
				)
		)
	DROP PROCEDURE [dbo].[USP_PP_GetValidationEngineInvalidBeneficiaryDistribution]
GO

/****** Object:  StoredProcedure [dbo].[USP_PP_GetValidationEngineInvalidBeneficiaryDistribution]    Script Date: 10/03/2013 16:22:25 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/******************************************************************************          
** Name:     USP_PP_GetValidationEngineInvalidBeneficiaryDistribution          
** Short Desc: The sp checks for the error in the innotrust web service resposne for BeneficiaryDistributionID          
**          
** Full Description : This procedure uses Innotrust response data from table TBL_PP_STG_InnoTrustValidationEngineInput for validation. The sp checks for the error in ErrorMessage column.
**             
** Input Parameter
** @UserID INT,
** @Type Bit =1--auto       
** Sample Call          
          
EXEC USP_PP_GetValidationEngineInvalidBeneficiaryDistribution  1          
              
**          
** Return values: NONE          
**          
**          
** Standard declarations          
**       SET LOCK_TIMEOUT         30000   -- 30 seconds          
**           
** Created By: Niveditha narasimha         
** Company   : Kaspick & Company          
** Project   : Back Office Integration - Paragon    
** Created DT: 30-May-2014
**                      
*******************************************************************************          
**       Change History          
*******************************************************************************          
** Date:        Author:  Bug #     Description:                           Rvwd          
** --------     -------- ------    -------------------------------------- --------          

*******************************************************************************          
** Copyright (C) <CopyrightYear,,Year> Kaspick & Company, All Rights Reserved          
** COMPANY CONFIDENTIAL -- NOT FOR DISTRIBUTION          
*******************************************************************************/
CREATE PROCEDURE [dbo].[USP_PP_GetValidationEngineInvalidBeneficiaryDistribution] @UserID INT
	,@Type BIT = 1 --auto
AS
--  Initial Set statements  --          
SET NOCOUNT ON;
SET LOCK_TIMEOUT 30000;-- 30 seconds       

--  Variable Declarations  --          
DECLARE @RuleId INT

-- Body of procedure  --          
SELECT @RuleId = RuleId
FROM TBL_PP_ValidationRule
WHERE rulename = 'Invalid BeneficiaryDistributionID'

SELECT PaymentType
	,ScheduleId
	,@RuleId AS 'RuleId'
	,'ValidBenficiaryDistribtuionID' AS Attribute
	,CASE 
		WHEN (ISNULL(ErrorMessage, '') <> '')
			THEN 0
		ELSE 1
		END AS ActualValue
FROM TBL_PP_STG_InnoTrustValidationEngineInput STGData
WHERE UserId = @UserID
	AND PaymentType IN (
		'Beneficiarypayment'
		,'PGCalcImport'
		)
GO


