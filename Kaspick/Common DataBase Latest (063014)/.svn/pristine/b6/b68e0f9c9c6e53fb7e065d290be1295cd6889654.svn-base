
IF EXISTS (
		SELECT *
		FROM sysobjects
		WHERE type = 'P'
			AND NAME = 'USP_EX_SaveProfileTax'
		)
BEGIN
	DROP PROCEDURE USP_EX_SaveProfileTax;

	PRINT 'DROPPED USP_EX_SaveProfileTax';
END
GO

/*********************************************************************************************************************                                                         
* Procedure Name  : USP_EX_SaveProfileTax
* Old Procedure Name  : USP_EIS_EX_PROFILE_TAX_InsUpdProc                 
* Description     : To INSERT records into Table, TBL_EIS_EX_PROFILE_TAX                
* Sample call     :     

 EXEC USP_EX_SaveProfileTax '300245','Manager','8/9/2007','8/10/2007','8/9/2007','8/11/2007',null,1121,4930,4931,4784,
    4782, 100260,'ClientTax.aspx','High Priority',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,1,1,1
'AM','MANAGER',NULL,NULL,null,null,null,null,null,58356,75,28,58220,null, null,2045,null,2047,100261,'clienttax.aspx','High Priority',18       

--For Account
EXEC USP_EX_SaveProfileTax 'ACBAD','ACCOUNT',NULL,NULL,NULL,NULL,59691,NULL,NULL,58761,76,20,76,58805,59691,59694,18,2002,NULL,100023,'AccountTax.aspx',18,'OR Reg No','',18,'12345678'

--For Client
EXEC USP_EX_SaveProfileTax 'ACL','MANAGER',NULL,NULL,NULL,NULL,58343,0,2043,58805,76,19,58343,58761,58882,2046,NULL,2047,100048,'ClientTax.aspx','High Priority',18

--For Program
EXEC USP_EX_SaveProfileTax 'ACL','MANAGER',NULL,NULL,NULL,NULL,58343,0,2043,58805,76,19,58343,58761,58882,2046,NULL,2047,100048,'ClientTax.aspx','High Priority',18
            
* Modification Log: Query Indentation                
*     For update on Alerts table; modified by and modified date columns are updated.                
*                                            
* Date         Modified By  Description                                                            
*--------------------------------------------------------------------------------------------------------------------                                                         
* 22-Oct-06  Geetha P  Created                    
* 31-oct-06  Manjiri C  Modified              
* 28-Feb-07  Geetha P Modified *Replaced BeneificiaryId with ParticipantID coz the column name was changed*              
* 01-Mar-07  Geetha P Modified *To fix Bug#4305 - CR*                
* 03-Apr-07  Geetha P Modified *To fix Bug#4758 - CR* added if clause for entitytype = account               
* 31-may-07  Vshivhare Modified for Ins/Upd Tax Details in Policy Table        
* 05-jun-07  Vshivhare modified,did indentation for only single transaction & New dimension Depre. Schedule          
* 11-july-07 Tanuj  modified , checking error no 50002 in catch block           
* 19-july-07 tanuj mdified    Added new K1Priority condition
* 11-Apr-14  Yugandhar EXCREQ 7.4      
*********************************************************************************************************************/

CREATE PROCEDURE USP_EX_SaveProfileTax 
(
	@ENTITYID VARCHAR(15)
	,@ENTITYTYPE VARCHAR(30)
	,@TRUSTEECHANGEDATE DATETIME
	,@ADDRESSCHANGEDATE DATETIME
	,@ACCOUNTTRANSFERDATE DATETIME
	,@TAXRETURNEXTENSIONDATE DATETIME
	,@FASCIMILESIGNEREMPID INT
	,@FASCIMILESIGNERFLAG INT --ADDED BY DEEPA    
	,@R1009MEDIAID INT
	,@BENEFICIARYTAXFORMID INT
	,@MAILONORBEFORE_MM_ID INT
	,@MAILONORBEFORE_DD_ID INT
	,@TAXRETURNID INT
	,@TAX10989ID INT
	,@TAX1099RID INT
	,@K1_MAILING_RULE INT = NULL
	,@MNSTATE_ID VARCHAR(100) = NULL
	,@TX_RTN_MAILING_RULE INT = NULL
	,@USERID INT
	,@PAGENAME VARCHAR(100)
	,@FIELDNAME VARCHAR(100)
	,@HIGHPRIORITY_K1_ID INT = NULL
	,@DEPRECIATION INT = NULL
	,@XMLDOC VARCHAR(4000) = NULL
	,@FIRSTTAXYEAR INT = NULL
	,@LASTTAXYEAR INT = NULL
	,@CT_12S_ID INT = NULL
	,@OR_REGISTRATION_NO VARCHAR(8) = NULL
	,@OR_REGISTRATION_BELL_DATE DATETIME = NULL
	)
AS
BEGIN
	BEGIN TRANSACTION

	DECLARE @ENTITY_TYPE INT
	DECLARE @STATUSFLAG BIT
	DECLARE @LOCAL_TABLE_NAME VARCHAR(100)
	DECLARE @LOCAL_FIELD_NAME VARCHAR(100)
	--3.Mail on or Before                
	DECLARE @MAILONORBEFORE_VALUE VARCHAR(5)

	SELECT @MAILONORBEFORE_VALUE = DISPLAYSEQUENCE
	FROM TBL_LISTITEM
	WHERE LISTITEMID = @MAILONORBEFORE_MM_ID

	SELECT @MAILONORBEFORE_VALUE = CAST(@MAILONORBEFORE_VALUE AS VARCHAR) + '/' + CAST(@MAILONORBEFORE_DD_ID AS VARCHAR)

	DECLARE @HIGHPPOLICYDID INT
		,@HIGHPRIORITYVALUE DATETIME
	DECLARE @K1PRIORITY INT
		,@K1_VALUE BIT
	DECLARE @K1_POLICYDIMENSION_ID INT
		,@HIGH_POLICYDIMENSION_ID INT

	SET @K1_POLICYDIMENSION_ID = 197
	SET @HIGH_POLICYDIMENSION_ID = 244

	EXEC USP_EX_GetListItemID @LIST_TYPE_NAME = 'ENTITY'
		,@LIST_ITEM_NAME = @ENTITYTYPE
		,@LIST_ITEM_ID = @ENTITY_TYPE OUTPUT

	DECLARE @TAX_ID INT
		,@CLIENTID VARCHAR(15)
		,@PROGRAMID VARCHAR(15)
		,@ACCOUNTID VARCHAR(14)
		,@BENEFICIARYID VARCHAR(14)
		,@DISPLAY_NAME VARCHAR(50)

	IF (@ENTITYTYPE = 'ACCOUNT')
	BEGIN
		SELECT @TAX_ID = TAX_ID
		FROM TBL_IRS_ProfileTax
		WHERE CustomerAccountNumber = @ENTITYID
	END
	ELSE
	BEGIN
		SELECT @TAX_ID = TAX_ID
		FROM TBL_IRS_ProfileTax
		WHERE (
				CASE 
					WHEN @ENTITYTYPE = 'MANAGER'
						THEN ManagerCode
					WHEN @ENTITYTYPE = 'ALLIANCE'
						THEN AllianceNumber
					END
				) = @ENTITYID
	END

	SET @CLIENTID = NULL
	SET @PROGRAMID = NULL
	SET @ACCOUNTID = NULL
	SET @BENEFICIARYID = NULL

	IF @ENTITYTYPE = 'MANAGER'                        
	BEGIN                       
	 SET @CLIENTID = @ENTITYID                        
	 SET @DISPLAY_NAME='Client - Tax'                      
	 SET @LOCAL_TABLE_NAME = 'CLIENT'                      
	 SET @LOCAL_FIELD_NAME = 'MANAGERCODE'                      
	END                      
	IF @ENTITYTYPE = 'ALLIANCE'                          
	BEGIN                      
	 SET @PROGRAMID = @ENTITYID                        
	 SET @DISPLAY_NAME='Program - Tax'                      
	 SET @LOCAL_TABLE_NAME = 'PROGRAM'                      
	 SET @LOCAL_FIELD_NAME = 'ALLIANCENUMBER'                      
	END                      
	IF @ENTITYTYPE = 'ACCOUNT'
	BEGIN
		SET @ACCOUNTID = @ENTITYID
		SET @DISPLAY_NAME = 'Account - Tax'
		SET @LOCAL_TABLE_NAME = 'TBL_INV_AccountProfile'
		SET @LOCAL_FIELD_NAME = 'CustomerAccountNumber'

		
			IF (@STATUSFLAG = 1)
			BEGIN
				RAISERROR 50002 'RECORD DELETED'

				ROLLBACK TRANSACTION

				RETURN
			END
	END
	 
	IF NOT EXISTS
	(
		SELECT 
			1 
		FROM   
			SYN_IT_ContactMaster CM 
			INNER JOIN SYN_IT_SubContactRoles CR ON CR.ContactID = CM.ContactID AND CR.ContactRoleCode = (SELECT ID FROM SYN_IT_ContactRoleCodes 
			WHERE ID IN (550))
			INNER JOIN SYN_IT_ContactMaster CE ON CE.ContactID = CR.SubContactID
		WHERE   
		CR.SubContactID =@FASCIMILESIGNEREMPID
	)   
	BEGIN     
		SET @FASCIMILESIGNEREMPID = NULL
	END	

	--Cascading Previous Values         
	DECLARE @TEMP_HIGHPRIORITY_K1 INT

	SET @TEMP_HIGHPRIORITY_K1 = @HIGHPRIORITY_K1_ID

	IF (
			(@MAILONORBEFORE_VALUE IS NULL)
			AND (
				@HIGHPRIORITY_K1_ID IS NULL
				OR @HIGHPRIORITY_K1_ID = 0
				)
			)
	BEGIN
	
		DECLARE @LOGICAL_LIST_TYPEID INT

		SELECT @LOGICAL_LIST_TYPEID = LISTTYPEID
		FROM TBL_LISTTYPE
		WHERE LISTTYPENAME = 'Logical Value'

		IF (@ENTITYTYPE = 'ALLIANCE')
			SELECT @HIGHPRIORITY_K1_ID = LISTITEMID
			FROM TBL_PolicyItem P
			INNER JOIN TBL_LISTITEM LI ON P.LOGICALVALUE = LI.IVANVALUE
				AND LISTTYPEID = @LOGICAL_LIST_TYPEID
			WHERE P.POLICYDIMENSIONID = @K1_POLICYDIMENSION_ID
				AND P.PolicyLevel = 100
				AND OWNERID IN (
					SELECT Managercode
					FROM SYN_IT_AccountMaster
					WHERE AllianceNumber = @ENTITYID
					)
		ELSE IF (@ENTITYTYPE = 'ACCOUNT')
			SELECT @HIGHPRIORITY_K1_ID = LISTITEMID
			FROM TBL_PolicyItem P
			INNER JOIN TBL_LISTITEM LI ON P.LOGICALVALUE = LI.IVANVALUE
				AND LISTTYPEID = @LOGICAL_LIST_TYPEID
			WHERE POLICYDIMENSIONID = @K1_POLICYDIMENSION_ID
				AND POLICYLEVEL = 200
				AND OWNERID IN (
					SELECT AllianceNumber
					FROM VW_EX_Account
					WHERE ACCOUNTID = @ENTITYID
					)
	END

	IF (
			@MAILONORBEFORE_VALUE IS NULL
			AND (
				@TEMP_HIGHPRIORITY_K1 IS NULL
				OR @TEMP_HIGHPRIORITY_K1 = 0
				)
			)
	BEGIN
		IF (@ENTITYTYPE = 'ALLIANCE')
			SELECT @MAILONORBEFORE_VALUE = TEXTVALUE
			FROM TBL_PolicyItem
			WHERE POLICYDIMENSIONID = @HIGH_POLICYDIMENSION_ID
				AND POLICYLEVEL = 100
				AND OWNERID IN (
					SELECT Managercode
					FROM SYN_IT_AccountMaster
					WHERE AllianceNumber = @ENTITYID
					)
		ELSE IF (@ENTITYTYPE = 'ACCOUNT')
			SELECT @MAILONORBEFORE_VALUE = TEXTVALUE
			FROM TBL_PolicyItem
			WHERE POLICYDIMENSIONID = @HIGH_POLICYDIMENSION_ID
				AND POLICYLEVEL = 200
				AND OWNERID IN (
					SELECT AllianceNumber
					FROM VW_EX_Account
					WHERE ACCOUNTID = @ENTITYID
					)
	END

	EXEC USP_EX_SaveDonorbeneTaxCascade @ENTITY_TYPE = @ENTITYTYPE
		,@ENTITYID = @ENTITYID
		,@NEW_K1MAILINGRULEID = @HIGHPRIORITY_K1_ID
		,@NEW_HIGHPRIORITY = @MAILONORBEFORE_VALUE
		,@USERID = @USERID

	IF (
			(
				(
					@FASCIMILESIGNEREMPID IS NULL
					AND @FASCIMILESIGNERFLAG IS NULL
					)
				OR @BENEFICIARYTAXFORMID IS NULL
				OR @TAXRETURNID IS NULL
				OR @TAX10989ID IS NULL
				OR @TAX1099RID IS NULL
				)
			AND @ENTITYTYPE <> 'MANAGER'
			)
	BEGIN
		
		DECLARE @NEW_FASCIMILESIGNEREMPID INT
			,@NEW_BENEFICIARYTAXFORMID INT
			,@NEW_TAXRETURNID INT
			,@NEW_TAX10989ID INT
			,@NEW_TAX1099RID INT
			,@NEW_FASCIMILESIGNERFLAG INT

		EXEC USP_EX_GetProfileTaxCascade @ENTITYID
			,@ENTITYTYPE
			,@NEW_FASCIMILESIGNEREMPID OUTPUT
			,@NEW_FASCIMILESIGNERFLAG OUTPUT
			,@NEW_BENEFICIARYTAXFORMID OUTPUT
			,@NEW_TAXRETURNID OUTPUT
			,@NEW_TAX10989ID OUTPUT
			,@NEW_TAX1099RID OUTPUT

		IF (
				@FASCIMILESIGNEREMPID IS NULL
				AND @FASCIMILESIGNERFLAG IS NULL
				)
		BEGIN
			SET @FASCIMILESIGNEREMPID = @NEW_FASCIMILESIGNEREMPID
			SET @FASCIMILESIGNERFLAG = @NEW_FASCIMILESIGNERFLAG
		END

		IF (@BENEFICIARYTAXFORMID IS NULL)
			SET @BENEFICIARYTAXFORMID = @NEW_BENEFICIARYTAXFORMID

		IF (@TAXRETURNID IS NULL)
			SET @TAXRETURNID = @NEW_TAXRETURNID

		IF (@TAX10989ID IS NULL)
			SET @TAX10989ID = @NEW_TAX10989ID

		IF (@TAX1099RID IS NULL)
			SET @TAX1099RID = @NEW_TAX1099RID
	END

	--Cascade Update        
	EXEC USP_EX_SaveProfileTaxCascade @ENTITYID = @ENTITYID
		,@ENTITY_TYPE = @ENTITYTYPE
		,@NEW_FASCIMILESIGNEREMPID = @FASCIMILESIGNEREMPID
		,@NEW_FASCIMILESIGNERFLAG = @FASCIMILESIGNERFLAG
		,@NEW_BENEFICIARYTAXFORMID = @BENEFICIARYTAXFORMID
		,@NEW_TAXRETURNID = @TAXRETURNID
		,@NEW_TAX10989ID = @TAX10989ID
		,@NEW_TAX1099RID = @TAX1099RID
		,@USERID = @USERID

	IF ISNULL(@TAX_ID, 0) <> 0
	BEGIN
		         
		
		UPDATE TBL_IRS_ProfileTax
		SET EmployeeContactID = @FASCIMILESIGNEREMPID
			,BENEFICIARY_TAX_FORM_ID = @BENEFICIARYTAXFORMID
			,TAX_RETURN_ID = @TAXRETURNID
			,TAX_10989_ID = @TAX10989ID
			,TAX_1099R_ID = @TAX1099RID
			,CT_12S_ID = @CT_12S_ID
			,OR_REGISTRATION_NO = @OR_REGISTRATION_NO
			,MODIFIED_DATE = GETDATE()
			,MODIFIED_USER_ID = @USERID
			,FASCIMILE_SIGNER_FLAG = @FASCIMILESIGNERFLAG
		WHERE TAX_ID = @TAX_ID
			                      
	END
	ELSE
	BEGIN
		INSERT INTO TBL_IRS_ProfileTax (
			ENTITY_TYPE_ID
			,ManagerCode
			,AllianceNumber
			,CustomerAccountNumber
			,BeneContactID
			,EmployeeContactID
			,BENEFICIARY_TAX_FORM_ID
			,TAX_RETURN_ID
			,TAX_10989_ID
			,TAX_1099R_ID
			,MODIFIED_DATE
			,MODIFIED_USER_ID
			,CREATED_DATE
			,CREATED_USER_ID
			,CT_12S_ID
			,OR_REGISTRATION_NO
			,FASCIMILE_SIGNER_FLAG
			)
		VALUES (
			CAST(@ENTITY_TYPE AS VARCHAR(30))
			,@CLIENTID
			,@PROGRAMID
			,@ACCOUNTID
			,@BENEFICIARYID
			,@FASCIMILESIGNEREMPID
			,@BENEFICIARYTAXFORMID
			,@TAXRETURNID
			,@TAX10989ID
			,@TAX1099RID
			,GETDATE()
			,@USERID
			,GETDATE()
			,@USERID
			,@CT_12S_ID
			,@OR_REGISTRATION_NO
			,@FASCIMILESIGNERFLAG
			)

		SET @TAX_ID = IDENT_CURRENT('TBL_IRS_ProfileTax')

			               
	END

	DECLARE @POLICY_LEVEL INT

	SELECT @POLICY_LEVEL = POLICYLEVEL
	FROM TBL_PolicyLevel
	WHERE LEVELNAME = @ENTITYTYPE

	--Insert/Update in Policy Tables                   
	--High Priority K-1 Policy        
	DECLARE @NEW_K1MAILINGRULE INT
		,@POLICYITEMID INT

	SET @NEW_K1MAILINGRULE = NULL

	SELECT @NEW_K1MAILINGRULE = IVANVALUE
	FROM VW_EX_ListItem
	WHERE LISTTYPENAME = 'Logical Value'
		AND LISTITEMID = @HIGHPRIORITY_K1_ID

	IF (@NEW_K1MAILINGRULE IS NULL)
	BEGIN
		
		UPDATE TBL_POLICYITEM
		SET DELETEDUSERID = @USERID
			,MODIFIEDDATE = GETDATE()
		WHERE POLICYITEMID IN (
				SELECT POLICYITEMID
				FROM TBL_PolicyItem
				WHERE POLICYDIMENSIONID = @K1_POLICYDIMENSION_ID
					AND POLICYLEVEL = @POLICY_LEVEL
					AND OWNERID = @ENTITYID
				)

		DELETE
		FROM TBL_PolicyItem
		WHERE POLICYDIMENSIONID = @K1_POLICYDIMENSION_ID
			AND POLICYLEVEL = @POLICY_LEVEL
			AND OWNERID = @ENTITYID
	END
	ELSE
	BEGIN
		
		IF NOT EXISTS (
				SELECT *
				FROM TBL_PolicyItem
				WHERE POLICYDIMENSIONID = @K1_POLICYDIMENSION_ID
					AND POLICYLEVEL = @POLICY_LEVEL
					AND OWNERID = @ENTITYID
				)
		BEGIN

			INSERT INTO TBL_PolicyItem (
				--PolicyItemID,
				POLICYDIMENSIONID
				,POLICYLEVEL
				,OWNERID
				,NUMERICVALUE
				,TEXTVALUE
				,LOGICALVALUE
				,DATEVALUE
				,POLICYDROPDOWNID
				,COMMENT
				,MODIFIEDDATE
				,MODIFIEDUSERID
				,CREATEDDATE
				,CREATEDUSERID
				,DELETEDUSERID
				)
			VALUES (
				--@POLICYITEMID, 
				@K1_POLICYDIMENSION_ID
				,@POLICY_LEVEL
				,@ENTITYID
				,0
				,NULL
				,@NEW_K1MAILINGRULE
				,NULL
				,0
				,NULL
				,GETDATE()
				,@USERID
				,GETDATE()
				,@USERID
				,NULL
				)

			SET @POLICYITEMID = IDENT_CURRENT('TBL_POLICYITEM')
				           
		END
		ELSE
		BEGIN
			
			UPDATE TBL_POLICYITEM
			SET MODIFIEDDATE = GETDATE()
				,MODIFIEDUSERID = @USERID
			WHERE POLICYITEMID = (
					SELECT POLICYITEMID
					FROM TBL_PolicyItem
					WHERE POLICYDIMENSIONID = @K1_POLICYDIMENSION_ID
						AND POLICYLEVEL = @POLICY_LEVEL
						AND OWNERID = @ENTITYID
					)


		     
			UPDATE TBL_PolicyItem
			SET LOGICALVALUE = @NEW_K1MAILINGRULE
			WHERE POLICYDIMENSIONID = @K1_POLICYDIMENSION_ID
				AND POLICYLEVEL = @POLICY_LEVEL
				AND OWNERID = @ENTITYID
		END
	END

	--High Priority Policy        
	IF (
			@NEW_K1MAILINGRULE = 0
			OR @NEW_K1MAILINGRULE IS NULL
			)
		SET @MAILONORBEFORE_VALUE = NULL

	IF (@MAILONORBEFORE_VALUE IS NULL)
	BEGIN
		UPDATE TBL_POLICYITEM
		SET DELETEDUSERID = @USERID
			,MODIFIEDDATE = GETDATE()
		WHERE POLICYITEMID = (
				SELECT POLICYITEMID
				FROM TBL_PolicyItem
				WHERE POLICYDIMENSIONID = @HIGH_POLICYDIMENSION_ID
					AND POLICYLEVEL = @POLICY_LEVEL
					AND OWNERID = @ENTITYID
				)

		DELETE
		FROM TBL_PolicyItem
		WHERE POLICYDIMENSIONID = @HIGH_POLICYDIMENSION_ID
			AND POLICYLEVEL = @POLICY_LEVEL
			AND OWNERID = @ENTITYID
	END
	ELSE
	BEGIN
		
		IF NOT EXISTS (
				SELECT POLICYITEMID
				FROM TBL_PolicyItem
				WHERE POLICYDIMENSIONID = @HIGH_POLICYDIMENSION_ID
					AND POLICYLEVEL = @POLICY_LEVEL
					AND OWNERID = @ENTITYID
				)
		BEGIN

			INSERT INTO TBL_PolicyItem (
				--PolicyItemID,
				POLICYDIMENSIONID
				,POLICYLEVEL
				,OWNERID
				,NUMERICVALUE
				,TEXTVALUE
				,LOGICALVALUE
				,DATEVALUE
				,POLICYDROPDOWNID
				,COMMENT
				,MODIFIEDDATE
				,MODIFIEDUSERID
				,CREATEDDATE
				,CREATEDUSERID
				,DELETEDUSERID
				)
			VALUES (
				-- @POLICYITEMID, 
				@HIGH_POLICYDIMENSION_ID
				,@POLICY_LEVEL
				,@ENTITYID
				,0
				,@MAILONORBEFORE_VALUE
				,0
				,NULL
				,0
				,NULL
				,GETDATE()
				,@USERID
				,GETDATE()
				,@USERID
				,NULL
				)

			SET @POLICYITEMID = IDENT_CURRENT('TBL_POLICYITEM')
			        
		END
		ELSE
		BEGIN
			
			UPDATE TBL_POLICYITEM
			SET MODIFIEDDATE = GETDATE()
				,MODIFIEDUSERID = @USERID
			WHERE POLICYITEMID = (
					SELECT POLICYITEMID
					FROM TBL_PolicyItem
					WHERE POLICYDIMENSIONID = @HIGH_POLICYDIMENSION_ID
						AND POLICYLEVEL = @POLICY_LEVEL
						AND OWNERID = @ENTITYID
					)


		      
			UPDATE TBL_PolicyItem
			SET TEXTVALUE = @MAILONORBEFORE_VALUE
			WHERE POLICYDIMENSIONID = @HIGH_POLICYDIMENSION_ID
				AND POLICYLEVEL = @POLICY_LEVEL
				AND OWNERID = @ENTITYID
		END
	END

	
	--13. TRUSTEE CHNAGE DATE              
	EXEC USP_EX_SavePolicyitems @POLICYDIMENSIONNAME = 'Trustee Change Date'
		,@LIST_ITEM_ID = NULL
		,@POLICYLEVEL = @POLICY_LEVEL
		,@OWNERID = @ENTITYID
		,@SCALARVALUE = @TRUSTEECHANGEDATE
		,@USERID = @USERID
		,@POLICYCATEGORY = 'Tax Production'

	--13. Tax Return Extension Date              
	EXEC USP_EX_SavePolicyitems @POLICYDIMENSIONNAME = 'Tax Return Ext. Date'
		,@LIST_ITEM_ID = NULL
		,@POLICYLEVEL = @POLICY_LEVEL
		,@OWNERID = @ENTITYID
		,@SCALARVALUE = @TAXRETURNEXTENSIONDATE
		,@USERID = @USERID
		,@POLICYCATEGORY = 'Tax Production'

	--13.  Account Transerfer Date              
	EXEC USP_EX_SavePolicyitems @POLICYDIMENSIONNAME = 'Account Transfer Dt'
		,@LIST_ITEM_ID = NULL
		,@POLICYLEVEL = @POLICY_LEVEL
		,@OWNERID = @ENTITYID
		,@SCALARVALUE = @ACCOUNTTRANSFERDATE
		,@USERID = @USERID
		,@POLICYCATEGORY = 'Tax Production'

	--13.  Address Change Date              
	EXEC USP_EX_SavePolicyitems @POLICYDIMENSIONNAME = 'Address Change Date'
		,@LIST_ITEM_ID = NULL
		,@POLICYLEVEL = @POLICY_LEVEL
		,@OWNERID = @ENTITYID
		,@SCALARVALUE = @ADDRESSCHANGEDATE
		,@USERID = @USERID
		,@POLICYCATEGORY = 'Tax Production'

	--13. 1099 R Media              
	EXEC USP_EX_SavePolicyitems @POLICYDIMENSIONNAME = '1099R Media'
		,@LIST_ITEM_ID = @R1009MEDIAID
		,@POLICYLEVEL = @POLICY_LEVEL
		,@OWNERID = @ENTITYID
		,@SCALARVALUE = @R1009MEDIAID
		,@USERID = @USERID
		,@POLICYCATEGORY = 'Tax Production'

	IF (@ENTITYTYPE = 'MANAGER')
	BEGIN
		--12. Use K-1 MAILING RULE            
		EXEC USP_EX_SavePolicyitems @POLICYDIMENSIONNAME = 'K-1 MAILING RULE'
			,@LIST_ITEM_ID = @K1_MAILING_RULE
			,@POLICYLEVEL = @POLICY_LEVEL
			,@OWNERID = @ENTITYID
			,@SCALARVALUE = NULL
			,@USERID = @USERID
			,@POLICYCATEGORY = 'Tax Production'

		--21. Use TX RTN MAILING RULE              
		EXEC USP_EX_SavePolicyitems @POLICYDIMENSIONNAME = 'TX RTN MAILING RULE'
			,@LIST_ITEM_ID = @TX_RTN_MAILING_RULE
			,@POLICYLEVEL = @POLICY_LEVEL
			,@OWNERID = @ENTITYID
			,@SCALARVALUE = NULL
			,@USERID = @USERID
			,@POLICYCATEGORY = 'Tax Production'
	END

	IF (@ENTITYTYPE = 'ALLIANCE')
	BEGIN
		--10. MN State ID                           
		EXEC USP_EX_SavePolicyitems @POLICYDIMENSIONNAME = 'MN State ID'
			,@LIST_ITEM_ID = 0
			,@POLICYLEVEL = @POLICY_LEVEL
			,@OWNERID = @ENTITYID
			,@SCALARVALUE = @MNSTATE_ID
			,@USERID = @USERID
			,@POLICYCATEGORY = 'Tax Production'
	END

	IF (@ENTITYTYPE = 'ACCOUNT')
	BEGIN
		--Insert Deprciation Schedule            
		EXEC USP_EX_SavePolicyitems @POLICYDIMENSIONNAME = 'Depre. Schedule'
			,@LIST_ITEM_ID = @DEPRECIATION
			,@POLICYLEVEL = @POLICY_LEVEL
			,@OWNERID = @ENTITYID
			,@SCALARVALUE = @DEPRECIATION
			,@USERID = @USERID
			,@POLICYCATEGORY = 'Tax Production'

		EXEC USP_EX_GetDeleteStatusFlag @TABLE_NAME = @LOCAL_TABLE_NAME
			,@FIELD_NAME = @LOCAL_FIELD_NAME
			,@FIELD_VALUE = @ENTITYID
			,@STATUS = @STATUSFLAG OUTPUT
	END

	IF (@STATUSFLAG = 1)
	BEGIN
		RAISERROR 50002 'RECORD DELETED'

		ROLLBACK TRANSACTION

		RETURN
	END
	ELSE
	BEGIN
		
		EXEC USP_EX_SaveProfileTaxConditions @XMLDOC = @XMLDOC
			,@TAX_ID = @TAX_ID
	END

	                     
	COMMIT TRANSACTION
	          
END
GO

IF EXISTS (
		SELECT *
		FROM sysobjects
		WHERE type = 'P'
			AND NAME = 'USP_EX_SaveProfileTax'
		)
BEGIN
	PRINT 'CREATED PROCEDURE USP_EX_SaveProfileTax';
END