IF EXISTS (
		SELECT *
		FROM sysobjects
		WHERE type = 'P'
			AND NAME = 'USP_RP_GetBRDTManagementConsole'
		)
BEGIN
	DROP PROCEDURE USP_RP_GetBRDTManagementConsole;

	PRINT 'DROPPED USP_RP_GetBRDTManagementConsole';
END
GO

/******************************************************************************                  
** Old Name: USP_EIS_BR_DT_ManagementConsole_SelProc

** New Name: USP_RP_GetBRDTManagementConsole

** Short Desc: To fetch data for Management Console
**                  
** Full Description: To fetch data for Management Console  
**                          
** Input Arguments: 
**					
** Sample Call 
  EXEC USP_RP_GetBRDTManagementConsole 0,'2','0','','','','0','1'
**									
** Return values: Null
**                  
**                  
** Standard declarations                  
**       SET LOCK_TIMEOUT         30000   -- 30 seconds                  
**                   
** Created By: Ashvin Mandowara
** Company   : Kaspick & Company                  
** Project   : Excelsior  - BeneReport                  
** Created DT: 23-Nov-2011
**                              
*******************************************************************************            
**       Change History                  
*******************************************************************************            
** Date:        Author:  Bug #     Description:                           Rvwd            
** --------		-------- ------    -------------------------------------- --------            
** Mar-12-2012 Ashvin			Changes for Adding Comments as per Stored Procedure standard template.
** Mar-14-2012 Ashvin			ERD changes implemetation.
** May-10-2012 Ashvin			Adding @DeliverableID.
** 06-Jun-2014 Mukesh			SP Name Renamed and Formatted
** 14-Jul-2014 Mukesh           Updated SP to use view for client manager, report analyst,relationship manager
*******************************************************************************                  
** Copyright (C) <CopyrightYear,,Year> Kaspick & Company, All Rights Reserved                  
** COMPANY CONFIDENTIAL -- NOT FOR DISTRIBUTION                  
*******************************************************************************/
CREATE PROCEDURE [dbo].[USP_RP_GetBRDTManagementConsole] (
	@DeliverableID BIGINT = 0
	,@DeliverableQueueID INT = 0
	,@StatusIDs VARCHAR(4000) = '0'
	,@ClientIDs VARCHAR(4000) = '0'
	,@FromDate DATETIME
	,@ToDate DATETIME
	,@ReportOwners BIGINT = 0
	,@OwnerRole BIGINT = 0
	)
AS
BEGIN
	--DECLARE @DeliverableID INT  
	--SET @DeliverableID = (SELECT DeliverableID FROM TBL_EIS_DT_DELIVERABLE_QUEUE WHERE DeliverableQueueID = @DeliverableQueueID)  
	DECLARE @SourceTable TABLE (
		DeliverableName VARCHAR(150)
		,QueueName VARCHAR(150)
		,ClientManagerUsers VARCHAR(150)
		,ClientBriefName VARCHAR(20)
		,ReportAnalystUsers VARCHAR(150)
		,AccountType VARCHAR(50)
		,SendTo VARCHAR(20)
		,DeliverableQueueID INT
		,DeliverableItemID INT
		,DeliverableItemStatusID INT
		,statusname VARCHAR(100)
		,DropDownIdID INT
		,OWNER_ROLE VARCHAR(150)
		,REPORT_OWNER VARCHAR(250)
		)

	IF OBJECT_ID('#TempActivityConsole1') IS NOT NULL
		DROP TABLE #TempActivityConsole1

	CREATE TABLE #TempActivityConsole1 (
		DropDownIdID INT
		,DropDownText VARCHAR(100)
		)

	IF OBJECT_ID('#TempActivityConsoleSendTo') IS NOT NULL
		DROP TABLE #TempActivityConsoleSendTo

	CREATE TABLE #TempActivityConsoleSendTo (
		DropDownIdID INT
		,DropDownText VARCHAR(100)
		,OWNERID VARCHAR(15)
		,POLICYLEVEL INT
		)

	DECLARE @DelID INT
	DECLARE @DelType VARCHAR(100)

	SELECT @DelID = DeliverableID
	FROM TBL_DLV_DeliverableQueue
	WHERE DeliverableQueueID = @DeliverableQueueID

	INSERT INTO #TempActivityConsole1
	EXEC USP_RP_GetPPDDLSendTo @DelID

	--SELECT @DelType = (COALESCE(@DelType +',','')  + convert(varchar(10),DropDownIdID))  FROM  #TempActivityConsole1 
	INSERT INTO #TempActivityConsoleSendTo
	SELECT DISTINCT PII.POLICYDROPDOWNID
		,PID.DropDownText
		,PII.OWNERID
		,PII.POLICYLEVEL
	FROM TBL_PolicyItem PII
	INNER JOIN TBL_PolicyDropDown PID ON PII.POLICYDROPDOWNID = PID.PolicyDropDownID
	WHERE PII.POLICYDROPDOWNID IN (
			SELECT DropDownIdID
			FROM #TempActivityConsole1
			)

	INSERT INTO @SourceTable
	SELECT DT.DeliverableName
		,DQ.DeliverableQueueName
		,ClientManagerUsers = (
			SELECT RTRIM((
						CASE 
							WHEN (ISNULL(LTRIM(RTRIM(LastName)), '') = '')
								THEN ''
							ELSE LTRIM(RTRIM(LastName))
							END
						) + (
						CASE 
							WHEN (ISNULL(LTRIM(RTRIM(FirstName)), '') = '')
								THEN ''
							ELSE (', ' + LTRIM(RTRIM(FirstName)))
							END
						) + ' ' + ISNULL(LTRIM(RTRIM(MiddleName)), ''))
			FROM TBL_KS_User
			WHERE UserID = SRClientManager.userid
			)
		,VAC.CLIENT_BRIEFNAME AS ClientBriefName
		,ReportAnalystUsers = (
			SELECT RTRIM((
						CASE 
							WHEN (ISNULL(LTRIM(RTRIM(LastName)), '') = '')
								THEN ''
							ELSE LTRIM(RTRIM(LastName))
							END
						) + (
						CASE 
							WHEN (ISNULL(LTRIM(RTRIM(FirstName)), '') = '')
								THEN ''
							ELSE (', ' + LTRIM(RTRIM(FirstName)))
							END
						) + ' ' + ISNULL(LTRIM(RTRIM(MiddleName)), ''))
			FROM TBL_KS_User
			WHERE UserID = SRReportAnalyst.userid
			)
		,VAC.AccountType AS AccountType
		,ISNULL(b.DropDownText, '') AS SendTo
		,DQ.DeliverableQueueID
		,DI.DeliverableItemID
		,IMS.DeliverableItemStatusID
		,DIS.statusname
		,b.DropDownIdID
		,(
			SELECT DISTINCT RoleFullName
			FROM VW_EX_UserRole
			WHERE RoleID = DT.OwnerRoleID
			) AS OwnerRoleID
		,(
			SELECT DISTINCT ContactName
			FROM SYN_IT_ContactMaster
			WHERE ContactID = DT.[OwnerID]
			) AS OwnerRole
	FROM TBL_DLV_DeliverableQueue DQ
	INNER JOIN TBL_DLV_QueueStatus QS ON DQ.QueueStatusID = QS.QueueStatusID
	INNER JOIN TBL_DLV_DeliverableItem DI ON DQ.DeliverableQueueID = DI.DeliverableQueueID
	INNER JOIN VW_EX_Account VAC ON DI.CustomerAccountNumber = VAC.AccountID --ET# 10447  
	INNER JOIN TBL_DLV_ItemMethodStatus IMS ON DI.DeliverableItemID = IMS.DeliverableItemID
	INNER JOIN TBL_DLV_DeliverableMethod TM ON IMS.DeliveryMethodID = TM.DeliveryMethodID
		AND TM.IsPrimary = 1
		AND TM.DeliverableID = (
			SELECT DeliverableID
			FROM TBL_DLV_DeliverableQueue
			WHERE DeliverableQueueID = @DeliverableQueueID
			) -- TO get Primary Record  
	INNER JOIN TBL_DLV_DeliverableProcessStatus DIS ON IMS.DeliverableItemStatusID = DIS.DeliverableItemStatusID
	INNER JOIN #TempActivityConsoleSendTo AS b ON DI.CustomerAccountNumber = b.OWNERID
		AND policylevel = 300
	INNER JOIN TBL_DLV_Deliverable DT ON DQ.DeliverableID = DT.DeliverableID
	LEFT OUTER JOIN VW_EX_UserRole SRClientManager ON SRClientManager.ManagerCode = VAC.CLIENTID AND SRClientManager.RoleID = 2
	LEFT OUTER JOIN VW_EX_UserRole SRReportAnalyst ON SRReportAnalyst.ManagerCode = VAC.CLIENTID AND SRReportAnalyst.RoleID = 519
	WHERE (
			@DeliverableID = 0
			OR DQ.DeliverableID = @DeliverableID
			)
		AND (
			@DeliverableQueueID = 0
			OR DI.DeliverableQueueID = @DeliverableQueueID
			)
		AND (
			@StatusIDs = '0'
			OR (CHARINDEX(',' + CONVERT(VARCHAR(10), DQ.QueueStatusID) + ',', ',' + @StatusIDs + ',') > 0)
			)
		AND (
			@ClientIDs = '0'
			OR (CHARINDEX(',' + CONVERT(VARCHAR(10), DI.ManagerCode) + ',', ',' + @ClientIDs + ',') > 0)
			)
		AND (
			DATEDIFF(DAY, @FromDate, '01/01/1900') = 0
			OR DQ.DeliverableEndDate >= @FromDate
			)
		AND (
			DATEDIFF(DAY, @ToDate, '01/01/1900') = 0
			OR DQ.DeliverableEndDate <= @ToDate
			)
		AND (
			@ReportOwners = 0
			OR SRReportAnalyst.UserID = @ReportOwners
			)
		AND (
			@OwnerRole = 0
			OR DT.OwnerRoleID = @OwnerRole
			)

	INSERT INTO @SourceTable
	SELECT DT.DeliverableName
		,DQ.DeliverableQueueName
		,ClientManagerUsers = (
			SELECT RTRIM((
						CASE 
							WHEN (ISNULL(LTRIM(RTRIM(LastName)), '') = '')
								THEN ''
							ELSE LTRIM(RTRIM(LastName))
							END
						) + (
						CASE 
							WHEN (ISNULL(LTRIM(RTRIM(FirstName)), '') = '')
								THEN ''
							ELSE (', ' + LTRIM(RTRIM(FirstName)))
							END
						) + ' ' + ISNULL(LTRIM(RTRIM(MiddleName)), ''))
			FROM TBL_KS_User
			WHERE UserID = SRClientManager.userid
			)
		,VAC.CLIENT_BRIEFNAME AS ClientBriefName
		,ReportAnalystUsers = (
			SELECT RTRIM((
						CASE 
							WHEN (ISNULL(LTRIM(RTRIM(LastName)), '') = '')
								THEN ''
							ELSE LTRIM(RTRIM(LastName))
							END
						) + (
						CASE 
							WHEN (ISNULL(LTRIM(RTRIM(FirstName)), '') = '')
								THEN ''
							ELSE (', ' + LTRIM(RTRIM(FirstName)))
							END
						) + ' ' + ISNULL(LTRIM(RTRIM(MiddleName)), ''))
			FROM TBL_KS_User
			WHERE UserID = SRReportAnalyst.userid
			)
		,VAC.AccountType AS AccountType
		,ISNULL(b.DropDownText, '') AS SendTo
		,DQ.DeliverableQueueID
		,DI.DeliverableItemID
		,0 AS DeliverableItemStatusID
		,'On Hold' AS statusname
		,b.DropDownIdID
		,(
			SELECT DISTINCT RoleFullName
			FROM VW_EX_UserRole
			WHERE RoleID = DT.OwnerRoleID
		) AS OwnerRoleID
		,(
			SELECT DISTINCT ContactName
			FROM SYN_IT_ContactMaster
			WHERE ContactID = DT.[OwnerID]
		) AS OwnerRole
	FROM TBL_DLV_DeliverableQueue DQ
	INNER JOIN TBL_DLV_QueueStatus QS ON DQ.QueueStatusID = QS.QueueStatusID
	INNER JOIN TBL_DLV_DeliverableItem DI ON DQ.DeliverableQueueID = DI.DeliverableQueueID
	INNER JOIN TBL_DLV_DeliverableItemDeliverableTypeAttribute DIA ON DI.DeliverableItemID = DIA.DeliverableItemID
	INNER JOIN VW_EX_Account VAC ON DI.CustomerAccountNumber = VAC.AccountID --ET# 10447 
	INNER JOIN #TempActivityConsoleSendTo AS b ON DI.CustomerAccountNumber = b.OWNERID
		AND policylevel = 300
	INNER JOIN TBL_DLV_Deliverable DT ON DQ.DeliverableID = DT.DeliverableID
	LEFT OUTER JOIN VW_EX_UserRole SRClientManager ON SRClientManager.ManagerCode = VAC.CLIENTID AND SRClientManager.RoleID = 2
	LEFT OUTER JOIN VW_EX_UserRole SRReportAnalyst ON SRReportAnalyst.ManagerCode = VAC.CLIENTID AND SRReportAnalyst.RoleID = 519
	WHERE (
			@DeliverableID = 0
			OR DQ.DeliverableID = @DeliverableID
			)
		AND (
			@DeliverableQueueID = 0
			OR DI.DeliverableQueueID = @DeliverableQueueID
			)
		AND DIA.DeliverableTypeAttributeID = (
			SELECT DeliverableTypeAttributeID
			FROM TBL_DLV_DeliverableTypeAttribute
			WHERE AttributePromptName = 'Hold'
				AND DeliverableID = @DeliverableID
			)
		AND AttributeValue = '1'
		AND (
			@StatusIDs = '0'
			OR (CHARINDEX(',' + CONVERT(VARCHAR(10), DQ.QueueStatusID) + ',', ',' + @StatusIDs + ',') > 0)
			)
		AND (
			@ClientIDs = '0'
			OR (CHARINDEX(',' + CONVERT(VARCHAR(10), DI.ManagerCode) + ',', ',' + @ClientIDs + ',') > 0)
			)
		AND (
			DATEDIFF(DAY, @FromDate, '01/01/1900') = 0
			OR DQ.DeliverableEndDate >= @FromDate
			)
		AND (
			DATEDIFF(DAY, @ToDate, '01/01/1900') = 0
			OR DQ.DeliverableEndDate <= @ToDate
			)
		AND (
			@ReportOwners = 0
			OR SRReportAnalyst.UserID = @ReportOwners
			)
		AND (
			@OwnerRole = 0
			OR DT.OwnerRoleID = @OwnerRole
			)

	INSERT INTO #DT_MC_ITEM (
		DeliverableQueueID
		,DeliverableName
		,QueueName
		,ClientManagerUsers
		,ClientBriefName
		,ReportAnalystUsers
		,AccountType
		,SendTo
		,Scheduled
		,Error
		,Generated
		,Published
		,Cancelled
		,WebPublished
		,Printed
		,Reviewed
		,PrintoutMailed
		,OnHold
		,TotalOfReports
		,DropDownIdID
		,OWNER_ROLE
		,REPORT_OWNER
		) (
		SELECT DeliverableQueueID
		,DeliverableName
		,QueueName
		,ClientManagerUsers
		,ClientBriefName
		,ReportAnalystUsers
		,AccountType
		,SendTo
		,Scheduled AS 'Scheduled'
		,Error AS 'Error'
		,Generated AS 'Generated'
		,Published AS 'Published'
		,Cancelled AS 'Cancelled'
		,[Web Published] AS 'WebPublished'
		,Printed AS 'Printed'
		,Reviewed AS 'Reviewed'
		,[Printout Mailed] AS 'PrintoutMailed'
		,[On Hold] AS 'OnHold'
		,Scheduled + Error + Generated + Published + Cancelled + [Web Published] + Printed + Reviewed + [Printout Mailed] AS 'TotalOfReports'
		,DropDownIdID
		,OWNER_ROLE
		,REPORT_OWNER FROM @SourceTable PIVOT(COUNT(DeliverableItemID) FOR statusname IN (
				Scheduled
				,Error
				,Generated
				,Published
				,Cancelled
				,[Web Published]
				,Printed
				,Reviewed
				,[Printout Mailed]
				,[On Hold]
				,[Release From Hold]
				)) AS pvt
		)
END
GO

IF EXISTS (
		SELECT *
		FROM sysobjects
		WHERE type = 'P'
			AND NAME = 'USP_RP_GetBRDTManagementConsole'
		)
BEGIN
	PRINT 'CREATED USP_RP_GetBRDTManagementConsole';
END