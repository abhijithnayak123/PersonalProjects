IF EXISTS (
		SELECT *
		FROM sys.objects
		WHERE object_id = OBJECT_ID(N'[dbo].[USP_EIS_IRS_Missing_Donor_Name_Info]')
			AND type IN (
				N'P'
				,N'PC'
				)
		)
	DROP PROCEDURE [dbo].[USP_EIS_IRS_Missing_Donor_Name_Info]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER OFF
GO

/******************************************************************************      
** Name:     USP_EIS_IRS_Missing_Donor_Name_Info      
** Short Desc:  SELECTS ALL Missing Donor Name information   
**      
** Full Description      
**        SELECTS ALL Missing Donor Name information     
**      
** Sample Call       
**     EXEC USP_EIS_IRS_Missing_Donor_Name_Info 2008, 'SM' ,'' 
**      
**      
** Standard declarations      
**       SET LOCK_TIMEOUT         30000   -- 30 seconds      
**       
** Created By: Asit Kar      
** Company   : Ciber offshore      
** Project   : BOI Reports & Queries     
** Created DT: 05/09/2014      
**                  
*******************************************************************************      
**       Change History      
*******************************************************************************      
** Date:        Author:  Bug #     Description:                           Rvwd      
** --------     -------- ------    -------------------------------------- --------      
** <mm/dd/yyyy>      
*******************************************************************************      
** Copyright (Clnt) 2014, Kaspick & Company, All Rights Reserved      
** COMPANY CONFIDENTIAL -- NOT FOR DISTRIBUTION      
*******************************************************************************/
CREATE PROCEDURE [dbo].[USP_EIS_IRS_Missing_Donor_Name_Info] (
	@Tax_YEAR INT
	,@CLIENT_BRIEF_NAME VARCHAR(10)
	,@ADVENT_ID VARCHAR(10)
	)
AS
BEGIN
	IF RTRIM(LTRIM(@CLIENT_BRIEF_NAME)) <> ''
		AND RTRIM(LTRIM(@ADVENT_ID)) <> ''
	BEGIN
		SELECT KCO_CM.ManagerCode AS CLIENTBRIEFNAME
			,DefGiftAct.ADVENTID
			,DefGiftAct.ACCOUNTTYPE
			,DefGiftAct.FIRSTTAXYEAR
			,DefGiftAct.LASTTAXYEAR
			,TrstPrtcpt.FIRSTNAME
			,TrstPrtcpt.LASTNAME
			,TrstPrtcpt.PARTICIPANTID
			,Dnr.DONORID
			,KCO_CM.STAFFNAME AS 'CLIENT MANAGER'
			,KCO_TA.STAFFNAME AS 'TRUST ADMINISTRATOR'
		FROM SYN_EP_Donor Dnr
		INNER JOIN SYN_EP_DEFERREDGIFTACCOUNT DefGiftAct
			ON Dnr.ACCOUNTID = DefGiftAct.ACCOUNTID
		INNER JOIN SYN_EP_TRUSTPARTICIPANT TrstPrtcpt
			ON Dnr.PARTICIPANTID = TrstPrtcpt.PARTICIPANTID
		INNER JOIN SYN_EP_Program Prgm
			ON DefGiftAct.PROGRAMID = Prgm.PROGRAMID
		INNER JOIN SYN_EP_Client Clnt
			ON Clnt.CLIENTID = Prgm.CLIENTID
		LEFT OUTER JOIN SYN_KD_VW_KS_SysAdminKCoStaffPaging KCO_TA
			ON Clnt.BriefName = KCO_TA.ManagerCode
				AND KCO_TA.RoleCode = 510 -- 'Trust Administrator'
		LEFT OUTER JOIN SYN_KD_VW_KS_SysAdminKCoStaffPaging KCO_CM
			ON Clnt.BriefName = KCO_CM.ManagerCode
				AND KCO_CM.RoleCode = 14 -- 'Client Manager'
		WHERE (
				FIRSTTAXYEAR IS NOT NULL
				OR FIRSTTAXYEAR <> ''
				)
			AND (
				LASTTAXYEAR = @Tax_YEAR
				OR LASTTAXYEAR = ''
				OR @Tax_YEAR IS NULL
				)
			AND (
				(
					LTRIM(RTRIM(TrstPrtcpt.FIRSTNAME)) = ''
					OR TrstPrtcpt.FIRSTNAME IS NULL
					)
				OR (
					LTRIM(RTRIM(TrstPrtcpt.LASTNAME)) = ''
					OR TrstPrtcpt.LASTNAME IS NULL
					)
				)
			AND DefGiftAct.ACCOUNTTYPE NOT IN (
				'GRANTOR-OWNER'
				,'TMC-BRANCH'
				,'990'
				,'PIF'
				)
			AND Clnt.BRIEFNAME = @CLIENT_BRIEF_NAME
			AND DefGiftAct.ADVENTID = @ADVENT_ID
		ORDER BY DefGiftAct.ADVENTID
			,TrstPrtcpt.LASTNAME
	END
	ELSE
		IF RTRIM(LTRIM(@CLIENT_BRIEF_NAME)) <> ''
			AND RTRIM(LTRIM(@ADVENT_ID)) = ''
		BEGIN
			SELECT KCO_CM.ManagerCode AS CLIENTBRIEFNAME
				,DefGiftAct.ADVENTID
				,DefGiftAct.ACCOUNTTYPE
				,DefGiftAct.FIRSTTAXYEAR
				,DefGiftAct.LASTTAXYEAR
				,TrstPrtcpt.FIRSTNAME
				,TrstPrtcpt.LASTNAME
				,TrstPrtcpt.PARTICIPANTID
				,Dnr.DONORID
				,KCO_CM.STAFFNAME AS 'CLIENT MANAGER'
				,KCO_TA.STAFFNAME AS 'TRUST ADMINISTRATOR'
			FROM SYN_EP_Donor Dnr
			INNER JOIN SYN_EP_DEFERREDGIFTACCOUNT DefGiftAct
				ON Dnr.ACCOUNTID = DefGiftAct.ACCOUNTID
			INNER JOIN SYN_EP_TRUSTPARTICIPANT TrstPrtcpt
				ON Dnr.PARTICIPANTID = TrstPrtcpt.PARTICIPANTID
			INNER JOIN SYN_EP_Program Prgm
				ON DefGiftAct.PROGRAMID = Prgm.PROGRAMID
			INNER JOIN SYN_EP_Client Clnt
				ON Clnt.CLIENTID = Prgm.CLIENTID
			LEFT OUTER JOIN SYN_KD_VW_KS_SysAdminKCoStaffPaging KCO_TA
				ON Clnt.BriefName = KCO_TA.ManagerCode
					AND KCO_TA.RoleCode = 510 -- 'Trust Administrator'
			LEFT OUTER JOIN SYN_KD_VW_KS_SysAdminKCoStaffPaging KCO_CM
				ON Clnt.BriefName = KCO_CM.ManagerCode
					AND KCO_CM.RoleCode = 14 -- 'Client Manager'
			WHERE (
					FIRSTTAXYEAR IS NOT NULL
					OR FIRSTTAXYEAR <> ''
					)
				AND (
					LASTTAXYEAR = @Tax_YEAR
					OR LASTTAXYEAR = ''
					OR @Tax_YEAR IS NULL
					)
				AND (
					(
						LTRIM(RTRIM(TrstPrtcpt.FIRSTNAME)) = ''
						OR TrstPrtcpt.FIRSTNAME IS NULL
						)
					OR (
						LTRIM(RTRIM(TrstPrtcpt.LASTNAME)) = ''
						OR TrstPrtcpt.LASTNAME IS NULL
						)
					)
				AND DefGiftAct.ACCOUNTTYPE NOT IN (
					'GRANTOR-OWNER'
					,'TMC-BRANCH'
					,'990'
					,'PIF'
					)
				AND Clnt.BRIEFNAME = @CLIENT_BRIEF_NAME
			ORDER BY DefGiftAct.ADVENTID
				,TrstPrtcpt.LASTNAME
		END
		ELSE
			IF RTRIM(LTRIM(@CLIENT_BRIEF_NAME)) = ''
				AND RTRIM(LTRIM(@ADVENT_ID)) <> ''
			BEGIN
				SELECT KCO_CM.ManagerCode AS CLIENTBRIEFNAME
					,DefGiftAct.ADVENTID
					,DefGiftAct.ACCOUNTTYPE
					,DefGiftAct.FIRSTTAXYEAR
					,DefGiftAct.LASTTAXYEAR
					,TrstPrtcpt.FIRSTNAME
					,TrstPrtcpt.LASTNAME
					,TrstPrtcpt.PARTICIPANTID
					,Dnr.DONORID
					,KCO_CM.STAFFNAME AS 'CLIENT MANAGER'
					,KCO_TA.STAFFNAME AS 'TRUST ADMINISTRATOR'
				FROM SYN_EP_Donor Dnr
				INNER JOIN SYN_EP_DEFERREDGIFTACCOUNT DefGiftAct
					ON Dnr.ACCOUNTID = DefGiftAct.ACCOUNTID
				INNER JOIN SYN_EP_TRUSTPARTICIPANT TrstPrtcpt
					ON Dnr.PARTICIPANTID = TrstPrtcpt.PARTICIPANTID
				INNER JOIN SYN_EP_Program Prgm
					ON DefGiftAct.PROGRAMID = Prgm.PROGRAMID
				INNER JOIN SYN_EP_Client Clnt
					ON Clnt.CLIENTID = Prgm.CLIENTID
				LEFT OUTER JOIN SYN_KD_VW_KS_SysAdminKCoStaffPaging KCO_TA
					ON Clnt.BriefName = KCO_TA.ManagerCode
						AND KCO_TA.RoleCode = 510 -- 'Trust Administrator'
				LEFT OUTER JOIN SYN_KD_VW_KS_SysAdminKCoStaffPaging KCO_CM
					ON Clnt.BriefName = KCO_CM.ManagerCode
						AND KCO_CM.ROLENAME = 14 -- 'Client Manager'
				WHERE (
						FIRSTTAXYEAR IS NOT NULL
						OR FIRSTTAXYEAR <> ''
						)
					AND (
						LASTTAXYEAR = @Tax_YEAR
						OR LASTTAXYEAR = ''
						OR @Tax_YEAR IS NULL
						)
					AND (
						(
							LTRIM(RTRIM(TrstPrtcpt.FIRSTNAME)) = ''
							OR TrstPrtcpt.FIRSTNAME IS NULL
							)
						OR (
							LTRIM(RTRIM(TrstPrtcpt.LASTNAME)) = ''
							OR TrstPrtcpt.LASTNAME IS NULL
							)
						)
					AND DefGiftAct.ACCOUNTTYPE NOT IN (
						'GRANTOR-OWNER'
						,'TMC-BRANCH'
						,'990'
						,'PIF'
						)
					AND DefGiftAct.ADVENTID = @ADVENT_ID
				ORDER BY DefGiftAct.ADVENTID
					,TrstPrtcpt.LASTNAME
			END
			ELSE
				IF RTRIM(LTRIM(@CLIENT_BRIEF_NAME)) = ''
					AND RTRIM(LTRIM(@ADVENT_ID)) = ''
				BEGIN
					SELECT KCO_CM.ManagerCode AS CLIENTBRIEFNAME
						,DefGiftAct.ADVENTID
						,DefGiftAct.ACCOUNTTYPE
						,DefGiftAct.FIRSTTAXYEAR
						,DefGiftAct.LASTTAXYEAR
						,TrstPrtcpt.FIRSTNAME
						,TrstPrtcpt.LASTNAME
						,TrstPrtcpt.PARTICIPANTID
						,Dnr.DONORID
						,KCO_CM.STAFFNAME AS 'CLIENT MANAGER'
						,KCO_TA.STAFFNAME AS 'TRUST ADMINISTRATOR'
					FROM SYN_EP_Donor Dnr
					INNER JOIN SYN_EP_DEFERREDGIFTACCOUNT DefGiftAct
						ON Dnr.ACCOUNTID = DefGiftAct.ACCOUNTID
					INNER JOIN SYN_EP_TRUSTPARTICIPANT TrstPrtcpt
						ON Dnr.PARTICIPANTID = TrstPrtcpt.PARTICIPANTID
					INNER JOIN SYN_EP_Program Prgm
						ON DefGiftAct.PROGRAMID = Prgm.PROGRAMID
					INNER JOIN SYN_EP_Client Clnt
						ON Clnt.CLIENTID = Prgm.CLIENTID
					LEFT OUTER JOIN SYN_KD_VW_KS_SysAdminKCoStaffPaging KCO_TA
						ON Clnt.BriefName = KCO_TA.ManagerCode
							AND KCO_TA.RoleCode = 510 -- 'Trust Administrator'
					LEFT OUTER JOIN SYN_KD_VW_KS_SysAdminKCoStaffPaging KCO_CM
						ON Clnt.BriefName = KCO_CM.ManagerCode
							AND KCO_CM.RoleCode = 14 -- 'Client Manager'
					WHERE (
							FIRSTTAXYEAR IS NOT NULL
							OR FIRSTTAXYEAR <> ''
							)
						AND (
							LASTTAXYEAR = @Tax_YEAR
							OR LASTTAXYEAR = ''
							OR @Tax_YEAR IS NULL
							)
						AND (
							(
								LTRIM(RTRIM(TrstPrtcpt.FIRSTNAME)) = ''
								OR TrstPrtcpt.FIRSTNAME IS NULL
								)
							OR (
								LTRIM(RTRIM(TrstPrtcpt.LASTNAME)) = ''
								OR TrstPrtcpt.LASTNAME IS NULL
								)
							)
						AND DefGiftAct.ACCOUNTTYPE NOT IN (
							'GRANTOR-OWNER'
							,'TMC-BRANCH'
							,'990'
							,'PIF'
							)
					ORDER BY DefGiftAct.ADVENTID
						,TrstPrtcpt.LASTNAME
				END
END
GO


