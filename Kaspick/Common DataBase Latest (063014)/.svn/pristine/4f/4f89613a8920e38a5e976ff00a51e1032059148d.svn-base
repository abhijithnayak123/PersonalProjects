/****** Object:  StoredProcedure [dbo].[USP_KCO_PaymentCondition]    Script Date: 06/26/2013 16:48:51 ******/
IF EXISTS (
		SELECT 1
		FROM sys.objects
		WHERE object_id = OBJECT_ID(N'[dbo].[USP_KCO_PaymentCondition]')
			AND type IN (
				N'P'
				,N'PC'
				)
		)
	DROP PROCEDURE [dbo].[USP_KCO_PaymentCondition]
GO

/****** Object:  StoredProcedure [dbo].[USP_KCO_PaymentCondition]    Script Date: 06/26/2013 16:48:51 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/******************************************************************************                      
** Name		 : USP_KCO_PaymentCondition                      
** Short Desc: Get the TSheet details from table TBL_TR_Event for the specified EventID
**                      
** Full Description: Get the TSheet details from table TBL_TR_Event for the specified EventID
**      
**                              
** Input Arguments:   
**	
**	            
** Sample Call     

 EXEC USP_KCO_PaymentCondition 'Beneficiary'
**             
**                      
**                      
** Standard declarations                      
**       SET LOCK_TIMEOUT         30000   -- 30 seconds                      
**                       
** Created By: Mohamed Salih 
** Company   : Kaspick & Company                      
** Project   : BackOffice Integration                      
** Created DT: 27-Mar-14               
**                                  
*******************************************************************************                
**       Change History                      
*******************************************************************************                
** Date:      Author:	 Bug #     Description:                           
** --------  --------	 ------    -------------------------------------- 
** 
***
*******************************************************************************                      
** Copyright (C) <CopyrightYear,,Year> Kaspick & Company, All Rights Reserved                      
** COMPANY CONFIDENTIAL -- NOT FOR DISTRIBUTION                      
*******************************************************************************/
CREATE PROCEDURE [dbo].[USP_KCO_PaymentCondition] (@EntityType VARCHAR(15))
AS
BEGIN
	--  Initial Set statements  --    
	SET NOCOUNT ON;
	SET LOCK_TIMEOUT 30000;-- 30 seconds 

	IF @EntityType = 'Client'
	BEGIN
		--Client  
		SELECT DISTINCT CntctMstr.ManagerCode AS 'Manager Code'
			,CntctMstr.ContactName AS LegalName
			,ListItm.ListItemName AS ClientStatus
			,PymtCond.AccountType AS AccountType
			,isnull(PymtCond.Comments, '') AS PaymentNotes
			,StaffCM.StaffName AS CM
			,staffTA.StaffName AS TA
		FROM TBL_PP_PaymentCondition PymtCond
		INNER JOIN SYN_IT_ContactMaster CntctMstr
			ON PymtCond.ManagerCode = CntctMstr.ManagerCode
		INNER JOIN TBL_ListItem ListItm
			ON ListItm.ListItemID = PymtCond.StatusID
				AND ListItm.ListItemName = 'Active'
		LEFT OUTER JOIN VW_KS_ExSysadminKCOStaffPaging StaffCM
			ON StaffCM.ManagerCode = CntctMstr.ManagerCode
				AND StaffCM.RoleName = 'Client Manager'
				AND StaffCM.RELATIONSHIP = 1 -- Primary
		LEFT OUTER JOIN VW_KS_ExSysadminKCOStaffPaging StaffTA
			ON StaffTA.ManagerCode = CntctMstr.ManagerCode
				AND StaffTA.RoleName = 'Trust Administrator'
				AND StaffTA.Relationship = 1 -- Primary
		WHERE PymtCond.EntityTypeId = 1
	END
	ELSE
		IF @EntityType = 'Account'
		BEGIN --Account  
			SELECT PymtCond.ManagerCode AS 'Manager Code'
				,PymtCond.CustomerAccountNumber AS 'Customer Account Number'
				,ListItm.ListItemName AS 'Account Status'
				,isnull(PymtCond.Comments, '') AS 'Payment Notes'
				,StaffCM.StaffName AS CM
				,StaffTA.StaffName AS TA
			FROM TBL_PP_PaymentCondition PymtCond
			INNER JOIN TBL_ListItem ListItm
				ON ListItm.ListItemID = PymtCond.StatusID
			LEFT OUTER JOIN VW_KS_ExSysadminKCOStaffPaging StaffCM
				ON StaffCM.ManagerCode = PymtCond.ManagerCode
					AND StaffCM.RoleName = 'Client Manager'
					AND StaffCM.RELATIONSHIP = 1 -- Primary
			LEFT OUTER JOIN VW_KS_ExSysadminKCOStaffPaging StaffTA
				ON StaffTA.ManagerCode = PymtCond.ManagerCode
					AND StaffTA.RoleName = 'Trust Administrator'
					AND StaffTA.Relationship = 1 -- Primary
			WHERE PymtCond.EntityTypeId = 187
				AND ListItm.ListItemName = 'Active'
		END
		ELSE
			IF @EntityType = 'Beneficiary'
			BEGIN
				DECLARE @EntityTypeID INT

				SELECT @EntityTypeID = ListItemID
				FROM TBL_ListItem
				WHERE ListItemName = 'Contact'

				SELECT PymntCond.ManagerCode AS 'Manager Code'
					,PymntCond.CustomerAccountNumber AS 'Customer Account Number'
					,PymntCond.ContactID AS 'Contact ID'
					,PymntCond.ContactRoleCode AS 'Contact Role Code'
					,isnull(CntctMstr.PrimaryPrefix, '') AS Salutation
					,isnull(CntctMstr.PrimaryFirstName, '') AS FirstName
					,isnull(CntctMstr.PrimaryLastName, '') AS LastName
					,isnull(CntctMstr.PrimaryMiddleInitial, '') AS MiddleInitials
					,isnull(convert(VARCHAR(10), CntctMstr.DateOfBirth, 101), '') AS DOB
					,isnull(convert(VARCHAR(10), CntctMstr.DateOfDeath, 101), '') AS DOD
					,LIConditionStatus.ListItemName AS ContactType
					,isnull(PymntCond.Comments, '') AS PaymentNotes
					,staffCM.StaffName AS CM
					,staffTA.StaffName AS TA
				FROM TBL_PP_PaymentCondition PymntCond
				INNER JOIN SYN_IT_ContactMaster CntctMstr
					ON CntctMstr.ContactID = PymntCond.ContactID
				INNER JOIN TBL_ListItem LIConditionStatus
					ON LIConditionStatus.ListItemID = PymntCond.StatusID --='Active'  
					LEFT OUTER JOIN VW_KS_ExSysadminKCOStaffPaging StaffCM
					ON StaffCM.ManagerCode = CntctMstr.ManagerCode
						AND StaffCM.RoleName = 'Client Manager'
						AND StaffCM.RELATIONSHIP = 1 -- Primary
				LEFT OUTER JOIN VW_KS_ExSysadminKCOStaffPaging StaffTA
					ON StaffTA.ManagerCode = CntctMstr.ManagerCode
						AND StaffTA.RoleName = 'Trust Administrator'
						AND StaffTA.Relationship = 1 -- Primary
				WHERE PymntCond.EntityTypeId = @EntityTypeID
					AND LIConditionStatus.ListItemName = 'Active'
			END

	SET NOCOUNT OFF;
END
