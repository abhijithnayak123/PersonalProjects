GO
IF EXISTS (SELECT *
           FROM   sysobjects 
           WHERE  type = 'P'
                  AND name = 'USP_EIS_RPT_BR_VE_DR_DataloadTransactions_SelProc')
    BEGIN
        DROP PROCEDURE USP_EIS_RPT_BR_VE_DR_DataloadTransactions_SelProc;
        PRINT 'DROPPED USP_EIS_RPT_BR_VE_DR_DataloadTransactions_SelProc';
    END
GO
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
/******************************************************************************                    
** Name:     USP_EIS_RPT_BR_VE_DR_DataloadTransactions_SelProc                    
** Short Desc: Retrieves the number of days difference between TLAsofDate_Date  
    and dtStartDate.     
**                    
** Full Description:   
    Rule Implemented for CR #11008  
 If the date TLAsofDate_Date > dtStartDate, the function DATEDIFF(day,DPDL.TLAsofDate_Date,DPDL.dtStartDate)  
    returns the value less than zero.    
**                            
** Input Arguments:   
**       
** Sample Call   
**    
 DECLARE @XMLDeliverableItems XML  
    SET @XMLDeliverableItems ='<DeliverableItemsDataToValidateCollection><InsertList></InsertList><UpdateList></UpdateList>  
 <DeleteList></DeleteList><SelectList><DeliverableItemsDataToValidate AccountID="446"    
 BeneficiaryID="645"  ClientEmployeeID="0"  Clientid="1"  DeliverableItemID="3"  DeliverableQueueID="1"    
 DonorID="0"  TrustparticipantID="27"  /></SelectList></DeliverableItemsDataToValidateCollection>'   
 EXEC USP_EIS_RPT_BR_VE_DR_DataloadTransactions_SelProc  
    @XMLDeliverableItems  
   
   
**           
** Return values: Null  
**                    
**                    
** Standard declarations                    
**       SET LOCK_TIMEOUT         30000   -- 30 seconds                    
**                     
** Created By: Venugopal B  
** Company   : Kaspick & Company                    
** Project   : Excelsior  - BeneReport                    
** Created DT: 12/09/2009                    
**                                
*******************************************************************************              
**       Change History                    
*******************************************************************************              
** Date:        Author:  Bug #     Description:                           Rvwd              
** --------  -------- ------    -------------------------------------- --------              
** 01/20/2010   VENU           Value for DisplayMessage is updated.         
** 07/23/2014   Geervani       Changed table TBL_EIS_DT_STG_Detect_PostDataLoad to TBL_DLV_STG_DetectPostDataLoad (KaspickDB) 
							   as and joined with V_EIS_EX_ACCOUNT to get account id from profilestaging db
*******************************************************************************                    
** Copyright (C) <CopyrightYear,,Year> Kaspick & Company, All Rights Reserved                    
** COMPANY CONFIDENTIAL -- NOT FOR DISTRIBUTION                    
*******************************************************************************/                    
CREATE PROCEDURE [dbo].[USP_EIS_RPT_BR_VE_DR_DataloadTransactions_SelProc]        
 -- paremeters here        
 @XMLDeliverableItems xml  
AS        
	 --  Initial SET statements  --        
	 --SET NOCOUNT ON;        
	 --SET LOCK_TIMEOUT                30000;   -- 30 seconds        
	 --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;        

	--  Variable Declarations  --        
	DECLARE @procname   VARCHAR(60);        
	DECLARE @errmsg     VARCHAR(1000);        
	DECLARE @errnbr     INT;   

	-- Variables used for error handling - uncomment if needed        
	DECLARE @val1      VARCHAR(30);        
	DECLARE @val2      VARCHAR(30);        

	--  Temp tables, Cursors, Table Variables  --        
	DECLARE @DeliverableItemData Table  
	(      
	DeliverableItemID INT,  
	AccountID INT,         
	DeliverableQueueID INT             
	);  

	--  Variable Data Assignment  --        
	SET @procname = 'USP_EIS_RPT_BR_VE_DR_DataloadTransactions_SelProc';        

	-- Body of procedure  --        
	BEGIN TRY        
		INSERT INTO @DeliverableItemData      
		SELECT        
		XMLdoc.DeliverableItemData.value('@DeliverableItemID[1]', 'INT') AS DeliverableItemID,      
		XMLdoc.DeliverableItemData.value('@AccountID[1]', 'INT') AS AccountID,      
		XMLdoc.DeliverableItemData.value('@DeliverableQueueID[1]', 'INT') AS DeliverableQueueID                  
		FROM @XMLDeliverableItems.nodes('//DeliverableItemsDataToValidateCollection/SelectList/DeliverableItemsDataToValidate') AS XMLdoc(DeliverableItemData)  

		SELECT  
		DID.DeliverableItemID,       
		7 AS RuleID, 'DataLoadDateDifference' as Attribute,  
		(CASE WHEN ISNULL(DPDL.TLAsofDate_Date,0) = 0 OR ISNULL(DPDL.dtStartDate,0) = 0 THEN 1000  
		ELSE DATEDIFF(day,DPDL.TLAsofDate_Date,DPDL.dtStartDate)  
		END) AS ActualValue,  
		('TLAsofDate_Date = '+(CASE WHEN (ISNULL(DPDL.TLAsofDate_Date,0) = 0) THEN 'Null' ELSE CAST(DPDL.TLAsofDate_Date AS VARCHAR) END)+' and dtStartDate = '+(CASE WHEN (ISNULL(DPDL.dtStartDate,0) = 0) THEN 'Null' ELSE CAST(DPDL.dtStartDate AS VARCHAR) END))
		AS DisplayMessage  
		FROM @DeliverableItemData DID  
		JOIN TBL_EIS_DT_Deliverable_Queue DQ ON DQ.DeliverableQueueID = DID.DeliverableQueueID  
		LEFT OUTER JOIN V_EIS_EX_ACCOUNT LkpAcct  ON DID.AccountID  = LkpAcct.AccountID 
		--LEFT OUTER JOIN (SELECT DISTINCT CustomerAccountNumber,AccountID FROM TBL_Lookup_Account ) LkpAcct  ON DID.AccountID  = LkpAcct.AccountID 
		LEFT JOIN TBL_DLV_STG_DetectPostDataLoad DPDL ON LkpAcct.AdventID = DPDL.CustomerAccountNumber   -- Not changed to Kaspick DB table since AccountID is changed to CustomerAccountNumber
		AND DID.DeliverableQueueID = DPDL.DQueueID    
		AND DATEDIFF(DAY,DQ.DeliverableEndDate,DQEndDate)=0  
	END TRY        
		BEGIN CATCH        
			SET @errmsg = ERROR_MESSAGE();        
			SET @errnbr = ERROR_NUMBER();        
			SET @val1 = '';        
			SET @val2 = '';        

			EXEC dbo.spSYS_ErrorHandler @codename = @procname,        
			@errmsg = @errmsg,         
			@errnbr = @errnbr,        
			@val1 = '',         
			@val1str = 'USP_EIS_RPT_BR_VE_DR_DataloadTransactions_SelProc: Cannot Select.',         
			@val2 = '',         
			@val2str = '';        
		END CATCH        
-- End of procedure  --   
GO


GO
IF EXISTS (	SELECT * FROM sysobjects WHERE type = 'P' AND name = 'USP_EIS_RPT_BR_VE_DR_DataloadTransactions_SelProc') 
	BEGIN
		PRINT 'CREATED PROCEDURE USP_EIS_RPT_BR_VE_DR_DataloadTransactions_SelProc';
	END
