IF EXISTS (
		SELECT *
		FROM sys.objects
		WHERE object_id = OBJECT_ID(N'[dbo].[USP_EIS_IRS_Beneficiary_Last_K1]')
			AND type IN (
				N'P'
				,N'PC'
				)
		)
	DROP PROCEDURE [dbo].[USP_EIS_IRS_Beneficiary_Last_K1]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER OFF
GO

/******************************************************************************      
** Name:     USP_EIS_IRS_Beneficiary_Last_K1      
** Short Desc:  Beneficiary Last K-1 tax year scrub   
**      
** Full Description      
**        Beneficiary Last K-1 tax year scrub     
**      
** Sample Call       
**     EXEC USP_EIS_IRS_Beneficiary_Last_K1 2008, 'SM' ,'' 
**      
**      
** Standard declarations      
**       SET LOCK_TIMEOUT         30000   -- 30 seconds      
**       
** Created By: Asit Kar      
** Company   : Ciber offshore      
** Project   : BOI Reports & Queries     
** Created DT: 05/09/2014      
**                  
*******************************************************************************      
**       Change History      
*******************************************************************************      
** Date:        Author:  Bug #     Description:                           Rvwd      
** --------     -------- ------    -------------------------------------- --------      
** <mm/dd/yyyy>      
*******************************************************************************      
** Copyright (C) 2014, Kaspick & Company, All Rights Reserved      
** COMPANY CONFIDENTIAL -- NOT FOR DISTRIBUTION      
*******************************************************************************/

CREATE PROCEDURE [dbo].[USP_EIS_IRS_Beneficiary_Last_K1] (
	@Tax_YEAR INT
	,@CLIENT_BRIEF_NAME VARCHAR(10)
	,@ADVENT_ID VARCHAR(10)
	)
AS
BEGIN
	IF RTRIM(LTRIM(@CLIENT_BRIEF_NAME)) <> ''
		AND RTRIM(LTRIM(@ADVENT_ID)) <> ''
	BEGIN
		SELECT KCO_CM.ManagerCode AS CLIENTBRIEFNAME
			,DefGiftAct.ADVENTID
			,DefGiftAct.ACCOUNTTYPE
			,DefGiftAct.MATUREDATE
			,TrstPrtcpt.FIRSTNAME
			,TrstPrtcpt.LASTNAME
			,Bene.LASTK1YEAR
			,TrstPrtcpt.[EXPIREDATE]
			,LstItem.LIST_ITEM_NAME AS BENEFICIARYTYPE
			,TrstPrtcpt.PARTICIPANTID
			,Bene.BENEFICIARYID
			,KCO_CM.STAFFNAME AS 'CLIENT MANAGER'
			,KCO_TA.STAFFNAME AS 'TRUST ADMINISTRATOR'
		FROM SYN_EPS_Beneficiary Bene
		INNER JOIN SYN_EPS_TBL_EIS_EX_BENEFICIARY_SUPPLEMENT BS ON Bene.BENEFICIARYID = BS.BENEFICIARYID
		INNER JOIN SYN_EPS_TRUSTPARTICIPANT TrstPrtcpt ON TrstPrtcpt.PARTICIPANTID = Bene.PARTICIPANTID
		INNER JOIN SYN_EPS_DEFERREDGIFTACCOUNT DefGiftAct ON Bene.ACCOUNTID = DefGiftAct.ACCOUNTID
		INNER JOIN SYN_EPS_Program Prgm ON DefGiftAct.PROGRAMID = Prgm.PROGRAMID
		INNER JOIN SYN_EPS_Client Clnt ON Clnt.CLIENTID = Prgm.CLIENTID
		LEFT OUTER JOIN SYN_KDB_VW_KS_SysAdminKCoStaffPaging KCO_TA ON Prgm.BriefName = KCO_TA.ManagerCode
			AND KCO_TA.ROLENAME = 'Trust Administrator'
			AND KCO_TA.RELATIONSHIP = 1
		LEFT OUTER JOIN SYN_KDB_VW_KS_SysAdminKCoStaffPaging KCO_CM ON Prgm.BriefName = KCO_CM.ManagerCode
			AND KCO_CM.ROLENAME = 'Client Manager'
			AND KCO_CM.RELATIONSHIP = 1
		LEFT OUTER JOIN SYN_EPS_TBL_EIS_LIST_ITEM LstItem ON LstItem.LIST_ITEM_ID = BS.PARTICIPANT_HIERARCHY_ID
			AND LstItem.LIST_TYPE_ID = 135
		WHERE Bene.LASTK1YEAR IS NULL
			AND (
				DefGiftAct.MATUREDATE IS NOT NULL
				AND YEAR(DefGiftAct.MATUREDATE) = @Tax_YEAR
				)
			AND (
				TrstPrtcpt.[EXPIREDATE] IS NULL
				OR (
					TrstPrtcpt.[EXPIREDATE] IS NOT NULL
					AND YEAR(TrstPrtcpt.[EXPIREDATE]) = @Tax_YEAR
					)
				)
			AND DefGiftAct.ACCOUNTTYPE NOT IN (
				'CGA'
				,'PIF'
				,'PRIV-EXMT'
				,'PRIV-TAX'
				)
			AND Clnt.BRIEFNAME = @CLIENT_BRIEF_NAME
			AND DefGiftAct.ADVENTID = @ADVENT_ID
		ORDER BY DefGiftAct.ADVENTID
			,TrstPrtcpt.LASTNAME
	END
	ELSE IF RTRIM(LTRIM(@CLIENT_BRIEF_NAME)) <> ''
		AND RTRIM(LTRIM(@ADVENT_ID)) = ''
	BEGIN
		SELECT KCO_CM.ManagerCode AS CLIENTBRIEFNAME
			,DefGiftAct.ADVENTID
			,DefGiftAct.ACCOUNTTYPE
			,DefGiftAct.MATUREDATE
			,TrstPrtcpt.FIRSTNAME
			,TrstPrtcpt.LASTNAME
			,Bene.LASTK1YEAR
			,TrstPrtcpt.[EXPIREDATE]
			,LstItem.LIST_ITEM_NAME AS BENEFICIARYTYPE
			,TrstPrtcpt.PARTICIPANTID
			,Bene.BENEFICIARYID
			,KCO_CM.STAFFNAME AS 'CLIENT MANAGER'
			,KCO_TA.STAFFNAME AS 'TRUST ADMINISTRATOR'
		FROM SYN_EPS_Beneficiary Bene
		INNER JOIN SYN_EPS_TBL_EIS_EX_BENEFICIARY_SUPPLEMENT BS ON Bene.BENEFICIARYID = BS.BENEFICIARYID
		INNER JOIN SYN_EPS_TRUSTPARTICIPANT TrstPrtcpt ON TrstPrtcpt.PARTICIPANTID = Bene.PARTICIPANTID
		INNER JOIN SYN_EPS_DEFERREDGIFTACCOUNT DefGiftAct ON Bene.ACCOUNTID = DefGiftAct.ACCOUNTID
		INNER JOIN SYN_EPS_Program Prgm ON DefGiftAct.PROGRAMID = Prgm.PROGRAMID
		INNER JOIN SYN_EPS_Client Clnt ON Clnt.CLIENTID = Prgm.CLIENTID
		LEFT OUTER JOIN SYN_KDB_VW_KS_SysAdminKCoStaffPaging KCO_TA ON Prgm.BriefName = KCO_TA.ManagerCode
			AND KCO_TA.ROLENAME = 'Trust Administrator'
			AND KCO_TA.RELATIONSHIP = 1
		LEFT OUTER JOIN SYN_KDB_VW_KS_SysAdminKCoStaffPaging KCO_CM ON Prgm.BriefName = KCO_CM.ManagerCode
			AND KCO_CM.ROLENAME = 'Client Manager'
			AND KCO_CM.RELATIONSHIP = 1
		LEFT OUTER JOIN SYN_EPS_TBL_EIS_LIST_ITEM LstItem ON LstItem.LIST_ITEM_ID = BS.PARTICIPANT_HIERARCHY_ID
			AND LstItem.LIST_TYPE_ID = 135
		WHERE Bene.LASTK1YEAR IS NULL
			AND (
				DefGiftAct.MATUREDATE IS NOT NULL
				AND YEAR(DefGiftAct.MATUREDATE) = @Tax_YEAR
				)
			AND (
				TrstPrtcpt.[EXPIREDATE] IS NULL
				OR (
					TrstPrtcpt.[EXPIREDATE] IS NOT NULL
					AND YEAR(TrstPrtcpt.[EXPIREDATE]) = @Tax_YEAR
					)
				)
			AND DefGiftAct.ACCOUNTTYPE NOT IN (
				'CGA'
				,'PIF'
				,'PRIV-EXMT'
				,'PRIV-TAX'
				)
			AND Clnt.BRIEFNAME = @CLIENT_BRIEF_NAME
		ORDER BY DefGiftAct.ADVENTID
			,TrstPrtcpt.LASTNAME
	END
	ELSE IF RTRIM(LTRIM(@CLIENT_BRIEF_NAME)) = ''
		AND RTRIM(LTRIM(@ADVENT_ID)) <> ''
	BEGIN
		SELECT KCO_CM.ManagerCode AS CLIENTBRIEFNAME
			,DefGiftAct.ADVENTID
			,DefGiftAct.ACCOUNTTYPE
			,DefGiftAct.MATUREDATE
			,TrstPrtcpt.FIRSTNAME
			,TrstPrtcpt.LASTNAME
			,Bene.LASTK1YEAR
			,TrstPrtcpt.[EXPIREDATE]
			,LstItem.LIST_ITEM_NAME AS BENEFICIARYTYPE
			,TrstPrtcpt.PARTICIPANTID
			,Bene.BENEFICIARYID
			,KCO_CM.STAFFNAME AS 'CLIENT MANAGER'
			,KCO_TA.STAFFNAME AS 'TRUST ADMINISTRATOR'
		FROM SYN_EPS_Beneficiary Bene
		INNER JOIN SYN_EPS_TBL_EIS_EX_BENEFICIARY_SUPPLEMENT BS ON Bene.BENEFICIARYID = BS.BENEFICIARYID
		INNER JOIN SYN_EPS_TRUSTPARTICIPANT TrstPrtcpt ON TrstPrtcpt.PARTICIPANTID = Bene.PARTICIPANTID
		INNER JOIN SYN_EPS_DEFERREDGIFTACCOUNT DefGiftAct ON Bene.ACCOUNTID = DefGiftAct.ACCOUNTID
		INNER JOIN SYN_EPS_Program Prgm ON DefGiftAct.PROGRAMID = Prgm.PROGRAMID
		LEFT OUTER JOIN SYN_KDB_VW_KS_SysAdminKCoStaffPaging KCO_TA ON Prgm.BriefName = KCO_TA.ManagerCode
			AND KCO_TA.ROLENAME = 'Trust Administrator'
			AND KCO_TA.RELATIONSHIP = 1
		LEFT OUTER JOIN SYN_KDB_VW_KS_SysAdminKCoStaffPaging KCO_CM ON Prgm.BriefName = KCO_CM.ManagerCode
			AND KCO_CM.ROLENAME = 'Client Manager'
			AND KCO_CM.RELATIONSHIP = 1
		LEFT OUTER JOIN SYN_EPS_TBL_EIS_LIST_ITEM LstItem ON LstItem.LIST_ITEM_ID = BS.PARTICIPANT_HIERARCHY_ID
			AND LstItem.LIST_TYPE_ID = 135
		WHERE Bene.LASTK1YEAR IS NULL
			AND (
				DefGiftAct.MATUREDATE IS NOT NULL
				AND YEAR(DefGiftAct.MATUREDATE) = @Tax_YEAR
				)
			AND (
				TrstPrtcpt.[EXPIREDATE] IS NULL
				OR (
					TrstPrtcpt.[EXPIREDATE] IS NOT NULL
					AND YEAR(TrstPrtcpt.[EXPIREDATE]) = @Tax_YEAR
					)
				)
			AND DefGiftAct.ACCOUNTTYPE NOT IN (
				'CGA'
				,'PIF'
				,'PRIV-EXMT'
				,'PRIV-TAX'
				)
			AND DefGiftAct.ADVENTID = @ADVENT_ID
		ORDER BY DefGiftAct.ADVENTID
			,TrstPrtcpt.LASTNAME
	END
	ELSE IF RTRIM(LTRIM(@CLIENT_BRIEF_NAME)) = ''
		AND RTRIM(LTRIM(@ADVENT_ID)) = ''
	BEGIN
		SELECT KCO_CM.ManagerCode AS CLIENTBRIEFNAME
			,DefGiftAct.ADVENTID
			,DefGiftAct.ACCOUNTTYPE
			,DefGiftAct.MATUREDATE
			,TrstPrtcpt.FIRSTNAME
			,TrstPrtcpt.LASTNAME
			,Bene.LASTK1YEAR
			,TrstPrtcpt.[EXPIREDATE]
			,LstItem.LIST_ITEM_NAME AS BENEFICIARYTYPE
			,TrstPrtcpt.PARTICIPANTID
			,Bene.BENEFICIARYID
			,KCO_CM.STAFFNAME AS 'CLIENT MANAGER'
			,KCO_TA.STAFFNAME AS 'TRUST ADMINISTRATOR'
		FROM SYN_EPS_Beneficiary Bene
		INNER JOIN SYN_EPS_TBL_EIS_EX_BENEFICIARY_SUPPLEMENT BS ON Bene.BENEFICIARYID = BS.BENEFICIARYID
		INNER JOIN SYN_EPS_TRUSTPARTICIPANT TrstPrtcpt ON TrstPrtcpt.PARTICIPANTID = Bene.PARTICIPANTID
		INNER JOIN SYN_EPS_DEFERREDGIFTACCOUNT DefGiftAct ON Bene.ACCOUNTID = DefGiftAct.ACCOUNTID
		INNER JOIN SYN_EPS_Program Prgm ON DefGiftAct.PROGRAMID = Prgm.PROGRAMID
		LEFT OUTER JOIN SYN_KDB_VW_KS_SysAdminKCoStaffPaging KCO_TA ON Prgm.BriefName = KCO_TA.ManagerCode
			AND KCO_TA.ROLENAME = 'Trust Administrator'
			AND KCO_TA.RELATIONSHIP = 1
		LEFT OUTER JOIN SYN_KDB_VW_KS_SysAdminKCoStaffPaging KCO_CM ON Prgm.BriefName = KCO_CM.ManagerCode
			AND KCO_CM.ROLENAME = 'Client Manager'
			AND KCO_CM.RELATIONSHIP = 1
		LEFT OUTER JOIN SYN_EPS_TBL_EIS_LIST_ITEM LstItem ON LstItem.LIST_ITEM_ID = BS.PARTICIPANT_HIERARCHY_ID
			AND LstItem.LIST_TYPE_ID = 135
		WHERE Bene.LASTK1YEAR IS NULL
			AND (
				DefGiftAct.MATUREDATE IS NOT NULL
				AND YEAR(DefGiftAct.MATUREDATE) = @Tax_YEAR
				)
			AND (
				TrstPrtcpt.[EXPIREDATE] IS NULL
				OR (
					TrstPrtcpt.[EXPIREDATE] IS NOT NULL
					AND YEAR(TrstPrtcpt.[EXPIREDATE]) = @Tax_YEAR
					)
				)
			AND DefGiftAct.ACCOUNTTYPE NOT IN (
				'CGA'
				,'PIF'
				,'PRIV-EXMT'
				,'PRIV-TAX'
				)
		ORDER BY DefGiftAct.ADVENTID
			,TrstPrtcpt.LASTNAME
	END
END
GO


