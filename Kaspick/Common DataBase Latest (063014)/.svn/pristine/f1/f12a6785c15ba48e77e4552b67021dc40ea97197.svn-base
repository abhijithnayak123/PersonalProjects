IF EXISTS (SELECT *
       FROM   sysobjects 
       WHERE  type = 'P'
              AND name = 'USP_RP_UpdBRDTDeliverableInstanceUniverse')
BEGIN
    DROP PROCEDURE USP_RP_UpdBRDTDeliverableInstanceUniverse;
    PRINT 'DROPPED USP_RP_UpdBRDTDeliverableInstanceUniverse';
END
GO
/****** Object:  StoredProcedure [dbo].[USP_RP_UpdBRDTDeliverableInstanceUniverse]    Script Date: 06/18/2014 10:56:44 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/******************************************************************************                  
** Old Name:     USP_EIS_BR_DT_DeliverableInstance_Universe_UpdProc   
** Name  : USP_RP_UpdBRDTDeliverableInstanceUniverse               
** Short Desc: To insert Deliverable Items to 'TBL_DLV_DeliverableItem' table  
**                  
** Full Description: To insert Deliverable Items       
**                          
** Input Arguments: 
**					
** Sample Call 
    Declare @SSISPackageMarketValueFile varchar(max);
	Declare @SSISPackageMarketValueConfig varchar(max);
	set @SSISPackageMarketValueFile = 'D:\SSISPackageMarketValue_devtest\DT_DW_EndingMarketValue.dtsx';
	set @SSISPackageMarketValueConfig ='D:\SSISPackageMarketValue_devtest\DT_DW_EndingMarketValue.dtsConfig'
    EXEC USP_RP_UpdBRDTDeliverableInstanceUniverse
    @SSISPackageMarketValueFile,
    @SSISPackageMarketValueConfig,
    1,
    -1,
    ''
	
**									
** Return values: Return Status
**                  
**                  
** Standard declarations                  
**       SET LOCK_TIMEOUT         30000   -- 30 seconds                  
**                   
** Created By: 
** Company   : Kaspick & Company                  
** Project   : Excelsior  - BeneReport                  
** Created DT: 25-Sep-09             
**                              
*******************************************************************************            
**       Change History                  
*******************************************************************************            
** Date:        Author:  Bug #     Description:                           Rvwd            
** --------		-------- ------    -------------------------------------- --------            
** 02/08/2010   Venu B   ET #11334  Update the Spigot flag in the report universe 
									when the flag is changed in the Excelsior.
** 02/18/2009   Venu	ET #11362   New paratmeter @DeliverableEndDate added to invoke USP_EIS_BR_DT_DeliverableItems_InsUpdProc
** 09/08/2010   Venu                Modified to update only Beneficiary Reports instances, becuase this sp will be 
									called from BeneReports Auto Scheduler. 
** Mar-12-2012  Ashvin			Changes for Adding Comments as per Stored Procedure standard template.
** Mar-14-2012  Ashvin			ERD changes implemetation.
*******************************************************************************                  
** Copyright (C) <CopyrightYear,,Year> Kaspick & Company, All Rights Reserved                  
** COMPANY CONFIDENTIAL -- NOT FOR DISTRIBUTION                  
*******************************************************************************/
CREATE PROCEDURE [dbo].[USP_RP_UpdBRDTDeliverableInstanceUniverse]
(
	@SSISPath				VARCHAR(MAX),
	@SSISConfigPath			VARCHAR(MAX),
	@UserID					INT,
	@ReturnStatus			INT = -1 OUTPUT, -- assume SP fails and 
	@ErrorDesc				VARCHAR(8000) OUTPUT
)
AS
BEGIN
	--  Initial Set statements  --            
	SET NOCOUNT ON;            
	SET LOCK_TIMEOUT                30000;   -- 30 seconds            
	--SET TRANSACTION ISOLATION LEVEL SNAPSHOT;           
	SET ARITHABORT ON           
	            
	--  Variable Declarations  --            
	DECLARE @procname    VARCHAR(60);            
	DECLARE @errmsg     VARCHAR(1000);            
	DECLARE @errnbr     INT;
	DECLARE @COUNT      INT;    
	DECLARE @I			INT;
	
	DECLARE @DeliverableQueueID		INT;
	DECLARE @DeliverableID		INT;
	DECLARE @DeliverableFrequency   VARCHAR(2);
    DECLARE @DeliverableEndDate		DATETIME;
    --BEGIN ET #11334
	DECLARE @PifDocumentTypeID bigint
	DECLARE @SpigotDocumentTypeID bigint
	DECLARE @DafDocumentTypeID bigint
	DECLARE @AnnualDocumentTypeID bigint
	--END ET #11334
	--  Variable Data Assignment  --            
	SET @procname = 'USP_RP_UpdBRDTDeliverableInstanceUniverse';            
	SET @ReturnStatus = 0; 
	SET @COUNT = 0;           
	            
	-- Body of procedure  --  
	BEGIN TRY
		BEGIN TRANSACTION
		-- Get 'Ending Market Value' in Table 'TBL_EIS_DT_STG_EndingMarketValue'.
		--EXEC USP_RP_GetRPTBRSSIS @SSISPath, @SSISConfigPath
       
       
        --BEGIN ET #11334
		SELECT @PifDocumentTypeID = DocumentTypeID FROM TBL_DLV_DocumentType WHERE DocumentFileType = 'PIF'
			and DeliverableID in (select DeliverableID from VW_RP_DTDeliverable where DeliverableName = 'Beneficiary Reports')
		SELECT @SpigotDocumentTypeID = DocumentTypeID FROM TBL_DLV_DocumentType WHERE DocumentFileType = 'Spigot'
			and DeliverableID in (select DeliverableID from VW_RP_DTDeliverable where DeliverableName = 'Beneficiary Reports')
		SELECT @DafDocumentTypeID = DocumentTypeID FROM TBL_DLV_DocumentType WHERE DocumentFileType = 'DAF'
			and DeliverableID in (select DeliverableID from VW_RP_DTDeliverable where DeliverableName = 'Beneficiary Reports')
		SELECT @AnnualDocumentTypeID = DocumentTypeID FROM TBL_DLV_DocumentType WHERE DocumentFileType = 'Annual'		
			and DeliverableID in (select DeliverableID from VW_RP_DTDeliverable where DeliverableName = 'Beneficiary Reports')
				
		UPDATE TBL_DLV_DeliverableItemDocument
		SET DocumentTypeID = (CASE 
								WHEN CTAccMstr.TrustTypeCode='PIF' THEN @PifDocumentTypeID
								WHEN UDFAccMstr.UDFAMColumn039 = 'Y' THEN @SpigotDocumentTypeID
								WHEN CTAccMstr.TrustTypeCode = 'D-A FUND' THEN @DafDocumentTypeID
								ELSE @AnnualDocumentTypeID 
							  END) 
		FROM TBL_DLV_DeliverableItemDocument DID
		JOIN TBL_DLV_DeliverableItem DI ON DID.DeliverableItemID = DI.DeliverableItemID
		JOIN TBL_INV_AccountProfile AccProf ON AccProf.CustomerAccountNumber = DI.CustomerAccountNumber     
		JOIN SYN_IT_CTAccountDetails CTAccMstr ON CTAccMstr.CustomerAccountNumber = AccProf.CustomerAccountNumber  
		JOIN SYN_IT_UDF_AccountMaster UDFAccMstr ON UDFAccMstr.CustomerAccountNumber_key = AccProf.CustomerAccountNumber  
		--JOIN TBL_EIS_EX_DEFERREDGIFTACCOUNT_SUPPLEMENT DS ON DS.AccountID = AccProf.AccountID     
		JOIN TBL_DLV_DeliverableQueue DQ ON DI.DeliverableQueueID = DQ.DeliverableQueueID 
		JOIN TBL_DLV_ItemMethodStatus IMS ON DI.DeliverableItemID = IMS.DeliverableItemID
		JOIN TBL_DLV_Deliverable DD On DD.DeliverableID = DQ.DeliverableID
		JOIN TBL_DLV_DeliverableMethod DM ON IMS.DeliveryMethodID = DM.DeliveryMethodID         
															AND DQ.DeliverableID = DM.DeliverableID
															AND DM.IsPrimary = 1  
		JOIN TBL_DLV_DeliverableProcessStatus DIS ON IMS.DeliverableItemStatusID = DIS.DeliverableItemStatusID 
																AND DIS.DeliverableProcessID = DD.DeliverableProcessID
		JOIN TBL_DLV_QueueStatus QS ON DQ.QueueStatusID = QS.QueueStatusID 
		JOIN VW_RP_DTDeliverable DT ON DQ.DeliverableID = DT.DeliverableID
		WHERE DIS.StatusName IN ('scheduled','Error')
		AND QS.StatusName = 'Open'
		AND DT.DeliverableFrequency = 'A'
		AND DID.DocumentTypeID <> (CASE 
									WHEN CTAccMstr.TrustTypeCode='PIF' THEN @PifDocumentTypeID
									WHEN UDFAccMstr.UDFAMColumn039 = 'Y' THEN @SpigotDocumentTypeID
									WHEN CTAccMstr.TrustTypeCode='D-A FUND' THEN @DafDocumentTypeID
									ELSE @AnnualDocumentTypeID 
								   END)
		AND DT.DeliverableName = 'Beneficiary Reports'
		
		
        --END ET #11334
		IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#TEMP_DELIVERABLE_QUEUE]'))    
		DROP TABLE [DBO].[#TEMP_DELIVERABLE_QUEUE]
		CREATE TABLE #TEMP_DELIVERABLE_QUEUE
		(
			QueueID					INT IDENTITY(1,1),      
			DeliverableQueueID		BIGINT		NULL,      
			DeliverableID		BIGINT		NULL,
			QueueStatusID			BIGINT		NULL,
			GenerationMethod		CHAR(1)		NULL,
			DeliverableQueueBriefName VARCHAR(50) NULL,
			DeliverableQueueName	VARCHAR(100) NULL,
			DeliverableStartDate	DATETIME	NULL,
			DeliverableEndDate		DATETIME	NULL,
			DeliverableQueueYear	INT			NULL,
			ModifiedDate			DATETIME	NULL,
			ModifiedUserID			INT			NULL,
			CreatedDate				DATETIME	NULL,
			CreatedUserID			INT			NULL
		)  

		INSERT INTO #TEMP_DELIVERABLE_QUEUE	
		SELECT DQ.DeliverableQueueID
			  ,DQ.DeliverableID
			  ,DQ.QueueStatusID
			  ,DQ.GenerationMethod
			  ,DQ.DeliverableQueueBriefName
			  ,DQ.DeliverableQueueName
			  ,DQ.DeliverableStartDate
			  ,DQ.DeliverableEndDate
			  ,DQ.DeliverableQueueYear
			  ,DQ.ModifiedDate
			  ,DQ.ModifiedUserID
			  ,DQ.CreatedDate
			  ,DQ.CreatedUserID
		FROM TBL_DLV_DeliverableQueue DQ
				INNER JOIN 
				TBL_DLV_QueueStatus DS ON DQ.QueueStatusID = DS.QueueStatusID
				INNER JOIN VW_RP_DTDeliverable DT ON DQ.DeliverableID = DT.DeliverableID 
		WHERE DS.StatusName = 'Open'
		AND DT.DeliverableName = 'Beneficiary Reports'

		SELECT @COUNT = COUNT(*) FROM #TEMP_DELIVERABLE_QUEUE

		SET @I = 1
		BEGIN
			IF(@COUNT > 0)
			BEGIN
				WHILE(@COUNT >= @I)
				BEGIN
					SELECT	@DeliverableQueueID = DeliverableQueueID,
							@DeliverableID = DeliverableID,
							@DeliverableEndDate = DeliverableEndDate
					FROM   #TEMP_DELIVERABLE_QUEUE WHERE QueueID = @I 
					
					SELECT @DeliverableFrequency = DeliverableFrequency FROM dbo.VW_RP_DTDeliverable 
					WHERE DeliverableID = @DeliverableID
					 
					EXEC USP_RP_SaveBrDtDeliverableItems
							@DeliverableQueueID,
                            @DeliverableID,
							@DeliverableFrequency,
							@DeliverableEndDate,
							@UserID,
							@ReturnStatus, 
							@ErrorDesc
					SET @I = @I + 1;
				END
			END
		END
		
		IF(@@ERROR > 0)	
		BEGIN
			ROLLBACK TRANSACTION
		END
		
		COMMIT TRANSACTION
	END TRY
	BEGIN CATCH
		SET @ErrorDesc = ERROR_MESSAGE();
		SET @Errnbr = ERROR_NUMBER();
		print @ErrorDesc
		ROLLBACK TRANSACTION;
		SET @ReturnStatus = -1;
	END CATCH
END


GO
IF EXISTS (SELECT *
       FROM   sysobjects 
       WHERE  type = 'P'
              AND name = 'USP_RP_UpdBRDTDeliverableInstanceUniverse')
BEGIN
    PRINT 'CREATED USP_RP_UpdBRDTDeliverableInstanceUniverse';
END


