IF EXISTS (
		SELECT *
		FROM sys.objects
		WHERE object_id = OBJECT_ID(N'[dbo].[USP_KCo_BeneficiaryDomicileForeign]')
			AND type IN (
				N'P'
				,N'PC'
				)
		)
	DROP PROCEDURE [dbo].[USP_KCo_BeneficiaryDomicileForeign]
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER OFF
GO

/******************************************************************************    
** Name:  USP_KCo_BeneficiaryDomicileForeign  
** Short Desc: Generate report for the Benefiaciary address information in terms of Taxyear for foreign domicile
**    
** Full Description    
**      Generate report for the Benefiaciary address information in terms of Taxyear for foreign domicile
**    
** Sample Call    
EXEC USP_KCo_BeneficiaryDomicileForeign 2010

 
**    
** Return values: NONE    
**    
**    
** Standard declarations    
**       SET LOCK_TIMEOUT         30000   -- 30 seconds    
**     
** Created By: Asit Kar  
** Company   : Kaspick & Company    
** Project   : BOI: Reports & Queries   
** Created DT: 22-04-2014  
**                
*******************************************************************************    
**       Change History    
*******************************************************************************    
** Date:        Author:  Bug #     Description:                           Rvwd    
** --------     -------- ------    -------------------------------------- --------    
** 26-jun-14   Salih               Modified Rolecode implementation from Rolecode description to ID. 
*******************************************************************************    
** Copyright (C) 2014 Kaspick & Company, All Rights Reserved    
** COMPANY CONFIDENTIAL -- NOT FOR DISTRIBUTION    
*******************************************************************************/
CREATE PROCEDURE [dbo].[USP_KCo_BeneficiaryDomicileForeign] @TaxYear INT
AS
BEGIN
	--  Initial Set statements  --    
	SET NOCOUNT ON;
	SET LOCK_TIMEOUT 30000;-- 30 seconds    

	SELECT DISTINCT AccMas.CustomerAccountNumber
		,CMBene.ContactName AS BeneficiaryName
		,CMBene.DateOfDeath AS ExpireDate
		,CMBene.DomicileStateCode
		,ConAdd.AddressType
		,ConAdd.City
		,ConAdd.STATE
		,ConAdd.ZipCode
		,ConAdd.CountryCode
		,BenPymnt.TaxYear
		,BenPymnt.AccountType
	FROM SYN_IT_ContactAddresses ConAdd
	INNER JOIN SYN_IT_ContactAccountRoles ContAccRol
		ON ContAccRol.ContactID = ConAdd.ContactID
			-- 26-jun-2014  Salih: Modified Rolecode implementation from Rolecode description to ID.
			AND ContAccRol.ContactRoleCode = 21 -- 'Beneficiary'
	INNER JOIN SYN_IT_ContactMaster CMBene
		ON ContAccRol.ContactID = CMBene.ContactID
	INNER JOIN SYN_IT_AccountMaster AccMas
		ON ContAccRol.CustomerAccountNumber = AccMas.CustomerAccountNumber
	INNER JOIN TBL_PP_BeneficiaryPayment BenPymnt
		ON BenPymnt.CustomerAccountNumber = AccMas.CustomerAccountNumber
			AND BenPymnt.ContactID = CMBene.ContactID
			AND ConAdd.PrimaryAddressFlag = - 1
			AND ConAdd.ActiveFlag = - 1
			AND ConAdd.AddressType = 'Home'
	WHERE (
			NOT ConAdd.CountryCode IS NULL
			AND ConAdd.CountryCode <> ''
			AND ConAdd.CountryCode <> 'US'
			)
		AND (
			YEAR(CMBene.DateOfDeath) >= @TaxYear
			OR YEAR(CMBene.DateOfDeath) IS NULL
			)

	SET NOCOUNT OFF;
END
