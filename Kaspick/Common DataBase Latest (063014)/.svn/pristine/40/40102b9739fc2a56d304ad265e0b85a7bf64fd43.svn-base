/****** Object:  StoredProcedure [dbo].[USP_IE_ReviewGetSTGAccount]    Script Date: 07/02/2014 09:22:21 ******/
IF EXISTS (
		SELECT 1
		FROM sys.objects
		WHERE object_id = OBJECT_ID(N'[dbo].[USP_IE_ReviewGetSTGAccount]')
			AND type IN (
				N'P'
				,N'PC'
				)
		)
	DROP PROCEDURE [dbo].[USP_IE_ReviewGetSTGAccount]
GO

/****** Object:  StoredProcedure [dbo].[USP_IE_ReviewGetSTGAccount]    Script Date: 07/02/2014 09:22:21 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

/******************************************************************************    
** Name:     USP_IE_ReviewGetSTGAccount    
** Short Desc:   Gets all accounts created under given group for Data Review   
**    
** Full Description : Gets all accounts created under given group for Data Review 
**            
**    
** Sample Call    
  DECLARE @XMLStatus  XML
	SET  @XMLStatus = '<StatusCollection>
						 <Status StatusID="1"/>
						 <Status StatusID="2"/>
						 <Status StatusID="3"/>
						 <Status StatusID="8"/>
					  </StatusCollection>'   
  EXEC USP_IE_ReviewGetSTGAccount   4,'TMC','All',@XMLStatus,5,0,100023

  EXEC USP_IE_ReviewGetSTGAccount   1,'All','All',@XMLStatus,-1, 1,1  
**    
** Return values: NONE    
**    
**    
** Standard declarations    
**       SET LOCK_TIMEOUT         30000   -- 30 seconds    
**     
** Created By: Mohamed Salih    
** Company   : Kaspick & Company    
** Project   : Back Office Integration - Income Estimation    
** Created DT: 08/11/2014    
**                
*******************************************************************************    
**       Change History    
*******************************************************************************    
** Date:        Author:  Bug #     Description:                           Rvwd    
** --------     -------- ------    -------------------------------------- --------    
**   
*******************************************************************************    
** Copyright (C) <CopyrightYear,,Year> Kaspick & Company, All Rights Reserved    
** COMPANY CONFIDENTIAL -- NOT FOR DISTRIBUTION    
*******************************************************************************/
CREATE PROCEDURE [dbo].[USP_IE_ReviewGetSTGAccount] -- paremeters here        
	@GroupID INT
	,@ManagerCode VARCHAR(20)
	,@AccountType VARCHAR(20)
	,@XMLStatus XML
	,@WarningID INT
	,@IsMidYear BIT
	,@UserID INT
AS
BEGIN
	SET NOCOUNT ON;
	SET LOCK_TIMEOUT 30000;-- 30 seconds    

	--  Variable Declarations  --   
	DECLARE @StatusCount INT

	--  Temp tables, Cursors, Table Variables  --  
	SELECT @StatusCount = @XMLStatus.value('count(/StatusCollection/Status)', 'INT')

	SELECT STGEst.StagingID
		,STGEst.GroupID
		,STGEst.CustomerAccountNumber
		,STGEst.StatusID
		,IEStat.STATUS
		,STGEst.DiagnosticError
		,STGEst.ImportDate
		,STGEst.RunDate
		,STGEst.AccountType
		,UnitrustPercentage
		,EP_MasterObjectiveName
		,EP_InvestmentType
		,EP_InvestmentComment
		,PP_OverPayment
		,PP_InvestmentAllocationYield
		,EP_ClientIEComment
		,Ax_EstimatedIncome
		,Ax_YTDOtherEx
		,Ax_PriorYearAccruedIncome
		,Ax_ReClassIncome
		,Ax_ActualSGD
		,Ax_EarnedIncome
		,Ax_FMVOnStartDate
		,Ax_FMVOnRunDate
		,Ax_GrossIncomeEstimate
		,Ax_AxysPortYield
		,Ax_AxysPortGrossYieldVar
		,Ax_GrossIncomeYieldOnStartDate
		,Ax_GrossIncomeYieldOnRunDate
		,IT_AnnIMFee_Income
		,IT_AnnTAFee_Income
		,IT_AnnTrusteeFee_Income
		--New Columns
		,IT_YTDIMFee_Income
		,IT_YTDTAFee_Income
		,IT_YTDTrusteeFee_Income
		,IT_ProjectedIMFee_Income
		,IT_ProjectedTAFee_Income
		,IT_ProjectedTrusteeFee_Income
		,Projectedannualchg_income
		-- End 
		,Ax_TMCAnnualChg_Income
		,Ax_EstimatedSGD
		,Ca_InvAllocGrossYieldVar
		,EstimatedOtherExpenses
		,CurrentYearAccruedIncome
		,ActualSTGLTG
		,AssetAmortAccret
		,IT_ClientLegalName
		,STGEst.UserID
		,STGEst.UserName
	FROM TBL_IE_STG_Estimate STGEst
	INNER JOIN TBL_IE_Status IEStat
		ON STGEst.StatusID = IEStat.StatusID
	WHERE STGEst.IsDeleted = 0
		AND STGEst.GroupID = @GroupID
		AND (
			(
				ManagerCode = @ManagerCode
				AND (
					@ManagerCode <> 'ALL'
					AND @ManagerCode <> 'My Clients'
					AND @ManagerCode <> 'My Backups'
					)
				)
			OR (
				@ManagerCode = 'My Clients'
				AND ManagerCode IN (
					SELECT ManagerCode
					FROM VW_KS_SysAdminKCoStaffPaging
					WHERE USerID = @UserID
						AND RoleCode IN (
							-- IsPrimary = 1
							2 -- 'Administrator'
							,14 -- Investment Officer <-- 'Relationship Manager'
							,26 -- 'Plan Administrator'
							,510 -- 'Trust Administrator'
							,515 -- 'Portfolio Analyst'
							,518 -- 'Custody Ops Administrator'
							,519 -- 'Reporting Analyst'
							)
					)
				)
			OR (
				@ManagerCode = 'My Backups'
				AND ManagerCode IN (
					SELECT ManagerCode
					FROM VW_KS_SysAdminKCoStaffPaging
					WHERE USerID = @UserID
						AND RoleCode IN (
							-- IsPrimary = 0
							3 -- 'Backup Administrator'
							,512 -- 'Backup Relationship Manager'
							,26 -- 'Plan Administrator'
							,510 -- 'Trust Administrator'
							,515 -- 'Portfolio Analyst'
							,518 -- 'Custody Ops Administrator'
							,519 -- 'Reporting Analyst'
							)
					)
				)
			OR (@ManagerCode = 'ALL')
			)
		AND (
			(
				@AccountType <> 'ALL'
				AND AccountType = @AccountType
				)
			OR (@AccountType = 'ALL')
			)
		AND (
			   (
				@StatusCount <> 0
				AND STGEst.StatusID IN (
					SELECT XmlInput.Item.value('@StatusID[1]', 'INT') AS StatusID
					FROM @XMLStatus.nodes('//StatusCollection/Status') AS XmlInput(Item)
					)
				)
			OR (@StatusCount = 0)
			)
		AND (
			   (
				@WarningID > 0
				AND CustomerAccountNumber IN (
					SELECT CustomerAccountNumber
					FROM TBL_IE_DiagnosticResult
					WHERE GroupID = @GroupID
						AND DiagnosticID = @WarningID
					)
				)
			OR (
				@WarningID = - 1
				AND CustomerAccountNumber IN (
					SELECT CustomerAccountNumber
					FROM TBL_IE_DiagnosticResult
					WHERE GroupID = @GroupID
						AND DiagnosticID IN (
							SELECT DiagnosticID
							FROM TBL_IE_Diagnostic
							WHERE DiagnosticType = 'Flag'
							)
					)
				)
			OR (
				NOT (@WarningID > 0)
				AND @WarningID <> - 1
				)
			)
		AND (
			   (
				@IsMidYear = 0
				AND STGEst.ParentStagingID IS NULL
				)
			OR (
				@IsMidYear = 1
				AND STGEst.ParentStagingID IS NOT NULL
				)
			OR (
				@IsMidYear <> 0
				AND @IsMidYear <> 1
				)
			)

	SET NOCOUNT OFF;
END
