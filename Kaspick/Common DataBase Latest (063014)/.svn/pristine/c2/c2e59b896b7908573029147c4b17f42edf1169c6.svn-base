IF EXISTS (SELECT *
           FROM   sysobjects 
           WHERE  type = 'P'
                  AND name = 'USP_EX_UpdPolicyItemReportingCascade')
    BEGIN
        DROP PROCEDURE USP_EX_UpdPolicyItemReportingCascade;
        PRINT 'DROPPED USP_EX_UpdPolicyItemReportingCascade';
    END
GO
  
  
/******************************************************************************                      
** Name: USP_EX_UpdPolicyItemReportingCascade
** Old Name:     USP_EIS_EX_POLICYITEM_REPORTING_CASCADE_UpdProc                       
** Short Desc: To Insert/Update the POLICYITEM table for a particular dimension.                
**                      
** Full Description: To Insert/Update the POLICYITEM table for a particular dimension.                
**                              
** @POLICYDIMENSIONNAME: for which record has to be added in POLICYITEM.                
   @LIST_ITEM_ID: used to fetch the DROPDOWNTEXT or BIT value to save for DATATYPE [LIST/LOGICAL].                
   @POLICYLEVEL: for which record has to be added in POLICYITEM.                
   @OWNERID INT: for which record has to be added in POLICYITEM.                
   @SCALARVALUE: is value tobe saved for DATATYPE [DATE/NUMERIC].          
   @USERID: user who is Updating/Inserting/Deleting the policy.          
   @POLICYCATEGORY: is a optional parameter which takes special care for 'Reporting' PolicyCategory.                
** Sample Call                      
        EXEC USP_EIS_EX_POLICYITEM_REPORTING_CASCADE_UpdProc   
   @NEW_VALUE   =   ,   
   @POLICYDIMENTISON =   ,  
   @ENTITY_TYPE  =   ,  
   @ENTITY_ID   =   ,  
   @USERID    =  
  
**                      
** Return values: NONE                      
**                      
**                      
** Standard declarations                      
**       SET LOCK_TIMEOUT         30000   -- 30 seconds                      
**                       
** Created By: VShivhare                      
** Company   : Kaspick & Company                      
** Project   : Excelsior                      
** Created DT: July 12 2007    
**                                  
*******************************************************************************                
**       Change History                      
*******************************************************************************                
** Date:        Author:    Bug #  Description:          Rvwd                
** --------     -------- ------    -------------------------------------- --------  
** 06/17/2009 Saravanan P Muthu KCBR  PIF Policies cascading only PIF Account Type     
   08/11/2009 Saravanan P Muthu CR #4  KCBP - Quickbase CR #4 - Bene Report performance inception date change request (Move the field to the Reporting tab on the Beneficiary Report page)      
 * 12/04/2014 Yugandhar		EXCREQ 6.1
 *******************************************************************************                      
** Copyright (C) <CopyrightYear,,Year> Kaspick & Company, All Rights Reserved                      
** COMPANY CONFIDENTIAL -- NOT FOR DISTRIBUTION                      
*******************************************************************************/                      
CREATE PROCEDURE USP_EX_UpdPolicyItemReportingCascade      
(    
 @NEW_VALUE   VARCHAR(100),     
 @POLICYDIMENTISON VARCHAR(100),    
 @ENTITY_TYPE  VARCHAR(100),    
 @ENTITY_ID   VARCHAR(14),    
 @USERID    INT     
)    
AS    
BEGIN     
 DECLARE @MAX_POLICY_LEVEL INT,    
   @POLICYDIMENSIONID INT,    
   @DATA_TYPE VARCHAR(20),    
   @C_VAL_DATE DATETIME,    
   @C_VAL_LIST INT,    
   @C_VAL_LOGICAL BIT,    
   @C_VAL_NUMERIC FLOAT,    
   @C_VAL_TEXT VARCHAR(100)  
  
 --Temp Table for CLIENT Accounts    
 DECLARE @TMP_C_ACT TABLE(ACCOUNTID VARCHAR(14))    
  
 SELECT @MAX_POLICY_LEVEL=MAXPOLICYLEVEL, @DATA_TYPE=DATATYPE ,@POLICYDIMENSIONID=POLICYDIMENSIONID     
 FROM TBL_PolicyDimension WHERE FULLNAME =@POLICYDIMENTISON    
  
 --Fetch Current Clietn Level Value     
  
 IF(@ENTITY_TYPE='MANAGER' AND @MAX_POLICY_LEVEL>200)    
 BEGIN    
  --first select all the current value stored in policyitem for this client for this policydimension    
  SELECT @C_VAL_DATE=DATEVALUE,    
    @C_VAL_LIST=POLICYDROPDOWNID,    
    @C_VAL_LOGICAL =LOGICALVALUE,    
    @C_VAL_NUMERIC =NUMERICVALUE,    
    @C_VAL_TEXT=TEXTVALUE     
  FROM TBL_PolicyItem WHERE OWNERID=@ENTITY_ID AND POLICYDIMENSIONID=@POLICYDIMENSIONID AND POLICYLEVEL=100     
    
  IF @POLICYDIMENSIONID IN (206,264,265)  
  BEGIN  
   INSERT INTO @TMP_C_ACT SELECT ACCOUNTID FROM VW_EX_Account WHERE CLIENTID=@ENTITY_ID AND ACCOUNT_TYPE = 'PIF'    
  END  
  ELSE  
  BEGIN  
   INSERT INTO @TMP_C_ACT SELECT ACCOUNTID FROM VW_EX_Account WHERE CLIENTID=@ENTITY_ID  
  END  
  --END HERE  
  
  IF NOT EXISTS(SELECT ACCOUNTID FROM @TMP_C_ACT)    
  BEGIN    
   --Since no account found under this client, return.    
   RETURN(1)    
  END    
     --update all the associated account with this client    
  IF(@DATA_TYPE='DATE')    
  BEGIN    
   UPDATE TBL_POLICYITEM    
   SET  MODIFIEDUSERID=@USERID,    
     MODIFIEDDATE=GETDATE()    
   WHERE POLICYITEMID IN(SELECT POLICYITEMID FROM TBL_PolicyItem     
         WHERE OWNERID IN(SELECT ACCOUNTID FROM @TMP_C_ACT)     
         AND POLICYLEVEL=300     
         AND POLICYDIMENSIONID=@POLICYDIMENSIONID    
         AND (DATEVALUE IS NULL OR DATEDIFF(day,ISNULL(DATEVALUE,''),ISNULL(@C_VAL_DATE,''))=0))  
  
 
   UPDATE TBL_PolicyItem   
   SET  DATEVALUE = CAST(@NEW_VALUE AS DATETIME),
		MODIFIEDUSERID=@USERID,    
     MODIFIEDDATE=GETDATE()     
   WHERE OWNERID IN(SELECT ACCOUNTID FROM @TMP_C_ACT)     
     AND POLICYLEVEL=300     
     AND POLICYDIMENSIONID=@POLICYDIMENSIONID    
     AND (DATEVALUE IS NULL OR DATEDIFF(day,ISNULL(DATEVALUE,''),ISNULL(@C_VAL_DATE,''))=0)   
  
  END    
  ELSE IF(@DATA_TYPE='LIST')    
  BEGIN    
   UPDATE TBL_PolicyItem    
   SET  MODIFIEDUSERID=@USERID,    
     MODIFIEDDATE=GETDATE()    
   WHERE   POLICYITEMID IN (SELECT POLICYITEMID FROM TBL_PolicyItem     
           WHERE OWNERID IN (SELECT ACCOUNTID FROM @TMP_C_ACT)     
           AND POLICYLEVEL=300     
           AND POLICYDIMENSIONID=@POLICYDIMENSIONID    
           AND POLICYDROPDOWNID = @C_VAL_LIST)     
  
   UPDATE TBL_PolicyItem   
   SET  POLICYDROPDOWNID=CAST(@NEW_VALUE AS INT),MODIFIEDUSERID=@USERID,    
     MODIFIEDDATE=GETDATE()     
   WHERE OWNERID IN(SELECT ACCOUNTID FROM @TMP_C_ACT)     
     AND POLICYLEVEL=300     
     AND POLICYDIMENSIONID=@POLICYDIMENSIONID    
     AND POLICYDROPDOWNID=@C_VAL_LIST    
  END    
  ELSE IF(@DATA_TYPE='LOGICAL')    
  BEGIN    
   UPDATE TBL_PolicyItem    
   SET MODIFIEDUSERID=@USERID,MODIFIEDDATE=GETDATE()    
   WHERE     
   POLICYITEMID IN (SELECT POLICYITEMID FROM TBL_PolicyItem     
    WHERE OWNERID IN (SELECT ACCOUNTID FROM @TMP_C_ACT)     
    AND POLICYLEVEL=300     
    AND POLICYDIMENSIONID=@POLICYDIMENSIONID    
    AND LOGICALVALUE = @C_VAL_LOGICAL)     
  
 
   UPDATE TBL_PolicyItem SET LOGICALVALUE=CAST(@NEW_VALUE AS BIT),MODIFIEDUSERID=@USERID,    
     MODIFIEDDATE=GETDATE()     
   WHERE OWNERID IN(SELECT ACCOUNTID FROM @TMP_C_ACT)     
   AND POLICYLEVEL=300     
   AND POLICYDIMENSIONID=@POLICYDIMENSIONID    
   AND LOGICALVALUE=@C_VAL_LOGICAL    
  END    
     ELSE IF(@DATA_TYPE='NUMERIC')    
     BEGIN    
   UPDATE TBL_PolicyItem    
   SET MODIFIEDUSERID=@USERID,    
    MODIFIEDDATE=GETDATE()    
   WHERE     
   POLICYITEMID IN (SELECT POLICYITEMID FROM TBL_PolicyItem     
    WHERE OWNERID IN (SELECT ACCOUNTID FROM @TMP_C_ACT)     
    AND POLICYLEVEL=300     
    AND POLICYDIMENSIONID=@POLICYDIMENSIONID    
    AND NUMERICVALUE = @C_VAL_NUMERIC)     
  
   
   UPDATE TBL_PolicyItem SET NUMERICVALUE=CAST(@NEW_VALUE AS FLOAT),MODIFIEDUSERID=@USERID,    
     MODIFIEDDATE=GETDATE()     
   WHERE OWNERID IN(SELECT ACCOUNTID FROM @TMP_C_ACT)     
   AND POLICYLEVEL=300     
   AND POLICYDIMENSIONID=@POLICYDIMENSIONID    
   AND NUMERICVALUE=@C_VAL_NUMERIC    
     END    
     ELSE IF(@DATA_TYPE='TEXT')    
     BEGIN    
   UPDATE TBL_PolicyItem    
   SET  MODIFIEDUSERID=@USERID,    
     MODIFIEDDATE=GETDATE()    
   WHERE POLICYITEMID IN ( SELECT POLICYITEMID FROM TBL_PolicyItem     
          WHERE OWNERID IN (SELECT ACCOUNTID FROM @TMP_C_ACT)     
            AND POLICYLEVEL=300     
            AND POLICYDIMENSIONID=@POLICYDIMENSIONID    
            AND (TEXTVALUE IS NULL OR ISNULL(TEXTVALUE,'') = ISNULL(@C_VAL_TEXT,'')))    

   UPDATE TBL_PolicyItem SET TEXTVALUE=@NEW_VALUE,MODIFIEDUSERID=@USERID,    
     MODIFIEDDATE=GETDATE()     
   WHERE OWNERID IN(SELECT ACCOUNTID FROM @TMP_C_ACT)     
   AND POLICYLEVEL=300     
   AND POLICYDIMENSIONID=@POLICYDIMENSIONID    
   AND (TEXTVALUE IS NULL OR ISNULL(TEXTVALUE,'') = ISNULL(@C_VAL_TEXT,''))  
  END  
 END     
 if(@@error !=0)  
 begin  
   RAISERROR 1000092 'USP_EX_UpdPolicyItemReportingCascade: Cannot update  in tbl_POLICYITEM table'                
 end  
END  



  GO
  IF EXISTS (	SELECT *
			FROM sysobjects
			WHERE type = 'P'
			AND name = 'USP_EX_UpdPolicyItemReportingCascade') 
	BEGIN
			PRINT 'CREATED PROCEDURE USP_EX_UpdPolicyItemReportingCascade';
	END 