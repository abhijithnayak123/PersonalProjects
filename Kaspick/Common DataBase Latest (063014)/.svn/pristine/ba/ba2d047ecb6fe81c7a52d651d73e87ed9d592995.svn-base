IF EXISTS (
		SELECT *
		FROM sysobjects
		WHERE type = 'P'
			AND NAME = 'USP_EIS_RPT_BR_VE_DR_UnexpectedTrustAccountType_SelProc'
		)
BEGIN
	DROP PROCEDURE USP_EIS_RPT_BR_VE_DR_UnexpectedTrustAccountType_SelProc;

	PRINT 'DROPPED USP_EIS_RPT_BR_VE_DR_UnexpectedTrustAccountType_SelProc';
END
GO

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


/******************************************************************************                        
** Name:     USP_EIS_RPT_BR_VE_DR_UnexpectedTrustAccountType_SelProc                        
** Short Desc: Retrieves Unexpected values of Trust - AccountType       
**                        
** Full Description: To retrieve  details      
**                                
** Input Arguments:       
**           
** Sample Call       
**        
 DECLARE @XMLDeliverableItems XML      
    SET @XMLDeliverableItems =    
'<DeliverableItemsDataToValidateCollection><InsertList></InsertList><UpdateList></UpdateList><DeleteList></DeleteList><SelectList>    
<DeliverableItemsDataToValidate AccountID="100293"  BeneficiaryID="102298"  ClientEmployeeID="0"  ClientID="100002"  DeliverableItemID="4498"      
DeliverableQueueID="1"  DonorID="116323"  TrustparticipantID="102090"        
DeliverableFrequency="A"  />    
<DeliverableItemsDataToValidate AccountID="100940"  BeneficiaryID="101494"  ClientEmployeeID="0"  ClientID="100033"  DeliverableItemID="447"      
DeliverableQueueID="1"  DonorID="100975"  TrustparticipantID="101396"        
DeliverableFrequency="A"  />    
</SelectList></DeliverableItemsDataToValidateCollection>'       
 EXEC USP_EIS_RPT_BR_VE_DR_UnexpectedTrustAccountType_SelProc      
    @XMLDeliverableItems      
       
       
**               
** Return values: Null      
**                        
**                        
** Standard declarations                        
**       SET LOCK_TIMEOUT         30000   -- 30 seconds                        
**                         
** Created By: Niveditha N
** Company   : Kaspick & Company                        
** Project   : DT - Validation Engine
** Created DT: 06/03/2011                        
**                                    
*******************************************************************************                  
**       Change History                        
*******************************************************************************                  
** Date:        Author:              Bug #     Description:             Rvwd                  
** --------  --------               ------    ---------------------- --------                  
** 24-Jun-2014		Mukesh		 SP Name Renamed and Formatted      
*******************************************************************************                        
** Copyright (C) <CopyrightYear,,Year> Kaspick & Company, All Rights Reserved                        
** COMPANY CONFIDENTIAL -- NOT FOR DISTRIBUTION                        
*******************************************************************************/
CREATE PROCEDURE [dbo].[USP_EIS_RPT_BR_VE_DR_UnexpectedTrustAccountType_SelProc]
	-- paremeters here            
	@XMLDeliverableItems XML
AS
BEGIN
	--  Initial Set statements  --            
	--SET NOCOUNT ON;            
	--SET LOCK_TIMEOUT                30000;   -- 30 seconds            
	--SET TRANSACTION ISOLATION LEVEL SNAPSHOT;            
	--  Variable Declarations  --            
	DECLARE @procname VARCHAR(60);
	DECLARE @ErrorMessage VARCHAR(1000);
	DECLARE @ErrorNumber INT;
	-- Variables used for error handling - uncomment if needed            
	DECLARE @val1 VARCHAR(30);
	DECLARE @val2 VARCHAR(30);
	--  Temp tables, Cursors, Table Variables  --            
	DECLARE @DeliverableItemData TABLE (
		DeliverableItemID INT
		,AccountID INT
		,Accounttype VARCHAR(max)
		,VerifiedbyBusiness BIT
		);

	--  Variable Data Assignment  --            
	SET @procname = 'USP_EIS_RPT_BR_VE_DR_UnexpectedTrustAccountType_SelProc';

	-- Body of procedure  --            
	BEGIN TRY
		INSERT INTO @DeliverableItemData
		SELECT XMLdoc.DeliverableItemData.value('@DeliverableItemID[1]', 'int') AS DeliverableItemID
			,XMLdoc.DeliverableItemData.value('@AccountID[1]', 'int') AS AccountID
			,VA.ACCOUNTTYPE
			,isnull(TT.VerifiedbyBusiness, 0)
		FROM @XMLDeliverableItems.nodes('//DeliverableItemsDataToValidateCollection/SelectList/DeliverableItemsDataToValidate') AS XMLdoc(DeliverableItemData)
		INNER JOIN V_EIS_EX_ACCOUNT VA ON VA.ACCOUNTID = XMLdoc.DeliverableItemData.value('@AccountID[1]', 'int')
		LEFT JOIN TBL_EIS_RPT_BR_TrustType TT ON TT.AccountType = VA.AccountType

		SELECT XMLdoc.DeliverableItemData.value('@DeliverableItemID[1]', 'int') AS DeliverableItemID
			,(
				SELECT ValidationRuleID
				FROM TBL_DLV_ValidationRule -- changed the Kaspick DB table as StagingDB table is missing 
				WHERE RuleName = 'Unavailable Trust Type'
				) AS RuleID
			,'VerifiedbyBusiness' AS Attribute
			,VerifiedbyBusiness AS ActualValue
			,'Unavailable Trust Type' AS DisplayMessage
		FROM @XMLDeliverableItems.nodes('//DeliverableItemsDataToValidateCollection/SelectList/DeliverableItemsDataToValidate') AS XMLdoc(DeliverableItemData)
		LEFT JOIN @DeliverableItemData ID ON id.DeliverableItemID = XMLdoc.DeliverableItemData.value('@DeliverableItemID[1]', 'int')
	END TRY

	BEGIN CATCH
		SET @ErrorMessage = ERROR_MESSAGE();
		SET @ErrorNumber = ERROR_NUMBER();
		SET @val1 = '';
		SET @val2 = '';

		EXEC dbo.spSYS_ErrorHandler @codename = @procname
			,@errmsg = @ErrorMessage
			,@errnbr = @ErrorNumber
			,@val1 = ''
			,@val1str = 'USP_EIS_RPT_BR_VE_DR_UnexpectedTrustAccountType_SelProc: Cannot Select.'
			,@val2 = ''
			,@val2str = '';
	END CATCH
		-- End of procedure  --
END
GO

IF EXISTS (
		SELECT *
		FROM sysobjects
		WHERE type = 'P'
			AND NAME = 'USP_EIS_RPT_BR_VE_DR_UnexpectedTrustAccountType_SelProc'
		)
BEGIN
	PRINT 'CREATED USP_EIS_RPT_BR_VE_DR_UnexpectedTrustAccountType_SelProc';
END

SET QUOTED_IDENTIFIER OFF