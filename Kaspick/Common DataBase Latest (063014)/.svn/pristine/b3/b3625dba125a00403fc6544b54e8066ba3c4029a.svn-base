IF EXISTS (SELECT *
           FROM   sysobjects 
           WHERE  type = 'P'
                  AND name = 'USP_EX_GetProgramhdr')
    BEGIN
        DROP PROCEDURE USP_EX_GetProgramhdr;
        PRINT 'DROPPED USP_EX_GetProgramhdr';
    END
GO

/*********************************************************************************************************************                                                 
* Procedure Name : USP_EX_GetProgramhdr  
* Old Procedure Name : USP_EIS_EX_PROGRAM_HDRSelProc         
* Description    : To retrieve PROGRAM Header Details.        
* Input          : @PROGRAMID: Program Id, of which the details should be fetched.        
* Modification Log                                                     
*                                    
* Date   Modified By  Description                                                    
*--------------------------------------------------------------------------------------------------------------------                                                 
* 15-Nov-06  Vshivhare  Created        
*  10-Apr-14  Sanath   Program module header for req EXCREQ6.4       
* 23/05/2014 Mallikarjun  SP Name Renamed and Formatted  
*********************************************************************************************************************/        
        
CREATE PROCEDURE [dbo].[USP_EX_GetProgramhdr]--100038   
(        
 @PROGRAMID VARCHAR(15),    
 @USERID INT = NULL        
)        
AS        
        
BEGIN     
    
IF(@USERID IS NOT NULL)    
BEGIN         
 SELECT         
  AccMgrCds.ManagerCode AS CLIENTID,        
  ISNULL(AccMgrCds.ManagerCode,'') CL_BRIEFNAME,        
  ISNULL(ContMstrClient.ContactName,'') CL_FULLNAME,        
  AlnsNmbr.AllianceNumber,        
  ISNULL(AlnsNmbr.AllianceNumber,'') PROG_BRIEFNAME,        
  ISNULL(ContMstrPrg.ContactName,'') PROG_FULLNAME,    
  ASSOCIATION=CASE WHEN (SELECT TOP 1 AccMgrCds.ManagerCode  
        FROM SYN_IT_ContactMaster ConMstr  
        INNER JOIN SYN_IT_AccountManagerCodes AccMgrCds ON ConMstr.ContactID=AccMgrCds.ContactID  
        INNER JOIN SYN_IT_SubContactRoles subConRol ON subConRol.ContactID=ConMstr.ContactID  
        INNER JOIN SYN_IT_ContactRoleCodes ConRolCds ON ConRolCds.Id=subConRol.ContactRoleCode  
        INNER JOIN SYN_IT_ContactMaster KcoStfConMstr ON KcoStfConMstr.contactID=subConRol.subcontactID  
        INNER JOIN TBL_KS_User KsUsr ON KsUsr.InnotrustContactID = KcoStfConMstr.contactID  
        WHERE  
          subConRol.ContactRoleCode IN (2)--,3,518,26,34,512,519,515,510 -- 2 is Administrator  
          AND KsUsr.USERID = @USERID)      
    IS NULL THEN 1 ELSE 1 END          
 FROM   
  SYN_IT_AccountManagerCodes AccMgrCds     
 INNER JOIN SYN_IT_AccountMaster AccMstr ON AccMstr.ManagerCode=AccMgrCds.ManagerCode    
  INNER JOIN SYN_IT_AllianceNumbers AlnsNmbr ON AlnsNmbr.Alliancenumber=  AccMstr.Alliancenumber 
 INNER JOIN SYN_IT_ContactMaster ContMstrClient ON ContMstrClient.ContactID=AccMgrCds.ContactID   
 INNER JOIN SYN_IT_ContactMaster ContMstrPrg ON ContMstrPrg.ContactID=AlnsNmbr.ContactID  

 
    
 WHERE         
  AlnsNmbr.AllianceNumber = @PROGRAMID     
END    
ELSE    
BEGIN    
 SELECT         
  AccMgrCds.ManagerCode AS ClientID,        
  ISNULL(AccMgrCds.ManagerCode,'') CL_BRIEFNAME,        
  ISNULL(ContMstrClient.ContactName,'') CL_FULLNAME,        
  AlnsNmbr.AllianceNumber ,        
  ISNULL(AlnsNmbr.AllianceNumber,'') PROG_BRIEFNAME,        
  ISNULL(ContMstrPrg.ContactName,'') PROG_FULLNAME        
 FROM         
   SYN_IT_AccountManagerCodes AccMgrCds     
 INNER JOIN SYN_IT_AccountMaster AccMstr ON AccMstr.ManagerCode=AccMgrCds.ManagerCode    
  INNER JOIN SYN_IT_AllianceNumbers AlnsNmbr ON AlnsNmbr.Alliancenumber=  AccMstr.Alliancenumber 
 INNER JOIN SYN_IT_ContactMaster ContMstrClient ON ContMstrClient.ContactID=AccMgrCds.ContactID   
 INNER JOIN SYN_IT_ContactMaster ContMstrPrg ON ContMstrPrg.ContactID=AlnsNmbr.ContactID   
 WHERE         
  AlnsNmbr.AllianceNumber = @PROGRAMID     
END         
END

GO
  IF EXISTS (	SELECT *
			FROM sysobjects
			WHERE type = 'P'
			AND name = 'USP_EX_GetProgramhdr') 
	BEGIN
			PRINT 'CREATED PROCEDURE USP_EX_GetProgramhdr';
	END        
      
        
        