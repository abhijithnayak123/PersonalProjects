IF EXISTS (SELECT *
           FROM   sysobjects 
           WHERE  type = 'P'
                  AND name = 'USP_EX_SaveDonorbeneTaxCascade')
    BEGIN
        DROP PROCEDURE USP_EX_SaveDonorbeneTaxCascade;
        PRINT 'DROPPED USP_EX_SaveDonorbeneTaxCascade';
    END
GO      

  
  
/*********************************************************************************************************************                                           
* New Procedure Name  : USP_EX_SaveDonorbeneTaxCascade  
* Old Procedure Name  : USP_EIS_EX_DONORBENE_TAX_CASCADE_InsUpdProc  
* Description     : To Update records into Table,   
     Exec USP_EIS_EX_DONORBENE_TAX_CASCADE_InsUpdProc  
     @ENTITY_TYPE ='program',      
     @ENTITYID =300213,  
     @NEW_K1MAILINGRULEID =18,     
     @NEW_HIGHPRIORITY ='9/1/2007',      
     @USERID =69   
* Input           :   
* Modification Log:   
* 
EXEC USP_EX_SaveDonorbeneTaxCascade 'MANAGER','ACL',18,'02/21',100048
                             
* Date   Modified By  Description                                              
*--------------------------------------------------------------------------------------------------------------------                                           
* 08 Aug 2007 Saravanan PM  Created
* 11 Apr 2014 Yugandhar EXCREQ 6.1      
*********************************************************************************************************************/     
CREATE PROCEDURE USP_EX_SaveDonorbeneTaxCascade      
 @ENTITY_TYPE VARCHAR(100),          
 @ENTITYID CHAR(14),      
 @NEW_K1MAILINGRULEID INT=NULL,  -- K1_Priority      
 @NEW_HIGHPRIORITY VARCHAR(5)=NULL,  -- Mail on or Before        
 @USERID INT          
AS       
BEGIN         

 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#PROGRAM]'))        
 BEGIN        
  DROP TABLE [DBO].[#PROGRAM]        
 END      
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#PROGRAM_K1_EQUAL]'))        
 BEGIN        
  DROP TABLE [DBO].[#PROGRAM_K1_EQUAL]        
 END           
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#PROGRAM_HIGH_EQUAL]'))        
 BEGIN        
  DROP TABLE [DBO].[#PROGRAM_HIGH_EQUAL]        
 END            
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#ACCOUNT]'))        
 BEGIN        
  DROP TABLE [DBO].[#ACCOUNT]        
 END         
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#ACCOUNT_K1_EQUAL]'))        
 BEGIN        
  DROP TABLE [DBO].[#ACCOUNT_K1_EQUAL]        
 END            
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#ACCOUNT_HIGH_EQUAL]'))        
 BEGIN        
  DROP TABLE [DBO].[#ACCOUNT_HIGH_EQUAL]        
 END       
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#BENEFICIARY]'))        
 BEGIN        
  DROP TABLE [DBO].[#BENEFICIARY]        
 END        
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#BENEFICIARY_K1_EQUAL]'))        
 BEGIN        
  DROP TABLE [DBO].[#BENEFICIARY_K1_EQUAL]        
 END         
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#BENEFICIARY_HIGH_EQUAL]'))        
 BEGIN        
  DROP TABLE [DBO].[#BENEFICIARY_HIGH_EQUAL]        
 END       
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#TEMP_PROGRAM_K1_HIGH]'))        
 BEGIN        
  DROP TABLE [DBO].[#TEMP_PROGRAM_K1_HIGH]        
 END  
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#TEMP_ACCOUNT_K1_HIGH]'))        
 BEGIN        
  DROP TABLE [DBO].[#TEMP_ACCOUNT_K1_HIGH]        
 END  
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#TEMP_BENE_K1_HIGH]'))        
 BEGIN        
  DROP TABLE [DBO].[#TEMP_BENE_K1_HIGH]        
 END   
 CREATE TABLE  #PROGRAM (PROGRAMID CHAR(14))      
 CREATE TABLE  #PROGRAM_K1_EQUAL (PROGRAMID CHAR(14), K1MAILINGRULE BIT, HIGHPRIORITY VARCHAR(5))          
 CREATE TABLE  #PROGRAM_HIGH_EQUAL (PROGRAMID CHAR(14), K1MAILINGRULE BIT, HIGHPRIORITY VARCHAR(5))         
 CREATE TABLE  #ACCOUNT (ACCOUNTID CHAR(14))          
 CREATE TABLE  #ACCOUNT_K1_EQUAL (ACCOUNTID CHAR(14), K1MAILINGRULE BIT, HIGHPRIORITY VARCHAR(5))         
 CREATE TABLE  #ACCOUNT_HIGH_EQUAL (ACCOUNTID CHAR(14), K1MAILINGRULE BIT, HIGHPRIORITY VARCHAR(5))         
 CREATE TABLE  #BENEFICIARY (BENEFICIARYID CHAR(14))          
 CREATE TABLE  #BENEFICIARY_K1_EQUAL (BENEFICIARYID CHAR(14), K1MAILINGRULE BIT, HIGHPRIORITY VARCHAR(5))          
 CREATE TABLE  #BENEFICIARY_HIGH_EQUAL (BENEFICIARYID CHAR(14), K1MAILINGRULE BIT, HIGHPRIORITY VARCHAR(5))         
 CREATE TABLE  #TEMP_PROGRAM_K1_HIGH (PROGRAMID CHAR(14), HIGHPRIORITY VARCHAR(5), K1MAILINGRULE BIT)          
 CREATE TABLE  #TEMP_ACCOUNT_K1_HIGH (ACCOUNTID CHAR(14), HIGHPRIORITY VARCHAR(5), K1MAILINGRULE BIT)          
 CREATE TABLE  #TEMP_BENE_K1_HIGH (BENEFICIARYID CHAR(14), HIGHPRIORITY VARCHAR(5), K1MAILINGRULE BIT)          
       
 DECLARE @PRE_K1MAILINGRULE_VAL BIT,         
  @PRE_HIGHPRIORITY_VAL Varchar(5),        
  @K1_POLICYDIMENSION_ID INT,        
  @HIGH_POLICYDIMENSION_ID INT,        
  @PARTICIPANT_TYPE_ID INT,  
  @TEMP_K1MAILINGRULE INT  
       
         
 SET @K1_POLICYDIMENSION_ID = 197       
 SET @HIGH_POLICYDIMENSION_ID = 244         
         
 EXEC USP_EX_GetListItemID                        
  @LIST_TYPE_NAME = 'ENTITY',                    
  @LIST_ITEM_NAME = 'Contact',                      
  @LIST_ITEM_ID = @PARTICIPANT_TYPE_ID OUTPUT         
         
 DECLARE @NEW_K1MAILINGRULE INT      
 SET @NEW_K1MAILINGRULE=NULL      
       
 SELECT @NEW_K1MAILINGRULE=IVANVALUE   
 FROM VW_EX_ListItem   
 WHERE LISTTYPENAME = 'Logical Value'   
   AND LISTITEMID = @NEW_K1MAILINGRULEID      
   
 IF (@NEW_K1MAILINGRULE = 0 OR @NEW_K1MAILINGRULE IS NULL)      
  SET @NEW_HIGHPRIORITY=NULL  
  
 IF (@ENTITY_TYPE = 'MANAGER')        
 BEGIN        
 
  SELECT @PRE_K1MAILINGRULE_VAL =LOGICALVALUE         
  FROM TBL_POLICYITEM WHERE OWNERID=@ENTITYID AND POLICYDIMENSIONID=@K1_POLICYDIMENSION_ID AND POLICYLEVEL=100          
  
  SELECT @PRE_HIGHPRIORITY_VAL=TEXTVALUE          
  FROM TBL_PolicyItem WHERE OWNERID=@ENTITYID AND POLICYDIMENSIONID=@HIGH_POLICYDIMENSION_ID AND POLICYLEVEL=100          
  
  
  INSERT INTO #PROGRAM SELECT AllianceNumber FROM SYN_IT_AccountMaster WHERE ManagerCode=@ENTITYID        
  
   
  IF (ISNULL(@PRE_HIGHPRIORITY_VAL,'')<>ISNULL(@NEW_HIGHPRIORITY,''))      
  BEGIN      
  
   INSERT INTO #PROGRAM_HIGH_EQUAL (PROGRAMID,HIGHPRIORITY)   
   SELECT OWNERID,TEXTVALUE FROM TBL_POLICYITEM           
   WHERE POLICYLEVEL=200           
    AND POLICYDIMENSIONID=@HIGH_POLICYDIMENSION_ID          
    AND (OWNERID IN (SELECT PROGRAMID FROM #PROGRAM)       )  
    AND (ISNULL(TEXTVALUE,'')=ISNULL(@PRE_HIGHPRIORITY_VAL,'')   
    OR TEXTVALUE IS NULL ) -- This textvalue is null won't exists now thru excelsior earlier there were few records with junk data  
    
  END   
  
  IF ((@PRE_K1MAILINGRULE_VAL IS NULL AND @NEW_K1MAILINGRULE is not null)   
   OR (@PRE_K1MAILINGRULE_VAL IS not NULL AND @NEW_K1MAILINGRULE is null)   
   OR (@PRE_K1MAILINGRULE_VAL <> @NEW_K1MAILINGRULE))  
  BEGIN      
   
   
   INSERT INTO #PROGRAM_K1_EQUAL (PROGRAMID,K1MAILINGRULE)           
   SELECT OWNERID,LOGICALVALUE FROM TBL_PolicyItem           
   WHERE POLICYLEVEL=200           
    AND POLICYDIMENSIONID=@K1_POLICYDIMENSION_ID          
    AND OWNERID IN(SELECT PROGRAMID FROM #PROGRAM)      
    AND (LOGICALVALUE= @PRE_K1MAILINGRULE_VAL  OR      
      LOGICALVALUE IS NULL)  
  END          
  
  
  --------  
  INSERT INTO #TEMP_PROGRAM_K1_HIGH  
  select programid, highpriority, 1 as K1MAILINGRULE from #PROGRAM_HIGH_EQUAL    
  where programid in ( select programid from #program_k1_equal where K1MAILINGRULE =1)  
  ---------  
   
   
  INSERT INTO #ACCOUNT  
  SELECT ACCOUNTID FROM VW_EX_Account         
  WHERE AllianceNumber IN (SELECT PROGRAMID FROM #PROGRAM_HIGH_EQUAL)        
  
  IF EXISTS(SELECT ACCOUNTID FROM #ACCOUNT)  
  BEGIN  
  
   --DELETE FROM @ACCOUNT_EQUAL        
   INSERT INTO #ACCOUNT_HIGH_EQUAL (ACCOUNTID,HIGHPRIORITY)      
   SELECT OWNERID,TEXTVALUE FROM TBL_PolicyItem           
   WHERE POLICYLEVEL=300           
    AND POLICYDIMENSIONID=@HIGH_POLICYDIMENSION_ID          
    AND OWNERID IN (SELECT ACCOUNTID FROM #ACCOUNT)         
    AND (ISNULL(TEXTVALUE,'')=ISNULL(@PRE_HIGHPRIORITY_VAL,'')OR      
     TEXTVALUE IS NULL )  
  END  
  
  DELETE FROM #ACCOUNT        
  INSERT INTO #ACCOUNT         
  SELECT ACCOUNTID FROM VW_EX_Account         
  WHERE AllianceNumber IN (SELECT PROGRAMID FROM #PROGRAM_K1_EQUAL)        
  
  IF ((@PRE_K1MAILINGRULE_VAL IS NULL AND @NEW_K1MAILINGRULE is not null)   
   OR (@PRE_K1MAILINGRULE_VAL IS not NULL AND @NEW_K1MAILINGRULE is null)   
   OR (@PRE_K1MAILINGRULE_VAL<>@NEW_K1MAILINGRULE))  
  BEGIN  
   INSERT INTO #ACCOUNT_K1_EQUAL (ACCOUNTID,K1MAILINGRULE)              
   SELECT OWNERID,LOGICALVALUE FROM TBL_PolicyItem           
   WHERE POLICYLEVEL=300           
    AND POLICYDIMENSIONID=@K1_POLICYDIMENSION_ID          
    AND OWNERID IN (SELECT ACCOUNTID FROM #ACCOUNT)         
    AND (LOGICALVALUE= @PRE_K1MAILINGRULE_VAL  OR      
     LOGICALVALUE IS NULL)        
  END    
       
  --------  
  INSERT INTO #TEMP_ACCOUNT_K1_HIGH  
  select ACCOUNTID, highpriority, 1 as K1MAILINGRULE from #ACCOUNT_HIGH_EQUAL    
  where ACCOUNTID in ( select ACCOUNTID from #ACCOUNT_K1_EQUAL where K1MAILINGRULE =1)  
  ---------  
  
  IF NOT EXISTS (SELECT * FROM #ACCOUNT_K1_EQUAL )  
  BEGIN  
  
   DELETE FROM #ACCOUNT      
   INSERT INTO #ACCOUNT (ACCOUNTID)        
    SELECT ACCOUNTID FROM VW_EX_Account WHERE CLIENTID=@ENTITYID         
     
   INSERT INTO #BENEFICIARY_K1_EQUAL (BENEFICIARYID,K1MAILINGRULE)       
    SELECT BeneficiaryContactID , K_1_PRIORITY     
    FROM TBL_BR_ProfileTax PT         
    WHERE EntityDescription = @PARTICIPANT_TYPE_ID        
      AND (BeneficiaryContactID IN (SELECT BENEFICIARYID FROM VW_EX_TRUSTPARTICIPANTTYPE   
            WHERE CustomerAccountNumber IN (SELECT ACCOUNTID FROM #ACCOUNT))        
      AND ((K_1_PRIORITY IS null AND @PRE_K1MAILINGRULE_VAL IS NULL)   
        OR (K_1_PRIORITY =0  AND @PRE_K1MAILINGRULE_VAL = 0)  
        OR (K_1_PRIORITY =1  AND @PRE_K1MAILINGRULE_VAL = 1)))  
  END  
  ELSE  
  BEGIN  
  
  
   INSERT INTO #BENEFICIARY_K1_EQUAL (BENEFICIARYID,K1MAILINGRULE)       
   SELECT BeneficiaryContactID , K_1_PRIORITY       
   FROM TBL_BR_ProfileTax PT         
   WHERE EntityDescription = @PARTICIPANT_TYPE_ID        
    AND (BeneficiaryContactID IN (SELECT BENEFICIARYID FROM VW_EX_TRUSTPARTICIPANTTYPE   
          WHERE CustomerAccountNumber IN (SELECT ACCOUNTID FROM #ACCOUNT_K1_EQUAL))        
    AND ((K_1_PRIORITY IS null AND @PRE_K1MAILINGRULE_VAL IS NULL)   
     OR (K_1_PRIORITY =0  AND @PRE_K1MAILINGRULE_VAL = 0)  
     OR (K_1_PRIORITY =1  AND @PRE_K1MAILINGRULE_VAL = 1)))  
  END  
    
  --High Priority Policy Dimension        
       
  IF NOT EXISTS (SELECT * FROM #ACCOUNT_HIGH_EQUAL)  
  BEGIN  
   DELETE FROM #ACCOUNT      
   INSERT INTO #ACCOUNT (ACCOUNTID)        
   SELECT ACCOUNTID FROM VW_EX_Account WHERE CLIENTID=@ENTITYID         
  
   INSERT INTO #BENEFICIARY_HIGH_EQUAL (BENEFICIARYID,HIGHPRIORITY)  
   SELECT BeneficiaryContactID ,HIGH_PRIORITY      
   FROM TBL_BR_ProfileTax PT         
   WHERE EntityDescription = @PARTICIPANT_TYPE_ID        
    AND BeneficiaryContactID IN (SELECT BENEFICIARYID FROM VW_EX_TRUSTPARTICIPANTTYPE   
          WHERE CustomerAccountNumber IN (SELECT ACCOUNTID FROM #ACCOUNT))      
    AND (ISNULL(HIGH_PRIORITY,'')=ISNULL(@PRE_HIGHPRIORITY_VAL,''))     
  END  
  ELSE  
  BEGIN  
   INSERT INTO #BENEFICIARY_HIGH_EQUAL (BENEFICIARYID,HIGHPRIORITY)      
   SELECT BeneficiaryContactID, HIGH_PRIORITY        
   FROM TBL_BR_ProfileTax PT         
   WHERE EntityDescription = @PARTICIPANT_TYPE_ID        
    AND BeneficiaryContactID IN (SELECT BENEFICIARYID FROM VW_EX_TRUSTPARTICIPANTTYPE   
          WHERE CustomerAccountNumber IN (SELECT ACCOUNTID FROM #ACCOUNT_HIGH_EQUAL))      
    AND (ISNULL(HIGH_PRIORITY,'')=ISNULL(@PRE_HIGHPRIORITY_VAL,''))     
  END  
  --------  
  INSERT INTO #TEMP_BENE_K1_HIGH  
  select BENEFICIARYID, highpriority, 1 as K1MAILINGRULE from #BENEFICIARY_HIGH_EQUAL    
  where BENEFICIARYID in ( select BENEFICIARYID from #BENEFICIARY_K1_EQUAL where K1MAILINGRULE =1)  

  
  --create tax record for Beneficiary which do not have a tax record   
  INSERT INTO #BENEFICIARY (BENEFICIARYID)        
  SELECT BENEFICIARYID         
  FROM VW_EX_TRUSTPARTICIPANTTYPE        
  WHERE CLIENTID = @ENTITYID      
  
  DELETE FROM #ACCOUNT      
  INSERT INTO #ACCOUNT (ACCOUNTID)        
  SELECT ACCOUNTID FROM VW_EX_Account WHERE CLIENTID=@ENTITYID         
      
 END        
 ELSE IF (@ENTITY_TYPE = 'ALLIANCE')        
 BEGIN        
  SELECT @PRE_K1MAILINGRULE_VAL =LOGICALVALUE         
  FROM TBL_POLICYITEM WHERE OWNERID=@ENTITYID AND POLICYDIMENSIONID=@K1_POLICYDIMENSION_ID AND POLICYLEVEL=200          
  
  SELECT @PRE_HIGHPRIORITY_VAL=TEXTVALUE          
  FROM TBL_POLICYITEM WHERE OWNERID=@ENTITYID AND POLICYDIMENSIONID=@HIGH_POLICYDIMENSION_ID AND POLICYLEVEL=200         
  
  SET   @TEMP_K1MAILINGRULE = @NEW_K1MAILINGRULE  
    
  IF(@NEW_K1MAILINGRULE IS NULL)      
  BEGIN      
   SELECT @NEW_K1MAILINGRULE =LOGICALVALUE         
   FROM TBL_POLICYITEM       
   WHERE POLICYDIMENSIONID=@K1_POLICYDIMENSION_ID       
    AND POLICYLEVEL=100         
    AND OWNERID IN (SELECT ManagerCode FROM SYN_IT_AccountMaster WHERE AllianceNumber=@ENTITYID)      
  END      
  IF((@NEW_HIGHPRIORITY IS NULL) AND (@TEMP_K1MAILINGRULE IS NULL))      
  BEGIN      
   SELECT @NEW_HIGHPRIORITY=TEXTVALUE          
   FROM TBL_POLICYITEM       
   WHERE POLICYDIMENSIONID=@HIGH_POLICYDIMENSION_ID       
    AND POLICYLEVEL=100       
    AND OWNERID IN(SELECT ManagerCode FROM SYN_IT_AccountMaster WHERE AllianceNumber=@ENTITYID)        
  END      
           
  INSERT INTO #ACCOUNT         
  SELECT ACCOUNTID FROM VW_EX_Account         
  WHERE AllianceNumber = @ENTITYID        
     
  IF (ISNULL(@PRE_HIGHPRIORITY_VAL,'')<>ISNULL(@NEW_HIGHPRIORITY,''))       
  BEGIN      
   INSERT INTO #ACCOUNT_HIGH_EQUAL(ACCOUNTID,HIGHPRIORITY)               
   SELECT OWNERID,TEXTVALUE FROM TBL_POLICYITEM           
   WHERE POLICYLEVEL=300           
    AND POLICYDIMENSIONID=@HIGH_POLICYDIMENSION_ID          
    AND OWNERID IN (SELECT ACCOUNTID FROM #ACCOUNT)         
    AND (ISNULL(TEXTVALUE,'')=ISNULL(@PRE_HIGHPRIORITY_VAL,'')OR TEXTVALUE IS NULL)   
  END     
  
  IF ((@PRE_K1MAILINGRULE_VAL IS NULL AND @NEW_K1MAILINGRULE is not null)   
   OR (@PRE_K1MAILINGRULE_VAL IS not NULL AND @NEW_K1MAILINGRULE is null)   
   or (@PRE_K1MAILINGRULE_VAL<>@NEW_K1MAILINGRULE))  
  BEGIN      
   INSERT INTO #ACCOUNT_K1_EQUAL (ACCOUNTID,K1MAILINGRULE)             
   SELECT OWNERID,LOGICALVALUE FROM TBL_POLICYITEM           
   WHERE POLICYLEVEL=300           
    AND POLICYDIMENSIONID=@K1_POLICYDIMENSION_ID          
    AND OWNERID IN (SELECT ACCOUNTID FROM #ACCOUNT)         
    AND ( LOGICALVALUE= @PRE_K1MAILINGRULE_VAL  OR LOGICALVALUE IS NULL)      
  END      
     
  --------  
  INSERT INTO #TEMP_ACCOUNT_K1_HIGH  
  select ACCOUNTID, highpriority, 1 as K1MAILINGRULE from #ACCOUNT_HIGH_EQUAL    
  where ACCOUNTID in ( select ACCOUNTID from #ACCOUNT_K1_EQUAL where K1MAILINGRULE =1)  
  ---------  
     
  IF NOT EXISTS (SELECT * FROM #ACCOUNT_K1_EQUAL )  
  BEGIN  
   DELETE FROM #ACCOUNT      
   INSERT INTO #ACCOUNT (ACCOUNTID)        
   SELECT ACCOUNTID FROM VW_EX_Account WHERE AllianceNumber=@ENTITYID       
    
   INSERT INTO #BENEFICIARY_K1_EQUAL (BENEFICIARYID,K1MAILINGRULE)       
   SELECT BeneficiaryContactID ,K_1_PRIORITY       
   FROM TBL_BR_ProfileTax          
   WHERE EntityDescription = @PARTICIPANT_TYPE_ID        
    AND (BeneficiaryContactID IN (SELECT BENEFICIARYID FROM VW_EX_TRUSTPARTICIPANTTYPE   
          WHERE CustomerAccountNumber IN (SELECT ACCOUNTID FROM #ACCOUNT))        
    AND ((K_1_PRIORITY IS null AND @PRE_K1MAILINGRULE_VAL IS NULL)   
     OR (K_1_PRIORITY =0  AND @PRE_K1MAILINGRULE_VAL = 0)  
     OR (K_1_PRIORITY =1  AND @PRE_K1MAILINGRULE_VAL = 1)))  
  END  
  ELSE  
  BEGIN  
   INSERT INTO #BENEFICIARY_K1_EQUAL  (BENEFICIARYID,K1MAILINGRULE)    
   SELECT BeneficiaryContactID ,K_1_PRIORITY       
   FROM TBL_BR_ProfileTax          
   WHERE EntityDescription = @PARTICIPANT_TYPE_ID        
    AND (BeneficiaryContactID IN (SELECT BENEFICIARYID FROM VW_EX_TRUSTPARTICIPANTTYPE   
          WHERE CustomerAccountNumber IN  (SELECT ACCOUNTID FROM #ACCOUNT_K1_EQUAL))        
    AND ((K_1_PRIORITY IS null AND @PRE_K1MAILINGRULE_VAL IS NULL)   
     OR (K_1_PRIORITY =0  AND @PRE_K1MAILINGRULE_VAL = 0)  
     OR (K_1_PRIORITY =1  AND @PRE_K1MAILINGRULE_VAL = 1)))  
  END  
      
  --High Priority Policy Dimension        
       
  IF NOT EXISTS (SELECT * FROM #ACCOUNT_HIGH_EQUAL)  
  BEGIN  
   DELETE FROM #ACCOUNT      
   INSERT INTO #ACCOUNT (ACCOUNTID)        
    SELECT ACCOUNTID FROM VW_EX_Account WHERE AllianceNumber=@ENTITYID         
  
   INSERT INTO #BENEFICIARY_HIGH_EQUAL (BENEFICIARYID,HIGHPRIORITY)      
   SELECT BeneficiaryContactID ,HIGH_PRIORITY      
   FROM TBL_BR_ProfileTax          
   WHERE EntityDescription = @PARTICIPANT_TYPE_ID        
    AND BeneficiaryContactID IN (SELECT BENEFICIARYID FROM VW_EX_TRUSTPARTICIPANTTYPE   
          WHERE CustomerAccountNumber IN (SELECT ACCOUNTID FROM #ACCOUNT))      
    AND (ISNULL(HIGH_PRIORITY,'')=ISNULL(@PRE_HIGHPRIORITY_VAL,''))     
  END  
  ELSE  
  BEGIN  
   INSERT INTO #BENEFICIARY_HIGH_EQUAL (BENEFICIARYID,HIGHPRIORITY)        
   SELECT BeneficiaryContactID,HIGH_PRIORITY        
   FROM TBL_BR_ProfileTax          
   WHERE EntityDescription = @PARTICIPANT_TYPE_ID        
    AND BeneficiaryContactID IN (SELECT BENEFICIARYID FROM VW_EX_TRUSTPARTICIPANTTYPE   
          WHERE CustomerAccountNumber IN (SELECT ACCOUNTID FROM #ACCOUNT_HIGH_EQUAL))      
    AND (ISNULL(HIGH_PRIORITY,'')=ISNULL(@PRE_HIGHPRIORITY_VAL,''))     
  END  
    
  INSERT INTO #TEMP_BENE_K1_HIGH  
  select BENEFICIARYID, highpriority, 1 as K1MAILINGRULE from #BENEFICIARY_HIGH_EQUAL    
  where BENEFICIARYID in ( select BENEFICIARYID from #BENEFICIARY_K1_EQUAL where K1MAILINGRULE =1)  
   
  
  --create tax record for Beneficiary which do not have a tax record        
  INSERT INTO #BENEFICIARY (BENEFICIARYID)        
  SELECT BENEFICIARYID         
  FROM VW_EX_TRUSTPARTICIPANTTYPE        
  WHERE PROGRAMID = @ENTITYID     
 END        
 IF (@ENTITY_TYPE = 'ACCOUNT')        
 BEGIN       
  SELECT @PRE_K1MAILINGRULE_VAL =LOGICALVALUE         
  FROM TBL_POLICYITEM WHERE OWNERID=@ENTITYID AND POLICYDIMENSIONID=@K1_POLICYDIMENSION_ID AND POLICYLEVEL=300          
      
  SELECT @PRE_HIGHPRIORITY_VAL=TEXTVALUE          
  FROM TBL_POLICYITEM WHERE OWNERID=@ENTITYID AND POLICYDIMENSIONID=@HIGH_POLICYDIMENSION_ID AND POLICYLEVEL=300         
      
  SET @TEMP_K1MAILINGRULE = @NEW_K1MAILINGRULE  
    
  IF(@NEW_K1MAILINGRULE IS NULL)      
  BEGIN      
   SELECT @NEW_K1MAILINGRULE =LOGICALVALUE         
   FROM TBL_POLICYITEM       
   WHERE POLICYDIMENSIONID=@K1_POLICYDIMENSION_ID       
    AND POLICYLEVEL=200         
    AND OWNERID=(SELECT AllianceNumber FROM VW_EX_Account WHERE ACCOUNTID=@ENTITYID)      
  END      
  IF ((@NEW_HIGHPRIORITY IS NULL) AND (@TEMP_K1MAILINGRULE IS NULL) )  
  BEGIN      
   SELECT @NEW_HIGHPRIORITY=TEXTVALUE          
   FROM TBL_POLICYITEM       
   WHERE POLICYDIMENSIONID=@HIGH_POLICYDIMENSION_ID       
    AND POLICYLEVEL=200       
    AND OWNERID=(SELECT AllianceNumber FROM VW_EX_Account WHERE ACCOUNTID=@ENTITYID)      
  END      
  
      
  IF (ISNULL(@PRE_HIGHPRIORITY_VAL,'')<>ISNULL(@NEW_HIGHPRIORITY,''))   
  BEGIN      
  INSERT INTO #BENEFICIARY_HIGH_EQUAL (BENEFICIARYID,HIGHPRIORITY)       
   SELECT BeneficiaryContactID ,HIGH_PRIORITY      
   FROM TBL_BR_ProfileTax          
   WHERE EntityDescription = @PARTICIPANT_TYPE_ID        
    AND BeneficiaryContactID IN(SELECT BENEFICIARYID FROM VW_EX_TRUSTPARTICIPANTTYPE WHERE CustomerAccountNumber = @ENTITYID)        
    AND (ISNULL(HIGH_PRIORITY,'')=ISNULL(@PRE_HIGHPRIORITY_VAL,''))    
  END      
   
  INSERT INTO #BENEFICIARY_K1_EQUAL (BENEFICIARYID,K1MAILINGRULE)           
  SELECT BeneficiaryContactID,K_1_PRIORITY        
  FROM TBL_BR_ProfileTax          
  WHERE EntityDescription = @PARTICIPANT_TYPE_ID        
   AND BeneficiaryContactID IN(SELECT BENEFICIARYID FROM VW_EX_TRUSTPARTICIPANTTYPE WHERE CustomerAccountNumber = @ENTITYID )      
   AND ((K_1_PRIORITY IS null AND @PRE_K1MAILINGRULE_VAL IS NULL)   
     OR (K_1_PRIORITY =0  AND @PRE_K1MAILINGRULE_VAL = 0)  
     OR (K_1_PRIORITY =1  AND @PRE_K1MAILINGRULE_VAL = 1))  
  
  INSERT INTO #TEMP_BENE_K1_HIGH  
  select BENEFICIARYID, highpriority, 1 as K1MAILINGRULE from #BENEFICIARY_HIGH_EQUAL    
  where BENEFICIARYID in ( select BENEFICIARYID from #BENEFICIARY_K1_EQUAL where K1MAILINGRULE =1)  
      
  --create tax record for Beneficiary which do not have a tax record        
  INSERT INTO #BENEFICIARY (BENEFICIARYID)        
  
  SELECT		ConAccRol.ContactID as BENEFICIARYID
	FROM		SYN_IT_ContactAccountRoles ConAccRol
	INNER JOIN	SYN_IT_AccountMaster AccMstr ON  AccMstr.CustomerAccountNumber=ConAccRol.CustomerAccountNumber
	INNER JOIN	SYN_IT_ContactRoleCodes	ConRolCds ON ConAccRol.ContactRoleCode = ConRolCds.ID
	INNER JOIN	SYN_IT_AccountManagerCodes AccMgrCds ON AccMgrCds.ManagerCode=AccMstr.ManagerCode
	WHERE		ConRolCds.ID IN (10,21,37)
	and AccMstr.CustomerAccountNumber=@ENTITYID
      
 END      
    
 ---------------------------------------------Main Table Modification-----------------------------     
 DECLARE @POLICYITEM TABLE(        
  POLICYITEMID INT IDENTITY (1,1),         
  POLICYDIMENSIONID INT,         
  POLICYLEVEL INT,         
  OWNERID CHAR(14),         
  NUMERICVALUE FLOAT,         
  TEXTVALUE VARCHAR(100),         
  LOGICALVALUE BIT,         
  DATEVALUE DATETIME,         
  POLICYDROPDOWNID INT,         
  COMMENT VARCHAR(255))        
      
 IF (EXISTS (SELECT PROGRAMID FROM #PROGRAM) AND (@NEW_K1MAILINGRULE IS NOT NULL))      
 BEGIN 
  
     INSERT INTO @POLICYITEM (        
   POLICYDIMENSIONID,         
   POLICYLEVEL,         
   OWNERID,         
   NUMERICVALUE,         
   TEXTVALUE,         
   LOGICALVALUE,         
   DATEVALUE,         
   POLICYDROPDOWNID,         
   COMMENT )        
  SELECT         
   @K1_POLICYDIMENSION_ID,         
   200,         
   PROGRAMID,         
   0,         
   NULL,         
   @NEW_K1MAILINGRULE,         
   NULL,         
   0,         
   NULL        
  FROM       
   #PROGRAM   
   WHERE PROGRAMID IS NOT NULL   
      
  IF (@NEW_K1MAILINGRULE =1)      
  BEGIN 
            
   INSERT INTO @POLICYITEM (        
    POLICYDIMENSIONID,         
    POLICYLEVEL,         
    OWNERID,         
    NUMERICVALUE,         
    TEXTVALUE,         
    LOGICALVALUE,         
    DATEVALUE,         
    POLICYDROPDOWNID,         
    COMMENT )        
   SELECT         
    @HIGH_POLICYDIMENSION_ID,         
    200,         
    PROGRAMID,         
    0,         
    @NEW_HIGHPRIORITY,         
    0,      
    NULL,         
    0,         
    NULL        
   FROM       
    #PROGRAM
    WHERE PROGRAMID IS NOT NULL
      
  END        
 END      
    
 CREATE INDEX NDX_K1PROGRAM_ID on #PROGRAM_K1_EQUAL (PROGRAMID)      
   
 IF EXISTS (SELECT PROGRAMID FROM #PROGRAM_K1_EQUAL )        
 BEGIN      
          
  IF(@NEW_K1MAILINGRULE IS NOT NULL)      
  BEGIN      
   UPDATE TBL_PolicyItem        
   SET  MODIFIEDUSERID=@USERID,        
   MODIFIEDDATE=GETDATE()        
   WHERE   POLICYITEMID IN (SELECT POLICYITEMID FROM TBL_POLICYITEM         
     WHERE OWNERID IN (SELECT PROGRAMID FROM #PROGRAM_K1_EQUAL)       
       AND (LOGICALVALUE = 0 OR       
        OWNERID IN (SELECT PROGRAMID FROM #TEMP_PROGRAM_K1_HIGH where K1MAILINGRULE = @PRE_K1MAILINGRULE_VAL and ISNULL(HIGHPRIORITY,'') = ISNULL(@PRE_HIGHPRIORITY_VAL,'')))     
      AND POLICYLEVEL=200         
      AND POLICYDIMENSIONID=@K1_POLICYDIMENSION_ID )       
      
   UPDATE TBL_PolicyItem SET LOGICALVALUE=@NEW_K1MAILINGRULE         
   WHERE OWNERID IN (SELECT PROGRAMID FROM #PROGRAM_K1_EQUAL)       
    AND (LOGICALVALUE = 0 OR       
      OWNERID IN (SELECT PROGRAMID FROM #TEMP_PROGRAM_K1_HIGH where K1MAILINGRULE = @PRE_K1MAILINGRULE_VAL and ISNULL(HIGHPRIORITY,'') = ISNULL(@PRE_HIGHPRIORITY_VAL,'')))      
    AND POLICYLEVEL=200         
    AND POLICYDIMENSIONID=@K1_POLICYDIMENSION_ID       
  END      
  ELSE 
  BEGIN      
      
   UPDATE TBL_POLICYITEM        
   SET  DELETEDUSERID=@USERID,        
   MODIFIEDDATE=GETDATE()        
   WHERE   POLICYITEMID IN (SELECT POLICYITEMID FROM TBL_POLICYITEM         
     WHERE OWNERID IN (SELECT PROGRAMID FROM #PROGRAM_K1_EQUAL)       
      AND (LOGICALVALUE = 0 OR       
       OWNERID IN (SELECT PROGRAMID FROM #TEMP_PROGRAM_K1_HIGH where K1MAILINGRULE = @PRE_K1MAILINGRULE_VAL and ISNULL(HIGHPRIORITY,'') = ISNULL(@PRE_HIGHPRIORITY_VAL,'')))      
      AND POLICYLEVEL=200         
      AND POLICYDIMENSIONID=@K1_POLICYDIMENSION_ID        
     )      
      
         
   DELETE FROM TBL_POLICYITEM    
   WHERE   POLICYITEMID IN (SELECT POLICYITEMID FROM TBL_POLICYITEM         
     WHERE OWNERID IN (SELECT PROGRAMID FROM #PROGRAM_K1_EQUAL)       
      AND (LOGICALVALUE = 0 OR       
      OWNERID IN (SELECT PROGRAMID FROM #TEMP_PROGRAM_K1_HIGH where K1MAILINGRULE = @PRE_K1MAILINGRULE_VAL and ISNULL(HIGHPRIORITY,'') = ISNULL(@PRE_HIGHPRIORITY_VAL,'')) )     
       AND POLICYLEVEL=200         
      AND POLICYDIMENSIONID=@K1_POLICYDIMENSION_ID        
    )         
  
   DELETE FROM TBL_POLICYITEM       
   WHERE OWNERID IN (SELECT PROGRAMID FROM #PROGRAM_K1_EQUAL)         
    AND (LOGICALVALUE = 0 OR       
      OWNERID IN (SELECT PROGRAMID FROM #TEMP_PROGRAM_K1_HIGH where K1MAILINGRULE = @PRE_K1MAILINGRULE_VAL and ISNULL(HIGHPRIORITY,'') = ISNULL(@PRE_HIGHPRIORITY_VAL,'')))      
       AND POLICYLEVEL=200         
    AND POLICYDIMENSIONID=@K1_POLICYDIMENSION_ID        
  END       
 END      
      
 CREATE INDEX NDX_HIPROGRAM_ID on #PROGRAM_HIGH_EQUAL (PROGRAMID)      
      
 IF EXISTS (SELECT PROGRAMID FROM #PROGRAM_HIGH_EQUAL)        
 BEGIN      
      
  IF(@NEW_HIGHPRIORITY IS NOT NULL AND @NEW_K1MAILINGRULE = 1)      
  BEGIN      
   UPDATE TBL_POLICYITEM       
   SET  MODIFIEDUSERID=@USERID,        
   MODIFIEDDATE=GETDATE()        
   WHERE   POLICYITEMID IN (SELECT POLICYITEMID FROM TBL_POLICYITEM         
    WHERE OWNERID IN (SELECT PROGRAMID FROM #PROGRAM_HIGH_EQUAL)         
     AND POLICYLEVEL=200         
     AND POLICYDIMENSIONID=@HIGH_POLICYDIMENSION_ID        
    )         
   --------------------------------Audit Log ----------------------------------      
   UPDATE TBL_POLICYITEM SET TEXTVALUE=@NEW_HIGHPRIORITY         
   WHERE OWNERID IN(SELECT PROGRAMID FROM #PROGRAM_HIGH_EQUAL)         
    AND POLICYLEVEL=200         
    AND POLICYDIMENSIONID=@HIGH_POLICYDIMENSION_ID        
  END      
  ELSE      
  BEGIN      
      UPDATE TBL_POLICYITEM        
   SET  DELETEDUSERID=@USERID,        
    MODIFIEDDATE=GETDATE()        
   WHERE   POLICYITEMID IN (SELECT POLICYITEMID FROM TBL_POLICYITEM         
      --WHERE OWNERID IN (SELECT PROGRAMID FROM #TEMP_PROGRAM_K1_HIGH where K1MAILINGRULE = @PRE_K1MAILINGRULE_VAL and ISNULL(HIGHPRIORITY,'') = ISNULL(@PRE_HIGHPRIORITY_VAL,''))         
     WHERE OWNERID IN (SELECT PROGRAMID FROM #PROGRAM_HIGH_EQUAL)   
       AND POLICYLEVEL=200         
       AND POLICYDIMENSIONID=@HIGH_POLICYDIMENSION_ID        
     )         
   
   DELETE FROM TBL_POLICYITEM       
   WHERE   POLICYITEMID IN (SELECT POLICYITEMID FROM TBL_POLICYITEM         
      --WHERE OWNERID IN (SELECT PROGRAMID FROM #TEMP_PROGRAM_K1_HIGH where K1MAILINGRULE = @PRE_K1MAILINGRULE_VAL and ISNULL(HIGHPRIORITY,'') = ISNULL(@PRE_HIGHPRIORITY_VAL,''))         
     WHERE OWNERID IN (SELECT PROGRAMID FROM #PROGRAM_HIGH_EQUAL)   
       AND POLICYLEVEL=200         
       AND POLICYDIMENSIONID=@HIGH_POLICYDIMENSION_ID        
     )         
  
   DELETE FROM TBL_POLICYITEM       
   --WHERE OWNERID IN (SELECT PROGRAMID FROM #TEMP_PROGRAM_K1_HIGH where K1MAILINGRULE = @PRE_K1MAILINGRULE_VAL and ISNULL(HIGHPRIORITY,'') = ISNULL(@PRE_HIGHPRIORITY_VAL,''))         
    WHERE OWNERID IN (SELECT PROGRAMID FROM #PROGRAM_HIGH_EQUAL)   
    AND POLICYLEVEL=200         
    AND POLICYDIMENSIONID=@HIGH_POLICYDIMENSION_ID        
  END      
 END      
      
 CREATE INDEX NDX_ACCOUNTID on #ACCOUNT (ACCOUNTID)      
      
 IF (EXISTS (SELECT ACCOUNTID FROM #ACCOUNT) AND (@NEW_K1MAILINGRULE IS NOT NULL))      
 BEGIN     
	

   INSERT INTO @POLICYITEM (        
   POLICYDIMENSIONID,         
   POLICYLEVEL,         
   OWNERID,         
   NUMERICVALUE,         
   TEXTVALUE,         
   LOGICALVALUE,         
   DATEVALUE,         
   POLICYDROPDOWNID,         
   COMMENT )        
  SELECT         
   @K1_POLICYDIMENSION_ID,         
   300,         
   ACCOUNTID,         
   0,         
   NULL,         
   @NEW_K1MAILINGRULE,         
   NULL,         
   0,         
   NULL        
  FROM       
   #ACCOUNT     
   WHERE ACCOUNTID IS NOT NULL 
    
  IF (@NEW_K1MAILINGRULE =1)      
  BEGIN  
      
   INSERT INTO @POLICYITEM (        
    POLICYDIMENSIONID,         
    POLICYLEVEL,         
    OWNERID,         
    NUMERICVALUE,         
    TEXTVALUE,         
    LOGICALVALUE,         
    DATEVALUE,         
    POLICYDROPDOWNID,         
    COMMENT )        
   SELECT         
    @HIGH_POLICYDIMENSION_ID,         
    300,         
    ACCOUNTID,         
    0,         
    @NEW_HIGHPRIORITY,         
    0,         
    NULL,         
    0,         
    NULL        
   FROM       
    #ACCOUNT
    WHERE ACCOUNTID IS NOT NULL
       
  END      
 END      
      
 CREATE INDEX NDX_K1ACCOUNTID on #ACCOUNT_K1_EQUAL (ACCOUNTID)      
      
 IF EXISTS (SELECT ACCOUNTID FROM #ACCOUNT_K1_EQUAL )        
 BEGIN      
        
  IF(@NEW_K1MAILINGRULE IS NOT NULL)      
  BEGIN       
   UPDATE TBL_POLICYITEM        
   SET  MODIFIEDUSERID=@USERID,        
    MODIFIEDDATE=GETDATE()        
   WHERE   POLICYITEMID IN (SELECT POLICYITEMID FROM TBL_POLICYITEM         
      WHERE OWNERID IN (SELECT ACCOUNTID FROM #ACCOUNT_K1_EQUAL)         
       AND (LOGICALVALUE = 0 OR       
      OWNERID IN (SELECT ACCOUNTID FROM #TEMP_ACCOUNT_K1_HIGH where K1MAILINGRULE = @PRE_K1MAILINGRULE_VAL and ISNULL(HIGHPRIORITY,'') = ISNULL(@PRE_HIGHPRIORITY_VAL,'')))      
       AND POLICYLEVEL=300         
       AND POLICYDIMENSIONID=@K1_POLICYDIMENSION_ID        
     )         
      
   
   UPDATE TBL_POLICYITEM SET LOGICALVALUE=@NEW_K1MAILINGRULE         
   WHERE OWNERID IN(SELECT ACCOUNTID FROM #ACCOUNT_K1_EQUAL)         
    AND (LOGICALVALUE = 0 OR       
      OWNERID IN (SELECT ACCOUNTID FROM #TEMP_ACCOUNT_K1_HIGH where K1MAILINGRULE = @PRE_K1MAILINGRULE_VAL and ISNULL(HIGHPRIORITY,'') = ISNULL(@PRE_HIGHPRIORITY_VAL,'')))      
       AND POLICYLEVEL=300         
    AND POLICYDIMENSIONID=@K1_POLICYDIMENSION_ID       
  END      
  ELSE   ------------Delete KI Mailing Rule  ------------   
  BEGIN      
   UPDATE TBL_POLICYITEM        
   SET  DELETEDUSERID=@USERID,        
   MODIFIEDDATE=GETDATE()        
   WHERE   POLICYITEMID IN (SELECT POLICYITEMID FROM TBL_POLICYITEM         
     WHERE OWNERID IN (SELECT ACCOUNTID FROM #ACCOUNT_K1_EQUAL)         
      AND (LOGICALVALUE = 0 OR       
     OWNERID IN (SELECT ACCOUNTID FROM #TEMP_ACCOUNT_K1_HIGH where K1MAILINGRULE = @PRE_K1MAILINGRULE_VAL and ISNULL(HIGHPRIORITY,'') = ISNULL(@PRE_HIGHPRIORITY_VAL,'')))      
      AND POLICYLEVEL=300         
      AND POLICYDIMENSIONID=@K1_POLICYDIMENSION_ID        
    )         
      
      
   DELETE FROM TBL_POLICYITEM        
   WHERE   POLICYITEMID IN (SELECT POLICYITEMID FROM TBL_POLICYITEM         
     WHERE OWNERID IN (SELECT ACCOUNTID FROM #ACCOUNT_K1_EQUAL)         
      AND (LOGICALVALUE = 0 OR       
      OWNERID IN (SELECT ACCOUNTID FROM #TEMP_ACCOUNT_K1_HIGH where K1MAILINGRULE = @PRE_K1MAILINGRULE_VAL and ISNULL(HIGHPRIORITY,'') = ISNULL(@PRE_HIGHPRIORITY_VAL,'')))      
       AND POLICYLEVEL=300         
      AND POLICYDIMENSIONID=@K1_POLICYDIMENSION_ID  )      
  
   DELETE FROM TBL_POLICYITEM       
   WHERE OWNERID IN(SELECT ACCOUNTID FROM #ACCOUNT_K1_EQUAL)         
    AND (LOGICALVALUE = 0 OR       
      OWNERID IN (SELECT ACCOUNTID FROM #TEMP_ACCOUNT_K1_HIGH where K1MAILINGRULE = @PRE_K1MAILINGRULE_VAL and ISNULL(HIGHPRIORITY,'') = ISNULL(@PRE_HIGHPRIORITY_VAL,'')))      
       AND POLICYLEVEL=300         
    AND POLICYDIMENSIONID=@K1_POLICYDIMENSION_ID      
  END      
 END      
      
 CREATE INDEX NDX_HIACCOUNTID on #ACCOUNT_HIGH_EQUAL (ACCOUNTID)      
      
 IF EXISTS (SELECT ACCOUNTID FROM #ACCOUNT_HIGH_EQUAL)        
 BEGIN      
      
  IF(@NEW_HIGHPRIORITY IS NOT NULL AND @NEW_K1MAILINGRULE = 1)          
  BEGIN       
   UPDATE TBL_POLICYITEM        
   SET  MODIFIEDUSERID=@USERID,        
    MODIFIEDDATE=GETDATE()        
   WHERE   POLICYITEMID IN (SELECT POLICYITEMID FROM TBL_POLICYITEM         
      WHERE OWNERID IN (SELECT ACCOUNTID FROM #ACCOUNT_HIGH_EQUAL)         
       AND POLICYLEVEL=300         
       AND POLICYDIMENSIONID=@HIGH_POLICYDIMENSION_ID        
     )      
      
   
   UPDATE TBL_POLICYITEM SET TEXTVALUE=@NEW_HIGHPRIORITY         
   WHERE OWNERID IN(SELECT ACCOUNTID FROM #ACCOUNT_HIGH_EQUAL)         
    AND POLICYLEVEL=300         
    AND POLICYDIMENSIONID=@HIGH_POLICYDIMENSION_ID       
  END      
  ELSE      
  BEGIN      
         
   UPDATE TBL_POLICYITEM        
   SET  DELETEDUSERID=@USERID,        
    MODIFIEDDATE=GETDATE()        
   WHERE   POLICYITEMID IN (SELECT POLICYITEMID FROM TBL_POLICYITEM         
      WHERE OWNERID IN (SELECT ACCOUNTID FROM #ACCOUNT_HIGH_EQUAL)       
       AND POLICYLEVEL=300         
       AND POLICYDIMENSIONID=@HIGH_POLICYDIMENSION_ID        
     )      
      
   
   DELETE FROM TBL_POLICYITEM        
   WHERE   POLICYITEMID IN (SELECT POLICYITEMID FROM TBL_POLICYITEM         
     WHERE OWNERID IN (SELECT ACCOUNTID FROM #ACCOUNT_HIGH_EQUAL)       
      AND POLICYLEVEL=300         
      AND POLICYDIMENSIONID=@HIGH_POLICYDIMENSION_ID  )      
  
   DELETE FROM TBL_POLICYITEM       
   WHERE OWNERID IN (SELECT ACCOUNTID FROM #ACCOUNT_HIGH_EQUAL)       
    AND POLICYLEVEL=300         
    AND POLICYDIMENSIONID=@HIGH_POLICYDIMENSION_ID      
  END       
 END       
      
       
 CREATE INDEX NDX_K1BENEFICIARYID on #BENEFICIARY_K1_EQUAL (BENEFICIARYID)       
 CREATE INDEX NDX_HIBENEFICIARYID on #BENEFICIARY_HIGH_EQUAL (BENEFICIARYID)      
   
 IF EXISTS ((SELECT BENEFICIARYID FROM #BENEFICIARY_K1_EQUAL) UNION (SELECT BENEFICIARYID FROM #BENEFICIARY_HIGH_EQUAL))          
 BEGIN      
   
  
  --update Mailing Rule        
  UPDATE TBL_BR_ProfileTax          
  SET K_1_PRIORITY = @NEW_K1MAILINGRULE,          
   MODIFIED_USER_ID = @USERID,          
   MODIFIED_DATE = GETDATE()          
  WHERE           
  (BeneficiaryContactID IN (SELECT BENEFICIARYID FROM #BENEFICIARY_K1_EQUAL) AND (@PRE_K1MAILINGRULE_VAL IS NULL OR @PRE_K1MAILINGRULE_VAL = 0))  
   OR (@PRE_K1MAILINGRULE_VAL = 1 AND BeneficiaryContactID IN (SELECT BENEFICIARYID FROM #TEMP_BENE_K1_HIGH where K1MAILINGRULE = @PRE_K1MAILINGRULE_VAL and ISNULL(HIGHPRIORITY,'') = ISNULL(@PRE_HIGHPRIORITY_VAL,'')))  
  
  IF(@NEW_HIGHPRIORITY IS NOT NULL)  
  BEGIN  
   UPDATE TBL_BR_ProfileTax          
   SET HIGH_PRIORITY = @NEW_HIGHPRIORITY,          
    MODIFIED_USER_ID = @USERID,          
    MODIFIED_DATE = GETDATE()          
   WHERE           
    BeneficiaryContactID IN (SELECT BENEFICIARYID FROM #BENEFICIARY_HIGH_EQUAL) AND K_1_PRIORITY =1  
  END  
  ELSE IF(@NEW_HIGHPRIORITY IS NULL)  
  BEGIN  
   UPDATE TBL_BR_ProfileTax          
   SET HIGH_PRIORITY = @NEW_HIGHPRIORITY,          
    MODIFIED_USER_ID = @USERID,          
    MODIFIED_DATE = GETDATE()          
   WHERE           
    BeneficiaryContactID IN (SELECT BENEFICIARYID FROM #BENEFICIARY_HIGH_EQUAL) AND (K_1_PRIORITY IS NULL OR K_1_PRIORITY=0)  
  END  
    
 END      
   
 UPDATE @POLICYITEM   
 SET LogicalValue = P.LOGICALVALUE  
 FROM @POLICYITEM TMP   
  INNER JOIN TBL_POLICYITEM P ON TMP.POLICYLEVEL = P.POLICYLEVEL  
   AND TMP.OWNERID = P.OWNERID   
   AND TMP.POLICYDIMENSIONID = P.POLICYDIMENSIONID   
 WHERE TMP.POLICYDIMENSIONID = @K1_POLICYDIMENSION_ID   
   
      
 IF EXISTS (SELECT PolicyDimensionID FROM @POLICYITEM)        
 BEGIN      
  --Insert into PolicyItem Table        
  DECLARE @CNT INT        
  DECLARE @MAX_CNT INT        
  DECLARE @CUR_POLICYDIMENSIONID INT,      
   @CUR_POLICYLEVEL INT,      
   @CUR_OWNERID CHAR(14),      
   @CUR_POLICYITEM_ID INT    
  
  DECLARE @CUR_LOGICALVALUE BIT   
  
  
  SET @CNT = 1        
  SELECT  @MAX_CNT  = COUNT(POLICYITEMID) FROM @POLICYITEM        
  WHILE (@CNT <=  @MAX_CNT)        
  BEGIN        
   SELECT         
    @CUR_POLICYDIMENSIONID=POLICYDIMENSIONID,        
    @CUR_POLICYLEVEL=POLICYLEVEL,        
    @CUR_OWNERID=OWNERID,  
    @CUR_LOGICALVALUE = LOGICALVALUE  
   FROM @POLICYITEM WHERE POLICYITEMID=@CNT        
   
      
      
   IF ((NOT EXISTS(SELECT POLICYITEMID FROM TBL_POLICYITEM         
       WHERE POLICYLEVEL=@CUR_POLICYLEVEL         
        AND POLICYDIMENSIONID=@CUR_POLICYDIMENSIONID        
        AND OWNERID=@CUR_OWNERID))  
    AND (@CUR_POLICYDIMENSIONID = @K1_POLICYDIMENSION_ID OR  EXISTS(SELECT OwnerID FROM @POLICYITEM         
        WHERE POLICYLEVEL=@CUR_POLICYLEVEL  and OwnerID = @CUR_OWNERID       
      AND POLICYDIMENSIONID=@K1_POLICYDIMENSION_ID AND LogicalValue=1)) )        
   BEGIN     

    INSERT INTO TBL_POLICYITEM ( 
    --PolicyItemID,       
    PolicyDimensionID,        
    PolicyLevel,        
    OwnerID,        
    NumericValue,        
    TextValue,        
    LogicalValue,        
    DateValue,        
    PolicyDropDownID,        
    Comment,
    MODIFIEDDATE,        
    MODIFIEDUSERID,        
    CREATEDDATE,        
    CREATEDUSERID,        
    DELETEDUSERID
    )        
    SELECT
    --@CUR_POLICYITEM_ID,          
    PolicyDimensionID,        
    PolicyLevel,        
    OwnerID,        
    NumericValue,        
    TextValue,        
    LogicalValue,        
    DateValue,        
    PolicyDropDownID,        
    Comment,
     GETDATE(),        
    @USERID,        
    GETDATE(),        
    @USERID,         
    NULL        
    FROM @POLICYITEM WHERE POLICYITEMID=@CNT      
  
    SET @CUR_POLICYITEM_ID=IDENT_CURRENT('TBL_POLICYITEM')        
   END        
  SET @CNT  = @CNT +1        
  END        
      
 END      
         
      
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#PROGRAM]'))        
 BEGIN        
  DROP TABLE [DBO].[#PROGRAM]        
 END      
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#PROGRAM_K1_EQUAL]'))        
 BEGIN        
  DROP TABLE [DBO].[#PROGRAM_K1_EQUAL]        
 END           
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#PROGRAM_HIGH_EQUAL]'))        
 BEGIN        
  DROP TABLE [DBO].[#PROGRAM_HIGH_EQUAL]        
 END            
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#ACCOUNT]'))        
 BEGIN        
  DROP TABLE [DBO].[#ACCOUNT]        
 END         
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#ACCOUNT_K1_EQUAL]'))        
 BEGIN        
  DROP TABLE [DBO].[#ACCOUNT_K1_EQUAL]        
 END            
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#ACCOUNT_HIGH_EQUAL]'))        
 BEGIN        
  DROP TABLE [DBO].[#ACCOUNT_HIGH_EQUAL]        
 END       
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#BENEFICIARY]'))        
 BEGIN        
  DROP TABLE [DBO].[#BENEFICIARY]        
 END        
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#BENEFICIARY_K1_EQUAL]'))        
 BEGIN        
  DROP TABLE [DBO].[#BENEFICIARY_K1_EQUAL]        
 END         
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#BENEFICIARY_HIGH_EQUAL]'))        
 BEGIN        
  DROP TABLE [DBO].[#BENEFICIARY_HIGH_EQUAL]        
 END     
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#TEMP_PROGRAM_K1_HIGH]'))        
 BEGIN        
  DROP TABLE [DBO].[#TEMP_PROGRAM_K1_HIGH]        
 END  
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#TEMP_ACCOUNT_K1_HIGH]'))        
 BEGIN        
  DROP TABLE [DBO].[#TEMP_ACCOUNT_K1_HIGH]        
 END  
 IF EXISTS (SELECT * FROM TEMPDB.DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'TEMPDB.[DBO].[#TEMP_BENE_K1_HIGH]'))        
 BEGIN        
  DROP TABLE [DBO].[#TEMP_BENE_K1_HIGH]        
 END           
END       



 GO
  IF EXISTS (	SELECT *
			FROM sysobjects
			WHERE type = 'P'
			AND name = 'USP_EX_SaveDonorbeneTaxCascade') 
	BEGIN
			PRINT 'CREATED PROCEDURE USP_EX_SaveDonorbeneTaxCascade';
	END